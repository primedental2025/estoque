<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Estoque - Consultório Odontológico</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    // Custom colors from the provided palette
                    colors: {
                        'primary-dark': '#612436',
                        'secondary-dark': '#585856',
                        'light-neutral': '#BFBFBF',
                    }
                }
            }
        }
    </script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body class="font-sans bg-light-neutral min-h-screen flex items-center justify-center p-4">

    <div id="customModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
            <h3 id="modalTitle" class="text-xl font-semibold mb-4 text-secondary-dark"></h3>
            <p id="modalMessage" class="mb-6 text-gray-700"></p>
            <div id="modalActions" class="flex justify-center space-x-4">
                </div>
        </div>
    </div>

    <div id="loginContainer" class="bg-white p-8 rounded-xl shadow-lg w-full max-w-md hidden">
        <h2 class="text-3xl font-bold text-center text-primary-dark mb-6">Login - Controle de Estoque</h2>
        <form id="loginForm" class="space-y-4">
            <div>
                <label for="email" class="sr-only">E-mail</label>
                <input type="email" id="email" placeholder="E-mail" required
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary-dark focus:border-primary-dark transition duration-200">
            </div>
            <div>
                <label for="password" class="sr-only">Senha</label>
                <input type="password" id="password" placeholder="Senha" required
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary-dark focus:border-primary-dark transition duration-200">
            </div>
            <button type="submit"
                    class="w-full bg-primary-dark text-white py-2 px-4 rounded-lg hover:bg-opacity-90 focus:outline-none focus:ring-2 focus:ring-primary-dark focus:ring-opacity-50 transition duration-200 ease-in-out transform hover:scale-105">
                Entrar
            </button>
        </form>
    </div>

    <div id="mainContainer" class="container bg-white p-6 md:p-8 rounded-xl shadow-lg w-full max-w-6xl hidden">
        <h1 class="text-3xl md:text-4xl font-extrabold text-center text-primary-dark mb-6">Controle de Estoque Odontológico</h1>

        <div class="flex flex-wrap items-center justify-center gap-3 md:gap-4 p-4 bg-light-neutral rounded-lg mb-6 shadow-sm">
            <input type="text" id="searchInput" placeholder="Buscar material..."
                   class="flex-1 min-w-[150px] px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary-dark focus:border-primary-dark transition duration-200">
            <button id="btnBuscar"
                    class="flex-1 min-w-[100px] bg-secondary-dark text-white py-2 px-4 rounded-lg hover:bg-opacity-90 focus:outline-none focus:ring-2 focus:ring-secondary-dark focus:ring-opacity-50 transition duration-200 ease-in-out transform hover:scale-105">
                Buscar
            </button>
            <button id="btnCopiarLista"
                    class="flex-1 min-w-[150px] bg-secondary-dark text-white py-2 px-4 rounded-lg hover:bg-opacity-90 focus:outline-none focus:ring-2 focus:ring-secondary-dark focus:ring-opacity-50 transition duration-200 ease-in-out transform hover:scale-105">
                Copiar Lista de Compras
            </button>
            <button id="btnLimparMarcacoes"
                    class="flex-1 min-w-[150px] bg-secondary-dark text-white py-2 px-4 rounded-lg hover:bg-opacity-90 focus:outline-none focus:ring-2 focus:ring-secondary-dark focus:ring-opacity-50 transition duration-200 ease-in-out transform hover:scale-105">
                Limpar Marcações
            </button>

            <button id="btnAdvancedOptions"
                    class="flex-1 min-w-[150px] bg-primary-dark text-white py-2 px-4 rounded-lg hover:bg-opacity-90 focus:outline-none focus:ring-2 focus:ring-primary-dark focus:ring-opacity-50 transition duration-200 ease-in-out transform hover:scale-105">
                Avançado
            </button>
        </div>

        <div id="advancedOptionsContainer" class="flex flex-wrap items-center justify-center gap-3 md:gap-4 p-4 bg-light-neutral rounded-lg mb-6 shadow-sm hidden">
            <button id="btnAbrirModal"
                    class="flex-1 min-w-[150px] bg-primary-dark text-white py-2 px-4 rounded-lg hover:bg-opacity-90 focus:outline-none focus:ring-2 focus:ring-primary-dark focus:ring-opacity-50 transition duration-200 ease-in-out transform hover:scale-105">
                Adicionar Novo Item
            </button>
            <button id="btnGerarRelatorio"
                    class="flex-1 min-w-[150px] bg-secondary-dark text-white py-2 px-4 rounded-lg hover:bg-opacity-90 focus:outline-none focus:ring-2 focus:ring-secondary-dark focus:ring-opacity-50 transition duration-200 ease-in-out transform hover:scale-105">
                Gerar Relatório
            </button>
            <button id="btnLogout"
                    class="flex-1 min-w-[100px] bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50 transition duration-200 ease-in-out transform hover:scale-105">
                Sair
            </button>
        </div>

        <div id="cadastroModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-40 hidden">
            <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md mx-4">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-2xl font-semibold text-primary-dark">Cadastrar Novo Material</h3>
                    <button class="text-gray-500 hover:text-gray-700 text-2xl" id="btnFecharModal">
                        &times;
                    </button>
                </div>
                <form id="materialForm" class="space-y-4">
                    <input type="text" id="nome" placeholder="Nome do material" required
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary-dark focus:border-primary-dark">
                    <input type="number" id="quantidade" placeholder="Quantidade inicial" min="0" required
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary-dark focus:border-primary-dark">
                    <input type="number" id="quantidadeMinima" placeholder="Quantidade mínima" min="0" required
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary-dark focus:border-primary-dark">
                    <select id="categoria" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary-dark focus:border-primary-dark">
                        <option value="">Selecione uma categoria</option>
                        <option value="biosseguranca">Biossegurança</option>
                        <option value="brocas">Brocas</option>
                        <option value="cirurgia">Cirurgia</option>
                        <option value="clinica_geral">Clínica Geral</option>
                        <option value="dentistica">Dentística</option>
                        <option value="endodontia">Endodontia</option>
                        <option value="instrumental">Instrumental</option>
                        <option value="material_limpeza">Material de Limpeza</option>
                        <option value="ortodontia">Ortodontia</option>
                        <option value="protese">Prótese</option>
                        <option value="implantodontia">Implantodontia</option>
                    </select>
                    <input type="file" id="imagem" accept="image/*"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-primary-dark hover:file:bg-blue-100">
                    <button type="submit"
                            class="w-full bg-primary-dark text-white py-2 px-4 rounded-lg hover:bg-opacity-90 focus:outline-none focus:ring-2 focus:ring-primary-dark focus:ring-opacity-50 transition duration-200 ease-in-out transform hover:scale-105">
                        Cadastrar
                    </button>
                </form>
            </div>
        </div>

        <div id="editarModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-40 hidden">
            <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md mx-4">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-2xl font-semibold text-primary-dark">Editar Material</h3>
                    <button class="text-gray-500 hover:text-gray-700 text-2xl" id="btnFecharModalEditar">
                        &times;
                    </button>
                </div>
                <form id="editarForm" class="space-y-4">
                    <input type="text" id="editNome" placeholder="Nome do material" required
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary-dark focus:border-primary-dark">
                    <input type="hidden" id="originalNome"> <select id="editCategoria"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary-dark focus:border-primary-dark">
                        <option value="">Selecione uma categoria</option>
                        <option value="biosseguranca">Biossegurança</option>
                        <option value="brocas">Brocas</option>
                        <option value="cirurgia">Cirurgia</option>
                        <option value="clinica_geral">Clínica Geral</option>
                        <option value="dentistica">Dentística</option>
                        <option value="endodontia">Endodontia</option>
                        <option value="instrumental">Instrumental</option>
                        <option value="material_limpeza">Material de Limpeza</option>
                        <option value="ortodontia">Ortodontia</option>
                        <option value="protese">Prótese</option>
                        <option value="implantodontia">Implantodontia</option>
                    </select>
                    <input type="number" id="editQuantidadeMinima" placeholder="Quantidade mínima" min="0"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary-dark focus:border-primary-dark">
                    <input type="file" id="editImagem" accept="image/*"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-primary-dark hover:file:bg-blue-100">
                    <button type="submit"
                            class="w-full bg-primary-dark text-white py-2 px-4 rounded-lg hover:bg-opacity-90 focus:outline-none focus:ring-2 focus:ring-primary-dark focus:ring-opacity-50 transition duration-200 ease-in-out transform hover:scale-105">
                        Salvar Alterações
                    </button>
                </form>
            </div>
        </div>

        <div id="materialList" class="space-y-4"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Check if Firebase SDK is loaded
            if (typeof firebase === 'undefined') {
                showCustomModal('Erro', 'Firebase SDK não foi carregado. Verifique sua conexão ou tente novamente.', 'alert');
                return;
            }

            // Firebase configuration (replace with your actual config from __firebase_config if available)
            const firebaseConfig = {
                apiKey: "AIzaSyCDxJW_o6y-hmisQHOHVYPVJ8cag6hrKv0",
                authDomain: "estoque-prime.firebaseapp.com",
                projectId: "estoque-prime",
                storageBucket: "estoque-prime.firebasestorage.app",
                messagingSenderId: "1092019247496",
                appId: "1:1092019247496:web:92076afda68ccbc23d823d",
                measurementId: "G-04D19CYTTQ"
            };

            // Initialize Firebase
            const app = firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();
            const auth = firebase.auth();

            // Category mapping for display purposes
            const categorias = {
                biosseguranca: "Biossegurança",
                brocas: "Brocas",
                cirurgia: "Cirurgia",
                clinica_geral: "Clínica Geral",
                dentistica: "Dentística",
                endodontia: "Endodontia",
                instrumental: "Instrumental",
                material_limpeza: "Material de Limpeza",
                ortodontia: "Ortodontia",
                protese: "Prótese",
                implantodontia: "Implantodontia"
            };

            let materiaisFiltrados = [];
            let termoDeBusca = "";

            /**
             * Displays a custom modal for alerts or confirmations.
             * @param {string} title - The title of the modal.
             * @param {string} message - The message content of the modal.
             * @param {'alert'|'confirm'} type - The type of modal ('alert' for OK button, 'confirm' for Yes/No buttons).
             * @returns {Promise<boolean>} - Resolves to true if 'Yes' is clicked for confirm, false otherwise.
             */
            function showCustomModal(title, message, type) {
                return new Promise((resolve) => {
                    const modal = document.getElementById('customModal');
                    const modalTitle = document.getElementById('modalTitle');
                    const modalMessage = document.getElementById('modalMessage');
                    const modalActions = document.getElementById('modalActions');

                    modalTitle.textContent = title;
                    modalMessage.textContent = message;
                    modalActions.innerHTML = ''; // Clear previous buttons

                    if (type === 'alert') {
                        const okButton = document.createElement('button');
                        okButton.textContent = 'OK';
                        okButton.className = 'bg-primary-dark text-white py-2 px-4 rounded-lg hover:bg-opacity-90 transition duration-200 ease-in-out transform hover:scale-105';
                        okButton.onclick = () => {
                            modal.classList.add('hidden');
                            resolve(true); // Always resolve true for alert
                        };
                        modalActions.appendChild(okButton);
                    } else if (type === 'confirm') {
                        const yesButton = document.createElement('button');
                        yesButton.textContent = 'Sim';
                        yesButton.className = 'bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition duration-200 ease-in-out transform hover:scale-105';
                        yesButton.onclick = () => {
                            modal.classList.add('hidden');
                            resolve(true);
                        };
                        modalActions.appendChild(yesButton);

                        const noButton = document.createElement('button');
                        noButton.textContent = 'Não';
                        noButton.className = 'bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 transition duration-200 ease-in-out transform hover:scale-105';
                        noButton.onclick = () => {
                            modal.classList.add('hidden');
                            resolve(false);
                        };
                        modalActions.appendChild(noButton);
                    }

                    modal.classList.remove('hidden');
                });
            }

            /**
             * Converts a File object to a Data URL (base64 string).
             * @param {File} file - The file to convert.
             * @returns {Promise<string>} - A promise that resolves with the Data URL.
             */
            function converterParaDataURL(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = error => reject(error);
                    reader.readAsDataURL(file);
                });
            }

            /**
             * Loads materials from Firestore, filters them if a search term is present,
             * and then updates the displayed list.
             */
            async function carregarMateriais() {
                try {
                    const snapshot = await db.collection('materiais').get();
                    materiaisFiltrados = [];
                    snapshot.forEach(doc => materiaisFiltrados.push(doc.data()));

                    if (termoDeBusca !== "") {
                        materiaisFiltrados = materiaisFiltrados.filter(m =>
                            m.nome.toLowerCase().includes(termoDeBusca)
                        );
                    }

                    atualizarLista(materiaisFiltrados);
                } catch (error) {
                    console.error("Erro ao carregar materiais:", error);
                    showCustomModal("Erro", "Erro ao carregar materiais: " + error.message, 'alert');
                }
            }

            /**
             * Saves a material object to Firestore.
             * @param {object} material - The material object to save.
             */
            async function salvarMaterial(material) {
                try {
                    await db.collection('materiais').doc(material.nome).set(material);
                    console.log('Material salvo com sucesso:', material);
                } catch (error) {
                    console.error('Erro ao salvar material:', error);
                    showCustomModal("Erro", 'Erro ao salvar material: ' + error.message, 'alert');
                }
            }

            /**
             * Updates the material list display based on the provided materials array.
             * Groups materials by category and allows collapsing/expanding categories.
             * @param {Array<object>} materiais - An array of material objects to display.
             */
            function atualizarLista(materiais) {
                const lista = document.getElementById('materialList');
                lista.innerHTML = '';
                const materiaisPorCategoria = {};

                // Group materials by category
                materiais.forEach(material => {
                    if (!materiaisPorCategoria[material.categoria]) {
                        materiaisPorCategoria[material.categoria] = [];
                    }
                    materiaisPorCategoria[material.categoria].push(material);
                });

                // Load collapsed state from localStorage
                const categoriasRecolhidas = JSON.parse(localStorage.getItem('categoriasRecolhidas')) || {};

                Object.keys(materiaisPorCategoria).sort().forEach(categoria => {
                    const section = document.createElement('div');
                    section.className = 'category-section mb-4';

                    const title = document.createElement('h3');
                    title.className = 'category-title bg-primary-dark text-white p-3 rounded-lg text-lg font-semibold cursor-pointer relative transition duration-300 ease-in-out hover:bg-opacity-90 flex justify-between items-center';
                    title.textContent = categorias[categoria] || categoria;

                    // Check if the category was collapsed
                    const estaRecolhida = categoriasRecolhidas[categoria] === true;
                    if (estaRecolhida) {
                        title.classList.add('collapsed');
                    }

                    // Add expand/collapse icon
                    const icon = document.createElement('span');
                    icon.className = 'ml-2 text-xl transform transition-transform duration-300';
                    icon.textContent = estaRecolhida ? '▶' : '▼';
                    title.appendChild(icon);

                    title.addEventListener('click', () => {
                        const items = section.querySelector('.category-items');
                        items.classList.toggle('hidden'); // Use hidden class for display toggle
                        title.classList.toggle('collapsed');
                        icon.textContent = title.classList.contains('collapsed') ? '▶' : '▼';

                        // Update state in localStorage
                        categoriasRecolhidas[categoria] = title.classList.contains('collapsed');
                        localStorage.setItem('categoriasRecolhidas', JSON.stringify(categoriasRecolhidas));
                    });

                    section.appendChild(title);

                    const itemsContainer = document.createElement('div');
                    itemsContainer.className = 'category-items space-y-3 mt-3';
                    if (estaRecolhida) {
                        itemsContainer.classList.add('hidden'); // Hide items if collapsed
                    }

                    materiaisPorCategoria[categoria].sort((a, b) => a.nome.localeCompare(b.nome)).forEach(material => {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = `material-item flex flex-col md:flex-row items-start md:items-center p-4 border border-gray-200 rounded-lg bg-white shadow-sm transition duration-200 ease-in-out hover:bg-gray-50 ${material.quantidade < material.quantidadeMinima ? 'bg-red-50 border-red-200' : ''}`;

                        if (material.imagem) {
                            const img = document.createElement('img');
                            img.src = material.imagem;
                            img.alt = `Imagem de ${material.nome}`;
                            img.className = 'w-full md:w-48 h-auto rounded-md mr-0 md:mr-4 mb-4 md:mb-0 object-cover';
                            img.onerror = () => {
                                console.error('Erro ao carregar imagem:', material.imagem);
                                img.style.display = 'none'; // Hide broken image
                            };
                            itemDiv.appendChild(img);
                        }

                        const info = document.createElement('div');
                        info.className = 'material-info flex-grow mr-0 md:mr-4 mb-4 md:mb-0';
                        info.innerHTML = `
                            <strong class="text-xl font-semibold text-secondary-dark">${material.nome}</strong>
                            <span class="text-lg text-gray-700 ml-2">Quantidade: ${material.quantidade}</span><br>
                            <span class="text-sm text-gray-500 mt-1 block">Mínimo: ${material.quantidadeMinima} | Última modificação: ${material.ultimaModificacao || 'N/A'}</span>
                        `;
                        itemDiv.appendChild(info);

                        const controls = document.createElement('div');
                        controls.className = 'controls flex flex-col md:flex-row items-start md:items-center gap-3 w-full md:w-auto';

                        // Quantity controls: input field with increment/decrement buttons
                        const quantityControlDiv = document.createElement('div');
                        quantityControlDiv.className = 'flex items-center gap-1';
                        const btnRemove = document.createElement('button');
                        btnRemove.textContent = '-';
                        btnRemove.className = 'bg-primary-dark text-white p-2 rounded-lg text-lg font-bold hover:bg-opacity-90 transition duration-200 transform hover:scale-105 w-8 h-8 flex items-center justify-center';
                        btnRemove.onclick = () => alterarQuantidade(material.nome, -1);
                        quantityControlDiv.appendChild(btnRemove);

                        const quantityInput = document.createElement('input');
                        quantityInput.type = 'number';
                        quantityInput.value = material.quantidade;
                        quantityInput.min = '0';
                        quantityInput.className = 'w-16 text-center border border-gray-300 rounded-lg py-1 px-2 text-lg focus:ring-primary-dark focus:border-primary-dark';
                        quantityInput.onchange = (e) => alterarQuantidadeDireta(material.nome, parseInt(e.target.value));
                        quantityControlDiv.appendChild(quantityInput);

                        const btnAdd = document.createElement('button');
                        btnAdd.textContent = '+';
                        btnAdd.className = 'bg-primary-dark text-white p-2 rounded-lg text-lg font-bold hover:bg-opacity-90 transition duration-200 transform hover:scale-105 w-8 h-8 flex items-center justify-center';
                        btnAdd.onclick = () => alterarQuantidade(material.nome, 1);
                        quantityControlDiv.appendChild(btnAdd);
                        controls.appendChild(quantityControlDiv);

                        // Options dropdown for Edit/Delete
                        const optionsDropdownDiv = document.createElement('div');
                        optionsDropdownDiv.className = 'relative inline-block text-left';

                        const btnOptions = document.createElement('button');
                        btnOptions.textContent = 'Opções';
                        btnOptions.className = 'bg-secondary-dark text-white py-2 px-3 rounded-lg text-sm hover:bg-opacity-90 transition duration-200 transform hover:scale-105';
                        btnOptions.onclick = (e) => {
                            e.stopPropagation(); // Prevent closing immediately if clicking on button
                            const dropdownContent = optionsDropdownDiv.querySelector('.dropdown-content');
                            dropdownContent.classList.toggle('hidden');
                        };
                        optionsDropdownDiv.appendChild(btnOptions);

                        const dropdownContent = document.createElement('div');
                        dropdownContent.className = 'dropdown-content absolute right-0 mt-2 w-40 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 hidden z-10';
                        dropdownContent.onclick = (e) => e.stopPropagation(); // Prevent closing when clicking inside dropdown

                        const btnEdit = document.createElement('button');
                        btnEdit.textContent = 'Editar';
                        btnEdit.className = 'block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-secondary-dark rounded-t-md';
                        btnEdit.onclick = () => {
                            abrirModalEditar(material.nome);
                            dropdownContent.classList.add('hidden'); // Hide dropdown after click
                        };
                        dropdownContent.appendChild(btnEdit);

                        const btnDelete = document.createElement('button');
                        btnDelete.textContent = 'Excluir';
                        btnDelete.className = 'block w-full text-left px-4 py-2 text-sm text-red-700 hover:bg-red-100 hover:text-red-800 rounded-b-md';
                        btnDelete.onclick = () => {
                            confirmarExclusao(material.nome);
                            dropdownContent.classList.add('hidden'); // Hide dropdown after click
                        };
                        dropdownContent.appendChild(btnDelete);

                        optionsDropdownDiv.appendChild(dropdownContent);
                        controls.appendChild(optionsDropdownDiv);

                        // Comprar button remains prominent
                        const btnComprar = document.createElement('button');
                        btnComprar.textContent = 'Comprar';
                        btnComprar.className = `comprar-btn py-2 px-4 rounded-lg font-semibold transition duration-200 transform hover:scale-105 ${material.comprar ? 'bg-primary-dark text-white hover:bg-opacity-90' : 'bg-light-neutral text-secondary-dark hover:bg-opacity-90'}`;
                        btnComprar.onclick = () => toggleComprar(material.nome);
                        controls.appendChild(btnComprar);

                        itemDiv.appendChild(controls);
                        itemsContainer.appendChild(itemDiv);
                    });

                    section.appendChild(itemsContainer);
                    lista.appendChild(section);
                });
            }

            /**
             * Opens the add new material modal.
             */
            function abrirModal() {
                document.getElementById('cadastroModal').classList.remove('hidden');
            }

            /**
             * Closes the add new material modal and resets the form.
             */
            function fecharModal() {
                document.getElementById('cadastroModal').classList.add('hidden');
                document.getElementById('materialForm').reset();
            }

            /**
             * Opens the edit material modal and populates it with existing material data.
             * @param {string} nome - The name of the material to edit.
             */
            function abrirModalEditar(nome) {
                const material = materiaisFiltrados.find(m => m.nome === nome);
                if (material) {
                    document.getElementById('editNome').value = material.nome;
                    document.getElementById('originalNome').value = material.nome; // Store original name
                    document.getElementById('editCategoria').value = material.categoria;
                    document.getElementById('editQuantidadeMinima').value = material.quantidadeMinima;
                    document.getElementById('editarModal').classList.remove('hidden');
                } else {
                    showCustomModal("Erro", "Material não encontrado para edição.", 'alert');
                }
            }

            /**
             * Closes the edit material modal and resets the form.
             */
            function fecharModalEditar() {
                document.getElementById('editarModal').classList.add('hidden');
                document.getElementById('editarForm').reset();
            }

            // Event listener for editing material form submission
            document.getElementById('editarForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                const originalNome = document.getElementById('originalNome').value;
                const newNome = document.getElementById('editNome').value.trim();
                const novaCategoria = document.getElementById('editCategoria').value;
                const novaQuantidadeMinima = parseInt(document.getElementById('editQuantidadeMinima').value);
                const arquivo = document.getElementById('editImagem').files[0];

                try {
                    let materialToUpdate = materiaisFiltrados.find(m => m.nome === originalNome);
                    if (!materialToUpdate) {
                        showCustomModal("Erro", "Material original não encontrado.", 'alert');
                        return;
                    }

                    let updateData = {
                        categoria: novaCategoria,
                        quantidadeMinima: novaQuantidadeMinima,
                        ultimaModificacao: new Date().toLocaleString('pt-BR')
                    };

                    if (arquivo) {
                        const dataURL = await converterParaDataURL(arquivo);
                        const tamanhoBytes = (dataURL.length * 3) / 4 - 2; // Approximate size in bytes
                        if (tamanhoBytes > 500000) { // 500 KB limit
                            showCustomModal('Aviso', 'A imagem é muito grande! Use uma imagem menor (menos de 500 KB).', 'alert');
                            return;
                        }
                        updateData.imagem = dataURL;
                    }

                    if (newNome !== originalNome) {
                        // Check if new name already exists
                        const existingDoc = await db.collection('materiais').doc(newNome).get();
                        if (existingDoc.exists) {
                            showCustomModal("Erro", `Já existe um material com o nome "${newNome}". Por favor, escolha outro nome.`, 'alert');
                            return;
                        }

                        // Create new document with new name
                        const newMaterialData = { ...materialToUpdate, ...updateData, nome: newNome };
                        await db.collection('materiais').doc(newNome).set(newMaterialData);

                        // Delete old document
                        await db.collection('materiais').doc(originalNome).delete();
                        console.log(`Material "${originalNome}" renomeado para "${newNome}" com sucesso!`);
                    } else {
                        // Update existing document if name hasn't changed
                        await db.collection('materiais').doc(originalNome).update(updateData);
                        console.log("Material atualizado com sucesso!");
                    }

                    fecharModalEditar();
                    carregarMateriais();
                } catch (error) {
                    console.error("Erro ao atualizar material:", error);
                    showCustomModal("Erro", "Erro ao atualizar material: " + error.message, 'alert');
                }
            });

            /**
             * Clears all 'comprar' (to buy) markings on materials.
             */
            async function limparMarcacoes() {
                const confirmed = await showCustomModal("Confirmar", "Tem certeza de que deseja limpar todas as marcações de compra?", 'confirm');
                if (confirmed) {
                    try {
                        const snapshot = await db.collection('materiais').get();
                        const batch = db.batch();
                        snapshot.forEach(doc => batch.update(doc.ref, { comprar: false }));
                        await batch.commit();
                        console.log("Marcações de compra limpas com sucesso!");
                        carregarMateriais();
                    } catch (error) {
                        console.error("Erro ao limpar marcações:", error);
                        showCustomModal("Erro", "Erro ao limpar marcações: " + error.message, 'alert');
                    }
                }
            }

            /**
             * Copies the list of materials marked for purchase to the clipboard.
             */
            async function copiarListaCompras() {
                try {
                    const snapshot = await db.collection('materiais').where("comprar", "==", true).get();
                    if (snapshot.empty) {
                        showCustomModal("Aviso", "Nenhum item marcado para compra.", 'alert');
                        return;
                    }
                    let itensPorCategoria = {};
                    snapshot.forEach(doc => {
                        let material = doc.data();
                        let categoria = categorias[material.categoria] || "Outros"; // Use mapped category name
                        if (!itensPorCategoria[categoria]) itensPorCategoria[categoria] = [];
                        itensPorCategoria[categoria].push(material.nome + " (Qtd: " + material.quantidade + ")");
                    });

                    let listaTexto = Object.keys(itensPorCategoria).sort().map(categoria => {
                        let itensOrdenados = itensPorCategoria[categoria].sort();
                        return `🔹 ${categoria.toUpperCase()}\n- ${itensOrdenados.join("\n- ")}`;
                    }).join("\n\n");

                    // Use document.execCommand('copy') for better compatibility in iframes
                    const tempTextArea = document.createElement('textarea');
                    tempTextArea.value = listaTexto;
                    document.body.appendChild(tempTextArea);
                    tempTextArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(tempTextArea);

                    showCustomModal("Sucesso", "Lista de compras copiada com sucesso!", 'alert');
                    console.log("Lista de compras copiada:", listaTexto);
                } catch (error) {
                    console.error("Erro ao copiar a lista:", error);
                    showCustomModal("Erro", "Erro ao copiar a lista: " + error.message, 'alert');
                }
            }

            /**
             * Initiates a search for materials based on the input field.
             */
            async function buscarMateriais() {
                termoDeBusca = document.getElementById('searchInput').value.toLowerCase().trim();
                carregarMateriais();
            }

            /**
             * Generates an Excel report of all materials.
             */
            async function gerarRelatorio() {
                try {
                    const snapshot = await db.collection('materiais').get();
                    if (snapshot.empty) {
                        showCustomModal("Aviso", "Nenhum material encontrado para gerar o relatório.", 'alert');
                        return;
                    }

                    const dados = [];
                    snapshot.forEach(doc => {
                        const material = doc.data();
                        dados.push({
                            Nome: material.nome,
                            Categoria: categorias[material.categoria] || material.categoria,
                            Quantidade: material.quantidade,
                            "Quantidade Mínima": material.quantidadeMinima,
                            "Marcado para Compra": material.comprar ? "Sim" : "Não",
                            "Última Modificação": material.ultimaModificacao || "N/A"
                        });
                    });

                    const ws = XLSX.utils.json_to_sheet(dados);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "Estoque");
                    XLSX.writeFile(wb, "Relatorio_Estoque_Odontologico.xlsx");
                    console.log("Relatório gerado com sucesso!");
                } catch (error) {
                    console.error("Erro ao gerar relatório:", error);
                    showCustomModal("Erro", "Erro ao gerar relatório: " + error.message, 'alert');
                }
            }

            /**
             * Handles user logout.
             */
            function logout() {
                auth.signOut().then(() => {
                    console.log('Usuário desconectado com sucesso.');
                }).catch(error => {
                    console.error('Erro ao desconectar:', error);
                    showCustomModal("Erro", 'Falha ao desconectar: ' + error.message, 'alert');
                });
            }

            // Event listener for adding new material form submission
            document.getElementById('materialForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                const nome = document.getElementById('nome').value.trim();
                const quantidade = parseInt(document.getElementById('quantidade').value);
                const quantidadeMinima = parseInt(document.getElementById('quantidadeMinima').value);
                const categoria = document.getElementById('categoria').value;
                const arquivo = document.getElementById('imagem').files[0];

                // Check if material with this name already exists
                const existingDoc = await db.collection('materiais').doc(nome).get();
                if (existingDoc.exists) {
                    showCustomModal("Erro", `Já existe um material com o nome "${nome}". Por favor, escolha outro nome.`, 'alert');
                    return;
                }

                const material = {
                    nome: nome,
                    quantidade: quantidade,
                    quantidadeMinima: quantidadeMinima,
                    categoria: categoria,
                    imagem: null,
                    ultimaModificacao: new Date().toLocaleString('pt-BR'),
                    comprar: false
                };

                if (arquivo) {
                    try {
                        const dataURL = await converterParaDataURL(arquivo);
                        const tamanhoBytes = (dataURL.length * 3) / 4 - 2; // Approximate size in bytes
                        if (tamanhoBytes > 500000) { // 500 KB limit
                            showCustomModal('Aviso', 'A imagem é muito grande! Use uma imagem menor (menos de 500 KB).', 'alert');
                            return;
                        }
                        material.imagem = dataURL;
                    } catch (error) {
                        console.error('Erro ao converter imagem:', error);
                        showCustomModal('Erro', 'Falha ao processar a imagem: ' + error.message, 'alert');
                        return;
                    }
                }

                await salvarMaterial(material);
                await carregarMateriais();
                fecharModal();
            });

            /**
             * Alters the quantity of a material by a given value.
             * @param {string} nome - The name of the material.
             * @param {number} valor - The amount to add or subtract from the quantity.
             */
            async function alterarQuantidade(nome, valor) {
                const material = materiaisFiltrados.find(m => m.nome === nome);
                if (material && material.quantidade + valor >= 0) {
                    material.quantidade += valor;
                    material.ultimaModificacao = new Date().toLocaleString('pt-BR');
                    await salvarMaterial(material);
                    await carregarMateriais();
                } else if (material && material.quantidade + valor < 0) {
                    showCustomModal('Aviso', 'A quantidade não pode ser negativa.', 'alert');
                }
            }

            /**
             * Alters the quantity of a material directly from an input field.
             * @param {string} nome - The name of the material.
             * @param {number} novaQuantidade - The new quantity value.
             */
            async function alterarQuantidadeDireta(nome, novaQuantidade) {
                const material = materiaisFiltrados.find(m => m.nome === nome);
                if (material && novaQuantidade >= 0) {
                    material.quantidade = novaQuantidade;
                    material.ultimaModificacao = new Date().toLocaleString('pt-BR');
                    await salvarMaterial(material);
                    await carregarMateriais();
                } else if (material && novaQuantidade < 0) {
                    showCustomModal('Aviso', 'A quantidade não pode ser negativa.', 'alert');
                }
            }

            /**
             * Confirms and then deletes a material.
             * @param {string} nome - The name of the material to delete.
             */
            async function confirmarExclusao(nome) {
                const confirmed = await showCustomModal("Confirmar Exclusão", `Deseja realmente excluir ${nome}?`, 'confirm');
                if (confirmed) {
                    try {
                        await db.collection('materiais').doc(nome).delete();
                        await carregarMateriais();
                    } catch (error) {
                        console.error("Erro ao excluir material:", error);
                        showCustomModal("Erro", "Erro ao excluir material: " + error.message, 'alert');
                    }
                }
            }

            /**
             * Toggles the 'comprar' (to buy) status of a material.
             * @param {string} nome - The name of the material.
             */
            async function toggleComprar(nome) {
                const material = materiaisFiltrados.find(m => m.nome === nome);
                if (material) {
                    material.comprar = !material.comprar;
                    await salvarMaterial(material);
                    await carregarMateriais();
                }
            }

            // Event listener for login form submission
            document.getElementById('loginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;

                auth.signInWithEmailAndPassword(email, password)
                    .then(() => {
                        document.getElementById('loginContainer').classList.add('hidden');
                        document.getElementById('mainContainer').classList.remove('hidden');
                        carregarMateriais();
                    })
                    .catch(error => {
                        console.error('Erro ao autenticar:', error);
                        showCustomModal("Erro de Autenticação", 'Falha ao autenticar: ' + error.message, 'alert');
                    });
            });

            // Firebase authentication state change listener
            auth.onAuthStateChanged(user => {
                if (user) {
                    document.getElementById('loginContainer').classList.add('hidden');
                    document.getElementById('mainContainer').classList.remove('hidden');
                    carregarMateriais();
                } else {
                    document.getElementById('loginContainer').classList.remove('hidden');
                    document.getElementById('mainContainer').classList.add('hidden');
                }
            });

            // Event Listeners for UI interactions
            document.getElementById('btnAbrirModal').addEventListener('click', abrirModal);
            document.getElementById('btnFecharModal').addEventListener('click', fecharModal);
            document.getElementById('btnFecharModalEditar').addEventListener('click', fecharModalEditar);
            document.getElementById('btnLogout').addEventListener('click', logout);
            document.getElementById('btnLimparMarcacoes').addEventListener('click', limparMarcacoes);
            document.getElementById('btnCopiarLista').addEventListener('click', copiarListaCompras);
            document.getElementById('btnBuscar').addEventListener('click', buscarMateriais);
            document.getElementById('btnGerarRelatorio').addEventListener('click', gerarRelatorio);

            // Event listener for Advanced Options button
            document.getElementById('btnAdvancedOptions').addEventListener('click', function() {
                const advancedOptions = document.getElementById('advancedOptionsContainer');
                advancedOptions.classList.toggle('hidden');
            });

            // Close dropdowns when clicking outside
            document.addEventListener('click', function(event) {
                document.querySelectorAll('.dropdown-content').forEach(dropdown => {
                    if (!dropdown.classList.contains('hidden') && !dropdown.parentElement.contains(event.target)) {
                        dropdown.classList.add('hidden');
                    }
                });
            });
        });
    </script>
</body>
</html>
