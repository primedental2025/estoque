<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Estoque - Consult√≥rio Odontol√≥gico</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    // Custom colors from the provided palette
                    colors: {
                        'primary-dark': '#612436', // Dark purple/wine
                        'secondary-dark': '#585856', // Dark gray
                        'light-neutral': '#BFBFBF', // Light gray
                        'accent-yellow': '#F7C948', // Yellow for edit actions
                        'danger-red': '#E74C3C', // Red for delete actions
                    }
                }
            }
        }
    </script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body class="font-sans bg-light-neutral min-h-screen flex flex-col items-center p-4">

    <div id="customModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
            <h3 id="modalTitle" class="text-xl font-semibold mb-4 text-secondary-dark"></h3>
            <p id="modalMessage" class="mb-6 text-gray-700"></p>
            <div id="modalActions" class="flex justify-center space-x-4">
                </div>
        </div>
    </div>

    <div id="loginContainer" class="bg-white p-8 rounded-xl shadow-lg w-full max-w-md hidden">
        <h2 class="text-3xl font-bold text-center text-primary-dark mb-6">Login - Controle de Estoque</h2>
        <form id="loginForm" class="space-y-4">
            <div>
                <label for="email" class="sr-only">E-mail</label>
                <input type="email" id="email" placeholder="E-mail" required
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary-dark focus:border-primary-dark transition duration-200">
            </div>
            <div>
                <label for="password" class="sr-only">Senha</label>
                <input type="password" id="password" placeholder="Senha" required
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary-dark focus:border-primary-dark transition duration-200">
            </div>
            <button type="submit"
                    class="w-full bg-primary-dark text-white py-2 px-4 rounded-lg hover:bg-opacity-90 focus:outline-none focus:ring-2 focus:ring-primary-dark focus:ring-opacity-50 transition duration-200 ease-in-out transform hover:scale-105">
                Entrar
            </button>
        </form>
    </div>

    <div id="mainContainer" class="container bg-white p-6 md:p-8 rounded-xl shadow-lg w-full max-w-6xl hidden">
        <h1 class="text-3xl md:text-4xl font-extrabold text-center text-primary-dark mb-6">Controle de Estoque Odontol√≥gico</h1>

        <div class="flex flex-wrap items-center justify-center gap-3 md:gap-4 p-4 bg-light-neutral rounded-lg mb-6 shadow-sm">
            <input type="text" id="searchInput" placeholder="Buscar material..."
                   class="flex-1 min-w-[150px] px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary-dark focus:border-primary-dark transition duration-200">
            <button id="btnBuscar"
                    class="flex-1 min-w-[100px] bg-secondary-dark text-white py-2 px-4 rounded-lg hover:bg-opacity-90 focus:outline-none focus:ring-2 focus:ring-secondary-dark focus:ring-opacity-50 transition duration-200 ease-in-out transform hover:scale-105">
                Buscar
            </button>
            <button id="btnListaCompras"
                    class="flex-1 min-w-[150px] bg-secondary-dark text-white py-2 px-4 rounded-lg hover:bg-opacity-90 focus:outline-none focus:ring-2 focus:ring-secondary-dark focus:ring-opacity-50 transition duration-200 ease-in-out transform hover:scale-105">
                Lista de Compras
            </button>
            <button id="btnLimparMarcacoes"
                    class="flex-1 min-w-[150px] bg-secondary-dark text-white py-2 px-4 rounded-lg hover:bg-opacity-90 focus:outline-none focus:ring-2 focus:ring-secondary-dark focus:ring-opacity-50 transition duration-200 ease-in-out transform hover:scale-105">
                Limpar Marca√ß√µes
            </button>
            <button id="btnAdvancedOptions"
                    class="flex-1 min-w-[150px] bg-primary-dark text-white py-2 px-4 rounded-lg hover:bg-opacity-90 focus:outline-none focus:ring-2 focus:ring-primary-dark focus:ring-opacity-50 transition duration-200 ease-in-out transform hover:scale-105">
                Avan√ßado
            </button>
        </div>

        <div id="advancedOptionsContainer" class="flex flex-wrap items-center justify-center gap-3 md:gap-4 p-4 bg-light-neutral rounded-lg mb-6 shadow-sm hidden">
            <button id="btnAbrirModal"
                    class="flex-1 min-w-[150px] bg-primary-dark text-white py-2 px-4 rounded-lg hover:bg-opacity-90 focus:outline-none focus:ring-2 focus:ring-primary-dark focus:ring-opacity-50 transition duration-200 ease-in-out transform hover:scale-105">
                Adicionar Novo Item
            </button>
            <button id="btnGerarRelatorio"
                    class="flex-1 min-w-[150px] bg-secondary-dark text-white py-2 px-4 rounded-lg hover:bg-opacity-90 focus:outline-none focus:ring-2 focus:ring-secondary-dark focus:ring-opacity-50 transition duration-200 ease-in-out transform hover:scale-105">
                Gerar Relat√≥rio
            </button>
            <button id="btnLogout"
                    class="flex-1 min-w-[100px] bg-danger-red text-white py-2 px-4 rounded-lg hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50 transition duration-200 ease-in-out transform hover:scale-105">
                Sair
            </button>
        </div>

        <div class="flex flex-col md:flex-row w-full gap-6">
            <div class="w-full md:w-1/4 bg-white p-4 rounded-xl shadow-lg h-fit">
                <h2 class="text-xl font-bold text-primary-dark mb-4">Categorias</h2>
                <div id="categorySidebar" class="space-y-2">
                    </div>
            </div>

            <div class="w-full md:w-3/4">
                <div id="purchaseListActionsContainer" class="flex flex-wrap items-center justify-end gap-3 p-4 bg-light-neutral rounded-lg mb-6 shadow-sm hidden">
                    <button id="btnCopiarLista"
                            class="bg-secondary-dark text-white py-2 px-4 rounded-lg hover:bg-opacity-90 focus:outline-none focus:ring-2 focus:ring-secondary-dark focus:ring-opacity-50 transition duration-200 ease-in-out transform hover:scale-105">
                        Copiar Lista
                    </button>
                    <button id="btnMostrarTodos"
                            class="bg-primary-dark text-white py-2 px-4 rounded-lg hover:bg-opacity-90 focus:outline-none focus:ring-2 focus:ring-primary-dark focus:ring-opacity-50 transition duration-200 ease-in-out transform hover:scale-105">
                        Mostrar Todos os Itens
                    </button>
                </div>

                <div id="materialList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                    </div>
            </div>
        </div>

        <div id="cadastroModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-40 hidden">
            <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md mx-4">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-2xl font-semibold text-primary-dark">Cadastrar Novo Material</h3>
                    <button class="text-gray-500 hover:text-gray-700 text-2xl" id="btnFecharModal">
                        &times;
                    </button>
                </div>
                <form id="materialForm" class="space-y-4">
                    <input type="text" id="nome" placeholder="Nome do material" required
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary-dark focus:border-primary-dark">
                    <input type="number" id="quantidade" placeholder="Quantidade inicial" min="0" required
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary-dark focus:border-primary-dark">
                    <input type="number" id="quantidadeMinima" placeholder="Quantidade m√≠nima" min="0" required
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary-dark focus:border-primary-dark">
                    <select id="categoria" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary-dark focus:border-primary-dark">
                        <option value="">Selecione uma categoria</option>
                        <option value="biosseguranca">Biosseguran√ßa</option>
                        <option value="brocas">Brocas</option>
                        <option value="cirurgia">Cirurgia</option>
                        <option value="clinica_geral">Cl√≠nica Geral</option>
                        <option value="dentistica">Dent√≠stica</option>
                        <option value="endodontia">Endodontia</option>
                        <option value="instrumental">Instrumental</option>
                        <option value="material_limpeza">Material de Limpeza</option>
                        <option value="ortodontia">Ortodontia</option>
                        <option value="protese">Pr√≥tese</option>
                        <option value="implantodontia">Implantodontia</option>
                    </select>
                    <input type="file" id="imagem" accept="image/*"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-primary-dark hover:file:bg-blue-100">
                    <button type="submit"
                            class="w-full bg-primary-dark text-white py-2 px-4 rounded-lg hover:bg-opacity-90 focus:outline-none focus:ring-2 focus:ring-primary-dark focus:ring-opacity-50 transition duration-200 ease-in-out transform hover:scale-105">
                        Cadastrar
                    </button>
                </form>
            </div>
        </div>

        <div id="editarModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-40 hidden">
            <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md mx-4">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-2xl font-semibold text-primary-dark">Editar Material</h3>
                    <button class="text-gray-500 hover:text-gray-700 text-2xl" id="btnFecharModalEditar">
                        &times;
                    </button>
                </div>
                <form id="editarForm" class="space-y-4">
                    <input type="text" id="editNome" placeholder="Nome do material" required
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary-dark focus:border-primary-dark">
                    <input type="hidden" id="originalNome">
                    <select id="editCategoria"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary-dark focus:border-primary-dark">
                        <option value="">Selecione uma categoria</option>
                        <option value="biosseguranca">Biosseguran√ßa</option>
                        <option value="brocas">Brocas</option>
                        <option value="cirurgia">Cirurgia</option>
                        <option value="clinica_geral">Cl√≠nica Geral</option>
                        <option value="dentistica">Dent√≠stica</option>
                        <option value="endodontia">Endodontia</option>
                        <option value="instrumental">Instrumental</option>
                        <option value="material_limpeza">Material de Limpeza</option>
                        <option value="ortodontia">Ortodontia</option>
                        <option value="protese">Pr√≥tese</option>
                        <option value="implantodontia">Implantodontia</option>
                    </select>
                    <input type="number" id="editQuantidadeMinima" placeholder="Quantidade m√≠nima" min="0"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary-dark focus:border-primary-dark">
                    <input type="file" id="editImagem" accept="image/*"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-primary-dark hover:file:bg-blue-100">
                    <button type="submit"
                            class="w-full bg-primary-dark text-white py-2 px-4 rounded-lg hover:bg-opacity-90 focus:outline-none focus:ring-2 focus:ring-primary-dark focus:ring-opacity-50 transition duration-200 ease-in-out transform hover:scale-105">
                        Salvar Altera√ß√µes
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Check if Firebase SDK is loaded
            if (typeof firebase === 'undefined') {
                showCustomModal('Erro', 'Firebase SDK n√£o foi carregado. Verifique sua conex√£o ou tente novamente.', 'alert');
                return;
            }

            // Firebase configuration (replace with your actual config from __firebase_config if available)
            const firebaseConfig = {
                apiKey: "AIzaSyCDxJW_o6y-hmisQHOHVYPVJ8cag6hrKv0",
                authDomain: "estoque-prime.firebaseapp.com",
                projectId: "estoque-prime",
                storageBucket: "estoque-prime.firebasestorage.app",
                messagingSenderId: "1092019247496",
                appId: "1:1092019247496:web:92076afda68ccbc23d823d",
                measurementId: "G-04D19CYTTQ"
            };

            // Initialize Firebase
            const app = firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();
            const auth = firebase.auth();

            // Category mapping for display purposes
            const categorias = {
                biosseguranca: "Biosseguran√ßa",
                brocas: "Brocas",
                cirurgia: "Cirurgia",
                clinica_geral: "Cl√≠nica Geral",
                dentistica: "Dent√≠stica",
                endodontia: "Endodontia",
                instrumental: "Instrumental",
                material_limpeza: "Material de Limpeza",
                ortodontia: "Ortodontia",
                protese: "Pr√≥tese",
                implantodontia: "Implantodontia"
            };

            let materiaisFiltrados = [];
            let termoDeBusca = "";
            let categoriaSelecionada = "todos"; // New state for selected category
            let isShowingPurchaseList = false; // New state to track if purchase list is active

            /**
             * Displays a custom modal for alerts or confirmations.
             * @param {string} title - The title of the modal.
             * @param {string} message - The message content of the modal.
             * @param {'alert'|'confirm'|'copy'} type - The type of modal ('alert' for OK button, 'confirm' for Yes/No buttons, 'copy' for text to be manually copied).
             * @param {string} [copyText=''] - The text to be displayed for manual copying (only for 'copy' type).
             * @returns {Promise<boolean>} - Resolves to true if 'Yes'/'OK' is clicked, false otherwise.
             */
            function showCustomModal(title, message, type, copyText = '') {
                return new Promise((resolve) => {
                    const modal = document.getElementById('customModal');
                    const modalTitle = document.getElementById('modalTitle');
                    const modalMessage = document.getElementById('modalMessage');
                    const modalActions = document.getElementById('modalActions');

                    modalTitle.textContent = title;
                    modalMessage.innerHTML = ''; // Clear previous message content
                    modalActions.innerHTML = ''; // Clear previous buttons

                    if (type === 'copy') {
                        const textArea = document.createElement('textarea');
                        textArea.value = copyText;
                        textArea.readOnly = true;
                        textArea.className = 'w-full h-32 p-2 border border-gray-300 rounded-lg resize-none mb-4 font-mono text-sm';
                        modalMessage.appendChild(document.createTextNode(message)); // Add message before textarea
                        modalMessage.appendChild(document.createElement('br'));
                        modalMessage.appendChild(document.createElement('br'));
                        modalMessage.appendChild(textArea);

                        const closeButton = document.createElement('button');
                        closeButton.textContent = 'Fechar';
                        closeButton.className = 'bg-primary-dark text-white py-2 px-4 rounded-lg hover:bg-opacity-90 transition duration-200 ease-in-out transform hover:scale-105';
                        closeButton.onclick = () => {
                            modal.classList.add('hidden');
                            resolve(false); // Resolve false as it's not a confirmation
                        };
                        modalActions.appendChild(closeButton);

                        // Select text automatically for easier copying (works on most devices)
                        textArea.focus();
                        textArea.select();
                        // For iOS, setSelectionRange might be more reliable after select()
                        textArea.setSelectionRange(0, textArea.value.length);

                    } else if (type === 'alert') {
                        modalMessage.textContent = message;
                        const okButton = document.createElement('button');
                        okButton.textContent = 'OK';
                        okButton.className = 'bg-primary-dark text-white py-2 px-4 rounded-lg hover:bg-opacity-90 transition duration-200 ease-in-out transform hover:scale-105';
                        okButton.onclick = () => {
                            modal.classList.add('hidden');
                            resolve(true);
                        };
                        modalActions.appendChild(okButton);
                    } else if (type === 'confirm') {
                        modalMessage.textContent = message;
                        const yesButton = document.createElement('button');
                        yesButton.textContent = 'Sim';
                        yesButton.className = 'bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition duration-200 ease-in-out transform hover:scale-105';
                        yesButton.onclick = () => {
                            modal.classList.add('hidden');
                            resolve(true);
                        };
                        modalActions.appendChild(yesButton);

                        const noButton = document.createElement('button');
                        noButton.textContent = 'N√£o';
                        noButton.className = 'bg-danger-red text-white py-2 px-4 rounded-lg hover:bg-red-700 transition duration-200 ease-in-out transform hover:scale-105';
                        noButton.onclick = () => {
                            modal.classList.add('hidden');
                            resolve(false);
                        };
                        modalActions.appendChild(noButton);
                    }

                    modal.classList.remove('hidden');
                });
            }

            /**
             * Converts a File object to a Data URL (base64 string).
             * @param {File} file - The file to convert.
             * @returns {Promise<string>} - A promise that resolves with the Data URL.
             */
            function converterParaDataURL(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = error => reject(error);
                    reader.readAsDataURL(file);
                });
            }

            /**
             * Loads materials from Firestore, filters them based on current state,
             * and then updates the displayed list and category sidebar.
             */
            async function carregarMateriais() {
                try {
                    const snapshot = await db.collection('materiais').get();
                    let todosMateriais = [];
                    snapshot.forEach(doc => todosMateriais.push(doc.data()));

                    let materiaisParaProcessar = todosMateriais;

                    if (isShowingPurchaseList) {
                        // If showing purchase list, override other filters
                        materiaisFiltrados = todosMateriais.filter(m => m.comprar === true);
                        // Clear search and category selection for clarity in this mode
                        document.getElementById('searchInput').value = '';
                        termoDeBusca = '';
                        categoriaSelecionada = 'todos';
                    } else {
                        // Apply search filter
                        materiaisFiltrados = todosMateriais.filter(m =>
                            m.nome.toLowerCase().includes(termoDeBusca.toLowerCase())
                        );

                        // Apply category filter
                        if (categoriaSelecionada !== "todos") {
                            materiaisFiltrados = materiaisFiltrados.filter(m =>
                                m.categoria === categoriaSelecionada
                            );
                        }
                    }

                    atualizarLista(materiaisFiltrados);
                    renderizarCategorias(todosMateriais); // Always render all categories in sidebar
                    togglePurchaseListActionsVisibility(); // Update visibility of purchase list specific buttons

                } catch (error) {
                    console.error("Erro ao carregar materiais:", error);
                    showCustomModal("Erro", "Erro ao carregar materiais: " + error.message, 'alert');
                }
            }

            /**
             * Saves a material object to Firestore.
             * @param {object} material - The material object to save.
             */
            async function salvarMaterial(material) {
                try {
                    await db.collection('materiais').doc(material.nome).set(material);
                    console.log('Material salvo com sucesso:', material);
                } catch (error) {
                    console.error('Erro ao salvar material:', error);
                    showCustomModal("Erro", 'Erro ao salvar material: ' + error.message, 'alert');
                }
            }

            /**
             * Renders the category sidebar.
             * @param {Array<object>} allMaterials - All materials to extract categories from.
             */
            function renderizarCategorias(allMaterials) {
                const categorySidebar = document.getElementById('categorySidebar');
                categorySidebar.innerHTML = ''; // Clear existing categories

                const uniqueCategories = new Set();
                allMaterials.forEach(m => uniqueCategories.add(m.categoria));

                // Add "Todos" option
                const allButton = document.createElement('button');
                allButton.textContent = 'Todos';
                allButton.className = `w-full text-left py-2 px-4 rounded-lg transition duration-200 ${categoriaSelecionada === 'todos' && !isShowingPurchaseList ? 'bg-primary-dark text-white' : 'bg-gray-200 text-secondary-dark hover:bg-gray-300'}`;
                allButton.onclick = () => {
                    categoriaSelecionada = 'todos';
                    isShowingPurchaseList = false; // Disable purchase list filter
                    carregarMateriais();
                };
                categorySidebar.appendChild(allButton);

                // Add other categories
                Array.from(uniqueCategories).sort().forEach(catKey => {
                    const categoryButton = document.createElement('button');
                    categoryButton.textContent = categorias[catKey] || catKey;
                    categoryButton.className = `w-full text-left py-2 px-4 rounded-lg transition duration-200 ${categoriaSelecionada === catKey && !isShowingPurchaseList ? 'bg-primary-dark text-white' : 'bg-gray-200 text-secondary-dark hover:bg-gray-300'}`;
                    categoryButton.onclick = () => {
                        categoriaSelecionada = catKey;
                        isShowingPurchaseList = false; // Disable purchase list filter
                        carregarMateriais();
                    };
                    categorySidebar.appendChild(categoryButton);
                });
            }

            /**
             * Toggles the visibility of the "Copiar Lista" and "Mostrar Todos os Itens" buttons.
             */
            function togglePurchaseListActionsVisibility() {
                const purchaseListActionsContainer = document.getElementById('purchaseListActionsContainer');
                if (isShowingPurchaseList) {
                    purchaseListActionsContainer.classList.remove('hidden');
                } else {
                    purchaseListActionsContainer.classList.add('hidden');
                }
            }


            /**
             * Updates the material list display based on the provided materials array.
             * @param {Array<object>} materiais - An array of material objects to display.
             */
            function atualizarLista(materiais) {
                const lista = document.getElementById('materialList');
                lista.innerHTML = ''; // Clear existing items

                if (materiais.length === 0) {
                    lista.innerHTML = '<p class="text-center text-gray-600 col-span-full">Nenhum material encontrado para esta busca/categoria.</p>';
                    return;
                }

                materiais.sort((a, b) => a.nome.localeCompare(b.nome)).forEach(material => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = `material-item bg-white rounded-lg shadow-md flex flex-col transition duration-200 ease-in-out hover:shadow-lg ${material.quantidade < material.quantidadeMinima ? 'border-2 border-red-400' : ''}`;

                    // Product Image
                    const imgContainer = document.createElement('div');
                    // Changed bg-gray-200 to bg-white
                    imgContainer.className = 'w-full h-48 bg-white flex items-center justify-center relative';
                    if (material.imagem) {
                        const img = document.createElement('img');
                        img.src = material.imagem;
                        img.alt = `Imagem de ${material.nome}`;
                        img.className = 'w-full h-full object-contain';
                        img.onerror = () => {
                            console.error('Erro ao carregar imagem:', material.imagem);
                            img.src = 'https://placehold.co/300x300/BFBFBF/585856?text=Sem+Imagem'; // Placeholder image
                            img.className = 'w-24 h-24 object-contain'; // Ensure placeholder also uses object-contain
                        };
                        imgContainer.appendChild(img);
                    } else {
                         const placeholderImg = document.createElement('img');
                         placeholderImg.src = 'https://placehold.co/300x300/BFBFBF/585856?text=Sem+Imagem'; // Placeholder image
                         placeholderImg.alt = `Sem imagem para ${material.nome}`;
                         placeholderImg.className = 'w-24 h-24 object-contain';
                         imgContainer.appendChild(placeholderImg);
                    }
                    itemDiv.appendChild(imgContainer);

                    // Product Info
                    const info = document.createElement('div');
                    info.className = 'p-4 flex-grow';
                    info.innerHTML = `
                        <h3 class="text-lg font-semibold text-secondary-dark mb-1">${material.nome}</h3>
                        <p class="text-sm text-gray-700">Categoria: ${categorias[material.categoria] || material.categoria}</p>
                        <p class="text-sm text-gray-700">M√≠nimo: ${material.quantidadeMinima}</p>
                        <p class="text-xs text-gray-500 mt-1">√öltima modifica√ß√£o: ${material.ultimaModificacao || 'N/A'}</p>
                    `;
                    itemDiv.appendChild(info);

                    // Controls Section
                    const controls = document.createElement('div');
                    controls.className = 'p-4 bg-gray-50 border-t border-gray-100 flex flex-col space-y-3';

                    // Quantity controls
                    const quantityControlDiv = document.createElement('div');
                    quantityControlDiv.className = 'flex items-center justify-between gap-2';
                    quantityControlDiv.innerHTML = `<span class="text-secondary-dark font-medium">Quantidade:</span>`;

                    const qtyAdjustDiv = document.createElement('div');
                    qtyAdjustDiv.className = 'flex items-center gap-1';

                    const btnRemove = document.createElement('button');
                    btnRemove.textContent = '-';
                    btnRemove.className = 'bg-primary-dark text-white p-1 rounded-full text-base font-bold hover:bg-opacity-90 transition duration-200 w-7 h-7 flex items-center justify-center';
                    btnRemove.onclick = () => alterarQuantidade(material.nome, -1);
                    qtyAdjustDiv.appendChild(btnRemove);

                    const quantityInput = document.createElement('input');
                    quantityInput.type = 'number';
                    quantityInput.value = material.quantidade;
                    quantityInput.min = '0';
                    quantityInput.className = 'w-16 text-center border border-gray-300 rounded-md py-1 text-sm focus:ring-primary-dark focus:border-primary-dark';
                    quantityInput.onchange = (e) => alterarQuantidadeDireta(material.nome, parseInt(e.target.value));
                    qtyAdjustDiv.appendChild(quantityInput);

                    const btnAdd = document.createElement('button');
                    btnAdd.textContent = '+';
                    btnAdd.className = 'bg-primary-dark text-white p-1 rounded-full text-base font-bold hover:bg-opacity-90 transition duration-200 w-7 h-7 flex items-center justify-center';
                    btnAdd.onclick = () => alterarQuantidade(material.nome, 1);
                    qtyAdjustDiv.appendChild(btnAdd);
                    quantityControlDiv.appendChild(qtyAdjustDiv);
                    controls.appendChild(quantityControlDiv);

                    // Buy button
                    const btnComprar = document.createElement('button');
                    btnComprar.textContent = material.comprar ? 'Na Lista de Compras' : 'Adicionar √† Lista';
                    btnComprar.className = `w-full py-2 px-4 rounded-lg font-semibold transition duration-200 transform hover:scale-105 ${material.comprar ? 'bg-green-600 text-white hover:bg-green-700' : 'bg-primary-dark text-white hover:bg-opacity-90'}`;
                    btnComprar.onclick = () => toggleComprar(material.nome);
                    controls.appendChild(btnComprar);

                    // Options dropdown (Edit/Delete)
                    const optionsDropdownDiv = document.createElement('div');
                    optionsDropdownDiv.className = 'relative inline-block text-left w-full';

                    const btnOptions = document.createElement('button');
                    btnOptions.innerHTML = `<svg class="w-5 h-5 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"></path></svg> Op√ß√µes`;
                    btnOptions.className = 'w-full bg-gray-200 text-secondary-dark py-2 px-3 rounded-lg text-sm hover:bg-gray-300 transition duration-200 transform hover:scale-105 mt-2';
                    btnOptions.onclick = (e) => {
                        e.stopPropagation();
                        // Close all other dropdowns
                        document.querySelectorAll('.dropdown-content').forEach(otherDropdown => {
                            if (otherDropdown !== dropdownContent && !otherDropdown.classList.contains('hidden')) {
                                otherDropdown.classList.add('hidden');
                            }
                        });
                        dropdownContent.classList.toggle('hidden');
                    };
                    optionsDropdownDiv.appendChild(btnOptions);

                    const dropdownContent = document.createElement('div');
                    dropdownContent.className = 'dropdown-content absolute right-0 mt-2 w-40 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 hidden z-50';
                    dropdownContent.onclick = (e) => e.stopPropagation();

                    const btnEdit = document.createElement('button');
                    btnEdit.textContent = 'Editar';
                    btnEdit.className = 'block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-secondary-dark rounded-t-md';
                    btnEdit.onclick = () => {
                        abrirModalEditar(material.nome);
                        dropdownContent.classList.add('hidden');
                    };
                    dropdownContent.appendChild(btnEdit);

                    const btnDelete = document.createElement('button');
                    btnDelete.textContent = 'Excluir';
                    btnDelete.className = 'block w-full text-left px-4 py-2 text-sm text-danger-red hover:bg-red-100 hover:text-red-800 rounded-b-md';
                    btnDelete.onclick = () => {
                        confirmarExclusao(material.nome);
                        dropdownContent.classList.add('hidden');
                    };
                    dropdownContent.appendChild(btnDelete);

                    optionsDropdownDiv.appendChild(dropdownContent);
                    controls.appendChild(optionsDropdownDiv);

                    itemDiv.appendChild(controls);
                    lista.appendChild(itemDiv);
                });
            }

            /**
             * Opens the add new material modal.
             */
            function abrirModal() {
                document.getElementById('cadastroModal').classList.remove('hidden');
            }

            /**
             * Closes the add new material modal and resets the form.
             */
            function fecharModal() {
                document.getElementById('cadastroModal').classList.add('hidden');
                document.getElementById('materialForm').reset();
            }

            /**
             * Opens the edit material modal and populates it with existing material data.
             * @param {string} nome - The name of the material to edit.
             */
            function abrirModalEditar(nome) {
                const material = materiaisFiltrados.find(m => m.nome === nome);
                if (material) {
                    document.getElementById('editNome').value = material.nome;
                    document.getElementById('originalNome').value = material.nome; // Store original name
                    document.getElementById('editCategoria').value = material.categoria;
                    document.getElementById('editQuantidadeMinima').value = material.quantidadeMinima;
                    document.getElementById('editarModal').classList.remove('hidden');
                } else {
                    showCustomModal("Erro", "Material n√£o encontrado para edi√ß√£o.", 'alert');
                }
            }

            /**
             * Closes the edit material modal and resets the form.
             */
            function fecharModalEditar() {
                document.getElementById('editarModal').classList.add('hidden');
                document.getElementById('editarForm').reset();
            }

            // Event listener for editing material form submission
            document.getElementById('editarForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                const originalNome = document.getElementById('originalNome').value;
                const newNome = document.getElementById('editNome').value.trim();
                const novaCategoria = document.getElementById('editCategoria').value;
                const novaQuantidadeMinima = parseInt(document.getElementById('editQuantidadeMinima').value);
                const arquivo = document.getElementById('editImagem').files[0];

                try {
                    let materialToUpdate = materiaisFiltrados.find(m => m.nome === originalNome);
                    if (!materialToUpdate) {
                        showCustomModal("Erro", "Material original n√£o encontrado.", 'alert');
                        return;
                    }

                    let updateData = {
                        categoria: novaCategoria,
                        quantidadeMinima: novaQuantidadeMinima,
                        ultimaModificacao: new Date().toLocaleString('pt-BR')
                    };

                    if (arquivo) {
                        const dataURL = await converterParaDataURL(arquivo);
                        const tamanhoBytes = (dataURL.length * 3) / 4 - 2; // Approximate size in bytes
                        if (tamanhoBytes > 500000) { // 500 KB limit
                            showCustomModal('Aviso', 'A imagem √© muito grande! Use uma imagem menor (menos de 500 KB).', 'alert');
                            return;
                        }
                        updateData.imagem = dataURL;
                    }

                    if (newNome !== originalNome) {
                        // Check if new name already exists
                        const existingDoc = await db.collection('materiais').doc(newNome).get();
                        if (existingDoc.exists) {
                            showCustomModal("Erro", `J√° existe um material com o nome "${newNome}". Por favor, escolha outro nome.`, 'alert');
                            return;
                        }

                        // Create new document with new name
                        const newMaterialData = { ...materialToUpdate, ...updateData, nome: newNome };
                        await db.collection('materiais').doc(newNome).set(newMaterialData);

                        // Delete old document
                        await db.collection('materiais').doc(originalNome).delete();
                        console.log(`Material "${originalNome}" renomeado para "${newNome}" com sucesso!`);
                    } else {
                        // Update existing document if name hasn't changed
                        await db.collection('materiais').doc(originalNome).update(updateData);
                        console.log("Material atualizado com sucesso!");
                    }

                    fecharModalEditar();
                    carregarMateriais();
                } catch (error) {
                    console.error("Erro ao atualizar material:", error);
                    showCustomModal("Erro", "Erro ao atualizar material: " + error.message, 'alert');
                }
            });

            /**
             * Clears all 'comprar' (to buy) markings on materials.
             */
            async function limparMarcacoes() {
                const confirmed = await showCustomModal("Confirmar", "Tem certeza de que deseja limpar todas as marca√ß√µes de compra?", 'confirm');
                if (confirmed) {
                    try {
                        const snapshot = await db.collection('materiais').get();
                        const batch = db.batch();
                        snapshot.forEach(doc => batch.update(doc.ref, { comprar: false }));
                        await batch.commit();
                        console.log("Marca√ß√µes de compra limpas com sucesso!");
                        carregarMateriais();
                    } catch (error) {
                        console.error("Erro ao limpar marca√ß√µes:", error);
                        showCustomModal("Erro", "Erro ao limpar marca√ß√µes: " + error.message, 'alert');
                    }
                }
            }

            /**
             * Copies the list of materials marked for purchase to the clipboard.
             */
            async function copiarListaCompras() {
                try {
                    const snapshot = await db.collection('materiais').where("comprar", "==", true).get();
                    if (snapshot.empty) {
                        showCustomModal("Aviso", "Nenhum item marcado para compra.", 'alert');
                        return;
                    }
                    let itensPorCategoria = {};
                    snapshot.forEach(doc => {
                        let material = doc.data();
                        let categoria = categorias[material.categoria] || "Outros"; // Use mapped category name
                        if (!itensPorCategoria[categoria]) itensPorCategoria[categoria] = [];
                        itensPorCategoria[categoria].push(material.nome + " (Qtd: " + material.quantidade + ")");
                    });

                    let listaTexto = Object.keys(itensPorCategoria).sort().map(categoria => {
                        let itensOrdenados = itensPorCategoria[categoria].sort();
                        return `üîπ ${categoria.toUpperCase()}\n- ${itensOrdenados.join("\n- ")}`;
                    }).join("\n\n");

                    // Attempt to use navigator.clipboard.writeText first (modern approach)
                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        try {
                            await navigator.clipboard.writeText(listaTexto);
                            showCustomModal("Sucesso", "Lista de compras copiada com sucesso!", 'alert');
                            console.log("Lista de compras copiada (navigator.clipboard):", listaTexto);
                            return; // Exit if successful
                        } catch (err) {
                            console.warn('Falha ao usar navigator.clipboard.writeText:', err);
                            // Fallback to custom modal if navigator.clipboard fails
                        }
                    }

                    // Fallback to custom modal for manual copying
                    showCustomModal("Copiar Lista de Compras", "Por favor, selecione o texto abaixo e copie-o manualmente:", 'copy', listaTexto);

                } catch (error) {
                    console.error("Erro geral ao copiar a lista:", error);
                    showCustomModal("Erro", "Erro ao copiar a lista: " + error.message, 'alert');
                }
            }

            /**
             * Initiates a search for materials based on the input field.
             */
            async function buscarMateriais() {
                termoDeBusca = document.getElementById('searchInput').value.toLowerCase().trim();
                isShowingPurchaseList = false; // Disable purchase list filter
                carregarMateriais();
            }

            /**
             * Generates an Excel report of all materials.
             */
            async function gerarRelatorio() {
                try {
                    const snapshot = await db.collection('materiais').get();
                    if (snapshot.empty) {
                        showCustomModal("Aviso", "Nenhum material encontrado para gerar o relat√≥rio.", 'alert');
                        return;
                    }

                    const dados = [];
                    snapshot.forEach(doc => {
                        const material = doc.data();
                        dados.push({
                            Nome: material.nome,
                            Categoria: categorias[material.categoria] || material.categoria,
                            Quantidade: material.quantidade,
                            "Quantidade M√≠nima": material.quantidadeMinima,
                            "Marcado para Compra": material.comprar ? "Sim" : "N√£o",
                            "√öltima Modifica√ß√£o": material.ultimaModificacao || "N/A"
                        });
                    });

                    const ws = XLSX.utils.json_to_sheet(dados);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "Estoque");
                    XLSX.writeFile(wb, "Relatorio_Estoque_Odontologico.xlsx");
                    console.log("Relat√≥rio gerado com sucesso!");
                } catch (error) {
                    console.error("Erro ao gerar relat√≥rio:", error);
                    showCustomModal("Erro", "Erro ao gerar relat√≥rio: " + error.message, 'alert');
                }
            }

            /**
             * Handles user logout.
             */
            function logout() {
                auth.signOut().then(() => {
                    console.log('Usu√°rio desconectado com sucesso.');
                }).catch(error => {
                    console.error('Erro ao desconectar:', error);
                    showCustomModal("Erro", 'Falha ao desconectar: ' + error.message, 'alert');
                });
            }

            // Event listener for adding new material form submission
            document.getElementById('materialForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                const nome = document.getElementById('nome').value.trim();
                const quantidade = parseInt(document.getElementById('quantidade').value);
                const quantidadeMinima = parseInt(document.getElementById('quantidadeMinima').value);
                const categoria = document.getElementById('categoria').value;
                const arquivo = document.getElementById('imagem').files[0];

                // Check if material with this name already exists
                const existingDoc = await db.collection('materiais').doc(nome).get();
                if (existingDoc.exists) {
                    showCustomModal("Erro", `J√° existe um material com o nome "${nome}". Por favor, escolha outro nome.`, 'alert');
                    return;
                }

                const material = {
                    nome: nome,
                    quantidade: quantidade,
                    quantidadeMinima: quantidadeMinima,
                    categoria: categoria,
                    imagem: null,
                    ultimaModificacao: new Date().toLocaleString('pt-BR'),
                    comprar: false
                };

                if (arquivo) {
                    try {
                        const dataURL = await converterParaDataURL(arquivo);
                        const tamanhoBytes = (dataURL.length * 3) / 4 - 2; // Approximate size in bytes
                        if (tamanhoBytes > 500000) { // 500 KB limit
                            showCustomModal('Aviso', 'A imagem √© muito grande! Use uma imagem menor (menos de 500 KB).', 'alert');
                            return;
                        }
                        material.imagem = dataURL;
                    } catch (error) {
                        console.error('Erro ao converter imagem:', error);
                        showCustomModal('Erro', 'Falha ao processar a imagem: ' + error.message, 'alert');
                        return;
                    }
                }

                await salvarMaterial(material);
                await carregarMateriais();
                fecharModal();
            });

            /**
             * Alters the quantity of a material by a given value.
             * @param {string} nome - The name of the material.
             * @param {number} valor - The amount to add or subtract from the quantity.
             */
            async function alterarQuantidade(nome, valor) {
                const material = materiaisFiltrados.find(m => m.nome === nome);
                if (material && material.quantidade + valor >= 0) {
                    material.quantidade += valor;
                    material.ultimaModificacao = new Date().toLocaleString('pt-BR');
                    await salvarMaterial(material);
                    await carregarMateriais();
                } else if (material && material.quantidade + valor < 0) {
                    showCustomModal('Aviso', 'A quantidade n√£o pode ser negativa.', 'alert');
                }
            }

            /**
             * Alters the quantity of a material directly from an input field.
             * @param {string} nome - The name of the material.
             * @param {number} novaQuantidade - The new quantity value.
             */
            async function alterarQuantidadeDireta(nome, novaQuantidade) {
                const material = materiaisFiltrados.find(m => m.nome === nome);
                if (material && novaQuantidade >= 0) {
                    material.quantidade = novaQuantidade;
                    material.ultimaModificacao = new Date().toLocaleString('pt-BR');
                    await salvarMaterial(material);
                    await carregarMateriais();
                } else if (material && novaQuantidade < 0) {
                    showCustomModal('Aviso', 'A quantidade n√£o pode ser negativa.', 'alert');
                }
            }

            /**
             * Confirms and then deletes a material.
             * @param {string} nome - The name of the material to delete.
             */
            async function confirmarExclusao(nome) {
                const confirmed = await showCustomModal("Confirmar Exclus√£o", `Deseja realmente excluir ${nome}?`, 'confirm');
                if (confirmed) {
                    try {
                        await db.collection('materiais').doc(nome).delete();
                        await carregarMateriais();
                    } catch (error) {
                        console.error("Erro ao excluir material:", error);
                        showCustomModal("Erro", "Erro ao excluir material: " + error.message, 'alert');
                    }
                }
            }

            /**
             * Toggles the 'comprar' (to buy) status of a material.
             * @param {string} nome - The name of the material.
             */
            async function toggleComprar(nome) {
                const material = materiaisFiltrados.find(m => m.nome === nome);
                if (material) {
                    material.comprar = !material.comprar;
                    await salvarMaterial(material);
                    await carregarMateriais();
                }
            }

            // Event listener for login form submission
            document.getElementById('loginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;

                auth.signInWithEmailAndPassword(email, password)
                    .then(() => {
                        document.getElementById('loginContainer').classList.add('hidden');
                        document.getElementById('mainContainer').classList.remove('hidden');
                        carregarMateriais();
                    })
                    .catch(error => {
                        console.error('Erro ao autenticar:', error);
                        showCustomModal("Erro de Autentica√ß√£o", 'Falha ao autenticar: ' + error.message, 'alert');
                    });
            });

            // Firebase authentication state change listener
            auth.onAuthStateChanged(user => {
                if (user) {
                    document.getElementById('loginContainer').classList.add('hidden');
                    document.getElementById('mainContainer').classList.remove('hidden');
                    carregarMateriais();
                } else {
                    document.getElementById('loginContainer').classList.remove('hidden');
                    document.getElementById('mainContainer').classList.add('hidden');
                }
            });

            // Event Listeners for UI interactions
            document.getElementById('btnAbrirModal').addEventListener('click', abrirModal);
            document.getElementById('btnFecharModal').addEventListener('click', fecharModal);
            document.getElementById('btnFecharModalEditar').addEventListener('click', fecharModalEditar);
            document.getElementById('btnLogout').addEventListener('click', logout);
            document.getElementById('btnLimparMarcacoes').addEventListener('click', limparMarcacoes);

            // New event listener for "Lista de Compras" button
            document.getElementById('btnListaCompras').addEventListener('click', () => {
                isShowingPurchaseList = true;
                carregarMateriais();
            });

            // New event listener for "Mostrar Todos os Itens" button
            document.getElementById('btnMostrarTodos').addEventListener('click', () => {
                isShowingPurchaseList = false;
                document.getElementById('searchInput').value = ''; // Clear search input
                termoDeBusca = ''; // Clear search term
                categoriaSelecionada = 'todos'; // Reset category selection
                carregarMateriais();
            });

            // "Copiar Lista" button now inside the purchase list container
            document.getElementById('btnCopiarLista').addEventListener('click', copiarListaCompras);


            document.getElementById('btnBuscar').addEventListener('click', buscarMateriais);
            document.getElementById('btnGerarRelatorio').addEventListener('click', gerarRelatorio);

            // Event listener for Advanced Options button
            document.getElementById('btnAdvancedOptions').addEventListener('click', function() {
                const advancedOptions = document.getElementById('advancedOptionsContainer');
                advancedOptions.classList.toggle('hidden');
            });

            // Close dropdowns when clicking outside
            document.addEventListener('click', function(event) {
                document.querySelectorAll('.dropdown-content').forEach(dropdown => {
                    if (!dropdown.classList.contains('hidden') && !dropdown.parentElement.contains(event.target)) {
                        dropdown.classList.add('hidden');
                    }
                });
            });
        });
    </script>
</body>
</html>
