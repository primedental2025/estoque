<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Materiais â€” Ãšltima compra & Lista de Compras</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0f172a;           /* slate-900 */
      --card:#111827;         /* gray-900 */
      --muted:#94a3b8;        /* slate-400 */
      --text:#e5e7eb;         /* gray-200 */
      --accent:#22d3ee;       /* cyan-400 */
      --ok:#10b981;           /* emerald-500 */
      --warn:#f59e0b;         /* amber-500 */
      --danger:#ef4444;       /* red-500 */
      --chip:#1f2937;         /* gray-800 */
      --border:#1f2937;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:linear-gradient(180deg,#0b1228 0%, #0f172a 100%);
      color:var(--text);
      font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;
    }
    header{
      position:sticky; top:0; z-index:10;
      backdrop-filter:saturate(180%) blur(10px);
      background:rgba(2,6,23,.7);
      border-bottom:1px solid #0b1022;
    }
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .title{display:flex;align-items:center;gap:12px}
    .title h1{margin:0;font-size:20px;font-weight:700}
    .tools{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    .input{
      display:flex;align-items:center;gap:8px;
      background:#0b1022;border:1px solid var(--border);
      padding:10px 12px;border-radius:12px;min-width:240px;flex:1;
    }
    .input input{
      background:transparent;border:0;outline:0;color:var(--text);width:100%;
      font-size:14px;
    }
    .btn{
      border:1px solid var(--border);
      background:#0b1022;color:var(--text);
      padding:10px 14px;border-radius:12px;cursor:pointer;
      transition:transform .08s ease, border-color .2s ease, background .2s ease;
    }
    .btn:hover{transform:translateY(-1px);border-color:#2b375a}
    .btn.active{border-color:var(--accent); box-shadow:0 0 0 1px inset rgba(34,211,238,.25)}
    .grid{
      display:grid;gap:14px;
      grid-template-columns: repeat(auto-fill,minmax(260px,1fr));
      padding:18px 16px 40px;
    }
    .card{
      background:linear-gradient(180deg,#0b1022 0%, #0f172a 100%);
      border:1px solid var(--border);border-radius:16px;overflow:hidden;
      position:relative;
    }
    .card .thumb{
      height:140px;background:#0b1022;display:flex;align-items:center;justify-content:center;
      border-bottom:1px solid var(--border);
    }
    .card .thumb img{max-height:100%;max-width:100%;object-fit:contain}
    .card .body{padding:12px 12px 8px}
    .name{font-weight:700;font-size:15px;margin:0 0 6px}
    .cat{color:var(--muted);font-size:12px;margin-bottom:10px}
    .attrs{display:flex;flex-direction:column;gap:6px;margin-top:8px}
    .attr{display:flex;justify-content:space-between;gap:8px;background:var(--chip);padding:8px 10px;border-radius:10px;border:1px solid var(--border)}
    .attr-label{color:var(--muted);font-size:12px}
    .attr-value{font-weight:600}
    .row{display:flex;gap:8px;margin:12px 0 8px}
    .chip{
      font-size:12px;color:#e2f5fb;background:#062431;border:1px solid #0f3642;border-radius:999px;padding:6px 10px
    }
    .actions{display:flex;gap:8px;padding:10px;border-top:1px solid var(--border)}
    .a-btn{flex:1;text-align:center;border:1px solid var(--border);padding:9px;border-radius:10px;cursor:pointer;background:#0b1022}
    .a-btn.primary{border-color:#164e63;background:#092c34;color:#d8fbff}
    .switch{
      display:flex;align-items:center;gap:8px;margin-left:auto
    }
    .switch input{accent-color:var(--accent);width:18px;height:18px}
    .empty{opacity:.8;text-align:center;padding:40px}
    /* Modal */
    dialog{
      border:1px solid var(--border);border-radius:16px;background:#0b1022;color:var(--text);
      width:min(720px,92vw);padding:0;overflow:hidden;
    }
    dialog::backdrop{background:rgba(0,0,0,.55)}
    .modal-head{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;border-bottom:1px solid var(--border)}
    .modal-body{padding:16px}
    .modal-actions{display:flex;gap:8px;justify-content:flex-end;padding:12px 16px;border-top:1px solid var(--border)}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .field{display:flex;flex-direction:column;gap:6px}
    .field label{font-size:12px;color:var(--muted)}
    .field input, .field select{
      background:#0a142a;border:1px solid var(--border);border-radius:10px;padding:10px;color:var(--text)
    }
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{border-bottom:1px solid var(--border);padding:8px;text-align:left}
    th{color:var(--muted);font-weight:600}
    .x{cursor:pointer;border:1px solid var(--border);padding:6px 10px;border-radius:10px;background:#0b1022}
    .save{background:#05262b;border:1px solid #0e3a42;color:#d9f7ff;padding:8px 12px;border-radius:10px;cursor:pointer}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="title">
        <h1>Materiais</h1>
        <span class="chip">Mostrando <strong>Ãšltima compra</strong> no lugar do estoque</span>
      </div>
      <div class="tools">
        <div class="input">
          ðŸ”Ž
          <input id="q" type="search" placeholder="Buscar por nome ou categoriaâ€¦" />
        </div>
        <button id="btnLista" class="btn" title="Mostrar apenas itens marcados na Lista de Compras">Lista de Compras</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section id="grid" class="grid" aria-live="polite"></section>
    <div id="empty" class="empty" hidden>Nenhum item encontrado.</div>
  </main>

  <!-- Modal Registrar Compra -->
  <dialog id="dlgCompra">
    <div class="modal-head">
      <strong>Registrar compra â€” <span id="dlgCompraNome"></span></strong>
      <button class="x" onclick="dlgCompra.close()">Fechar</button>
    </div>
    <form id="formCompra" class="modal-body">
      <div class="grid-2">
        <div class="field">
          <label>Quantidade</label>
          <input required min="0" step="1" type="number" name="qtd" />
        </div>
        <div class="field">
          <label>PreÃ§o unitÃ¡rio (R$)</label>
          <input required min="0" step="0.01" type="number" name="preco" />
        </div>
        <div class="field">
          <label>Data da compra</label>
          <input type="date" name="dataCompra" />
        </div>
        <div class="field">
          <label>Loja</label>
          <input type="text" name="loja" placeholder="Opcional" />
        </div>
        <div class="field">
          <label>NÂº da NF</label>
          <input type="text" name="nf" placeholder="Opcional" />
        </div>
        <div class="field">
          <label>Lote</label>
          <input type="text" name="lote" placeholder="Opcional" />
        </div>
        <div class="field">
          <label>Validade</label>
          <input type="date" name="validade" />
        </div>
        <div class="field">
          <label>EAN</label>
          <input type="text" name="ean" placeholder="Opcional" />
        </div>
      </div>
    </form>
    <div class="modal-actions">
      <button class="x" onclick="dlgCompra.close()">Cancelar</button>
      <button class="save" id="btnSalvarCompra">Salvar</button>
    </div>
  </dialog>

  <!-- Modal HistÃ³rico -->
  <dialog id="dlgHist">
    <div class="modal-head">
      <strong>HistÃ³rico de compras â€” <span id="dlgHistNome"></span></strong>
      <button class="x" onclick="dlgHist.close()">Fechar</button>
    </div>
    <div class="modal-body">
      <table>
        <thead>
          <tr>
            <th>Data</th>
            <th>Qtd</th>
            <th>PreÃ§o unit.</th>
            <th>Total</th>
            <th>Lote</th>
            <th>Validade</th>
            <th>Loja</th>
            <th>NF</th>
            <th>Origem</th>
          </tr>
        </thead>
        <tbody id="histBody"></tbody>
      </table>
    </div>
    <div class="modal-actions">
      <button class="x" onclick="dlgHist.close()">Fechar</button>
    </div>
  </dialog>

  <!-- Firebase SDKs -->
  <script type="module">
    import {
      initializeApp
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getFirestore, collection, doc, getDocs, getDoc, query, where, orderBy, limit, addDoc,
      updateDoc, serverTimestamp, Timestamp
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
    // ðŸ”§ Cole seu config
    const firebaseConfig = {
      apiKey: "AIzaSyCDxJW_o6y-hmisQHOHVYPVJ8cag6hrKv0",
      authDomain: "estoque-prime.firebaseapp.com",
      projectId: "estoque-prime",
      storageBucket: "estoque-prime.firebasestorage.app",
      messagingSenderId: "1092019247496",
      appId: "1:1092019247496:web:92076afda68ccbc23d823d",
      measurementId: "G-04D19CYTTQ"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // ---------- Utilidades ----------
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

    function fmtMoney(v){
      if(v==null || isNaN(v)) return "â€“";
      return Number(v).toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
    }
    function fmtDate(d){
      if(!d) return "â€“";
      const dt = d instanceof Date ? d : (d?.toDate?.() ?? null);
      if(!dt) return "â€“";
      return dt.toLocaleDateString("pt-BR");
    }
    function timeAgo(ts){
      if(!ts) return "â€“";
      const base = ts instanceof Date ? ts : (ts?.toDate?.() ?? null);
      if(!base) return "â€“";
      const ms = Date.now() - base.getTime();
      const d = Math.floor(ms/86400000);
      if(d>0) return `hÃ¡ ${d}d`;
      const h = Math.floor(ms/3600000);
      if(h>0) return `hÃ¡ ${h}h`;
      const m = Math.floor(ms/60000);
      if(m>0) return `hÃ¡ ${m}min`;
      return "agora";
    }

    // ---------- Estado UI ----------
    const state = {
      onlyLista:false,
      q:"",
      cacheMateriais:[]
    };

    const gridEl  = $("#grid");
    const emptyEl = $("#empty");
    const qEl     = $("#q");
    const btnLista= $("#btnLista");

    qEl.addEventListener("input", ()=>{ state.q = qEl.value.trim().toLowerCase(); render(); });
    btnLista.addEventListener("click", ()=>{
      state.onlyLista = !state.onlyLista;
      btnLista.classList.toggle("active", state.onlyLista);
      render();
    });

    // ---------- Firestore ----------
    async function fetchMateriais(){
      // Busca todos os materiais; filtros sÃ£o aplicados client-side para preservar simplicidade
      const snap = await getDocs(collection(db,"materiais"));
      state.cacheMateriais = snap.docs.map(d => ({id:d.id, ...d.data()}));
    }

    function matchFilters(m){
      if(state.onlyLista && !m.emListaCompras) return false;
      if(!state.q) return true;
      const hay = `${m.nome||""} ${m.categoria||""}`.toLowerCase();
      return hay.includes(state.q);
    }

    function attrRow(label, value){
      const row = document.createElement("div");
      row.className = "attr";
      const l = document.createElement("span"); l.className="attr-label"; l.textContent = label;
      const v = document.createElement("span"); v.className="attr-value"; v.textContent = value;
      row.append(l,v);
      return row;
    }

    function thumbImg(src){
      const w = document.createElement("div");
      w.className="thumb";
      if(src){
        const img = document.createElement("img");
        img.src = src; img.alt = "Foto do item";
        w.appendChild(img);
      }else{
        w.textContent = "sem foto";
        w.style.color = "var(--muted)";
        w.style.fontSize = "12px";
      }
      return w;
    }

    async function toggleLista(item){
      const ref = doc(db,"materiais", item.id);
      if(item.emListaCompras){
        await updateDoc(ref, { emListaCompras:false, emListaDesde:null });
        item.emListaCompras = false; item.emListaDesde = null;
      }else{
        await updateDoc(ref, { emListaCompras:true, emListaDesde: serverTimestamp() });
        item.emListaCompras = true; item.emListaDesde = Timestamp.now();
      }
      render(); // atualizaÃ§Ã£o rÃ¡pida
    }

    function openHist(item){
      $("#dlgHistNome").textContent = item.nome || item.id;
      const body = $("#histBody");
      body.innerHTML = "Carregandoâ€¦";
      dlgHist.showModal();
      // buscar Ãºltimas compras
      (async()=>{
        const qy = query(
          collection(db,"materiais", item.id, "compras"),
          orderBy("dataCompra","desc"),
          limit(100)
        );
        const snap = await getDocs(qy);
        body.innerHTML = "";
        if(snap.empty){
          const tr = document.createElement("tr");
          const td = document.createElement("td"); td.colSpan=9; td.textContent="Sem registros.";
          tr.appendChild(td); body.appendChild(tr);
          return;
        }
        snap.forEach(docu=>{
          const c = docu.data();
          const tr = document.createElement("tr");
          const total = (Number(c.qtd||0)*Number(c.precoUnit||0))||0;
          tr.innerHTML = `
            <td>${c.dataCompra ? new Date(c.dataCompra).toLocaleDateString("pt-BR") : "â€“"}</td>
            <td>${c.qtd ?? "â€“"}</td>
            <td>${fmtMoney(c.precoUnit)}</td>
            <td>${fmtMoney(total)}</td>
            <td>${c.lote||"â€“"}</td>
            <td>${c.validade? new Date(c.validade).toLocaleDateString("pt-BR"):"â€“"}</td>
            <td>${c.loja||"â€“"}</td>
            <td>${c.numeroNF||"â€“"}</td>
            <td>${c.origem||"manual"}</td>
          `;
          body.appendChild(tr);
        });
      })().catch(err=>{
        console.error(err);
        $("#histBody").innerHTML = `<tr><td colspan="9">Erro ao carregar histÃ³rico.</td></tr>`;
      });
    }

    const dlgCompra = $("#dlgCompra");
    const formCompra= $("#formCompra");
    let compraItemAtual = null;

    function openCompra(item){
      compraItemAtual = item;
      $("#dlgCompraNome").textContent = item.nome || item.id;
      formCompra.reset();
      // data padrÃ£o: hoje
      const today = new Date(); today.setMinutes(today.getMinutes()-today.getTimezoneOffset());
      formCompra.dataCompra.value = today.toISOString().slice(0,10);
      dlgCompra.showModal();
    }

    async function salvarCompra(){
      if(!compraItemAtual) return;
      const fd = new FormData(formCompra);
      const qtd = Number(fd.get("qtd"));
      const preco = Number(fd.get("preco"));
      const dataCompra = fd.get("dataCompra");
      const loja = (fd.get("loja")||"").trim();
      const nf   = (fd.get("nf")||"").trim();
      const lote = (fd.get("lote")||"").trim();
      const validade = fd.get("validade");
      const ean = (fd.get("ean")||"").trim();

      if(!(qtd>0) || !(preco>=0)){
        alert("Informe quantidade (>0) e preÃ§o (>=0).");
        return;
      }

      const itemId = compraItemAtual.id;
      const compra = {
        origem: "manual",
        dataCompra: dataCompra ? new Date(dataCompra).toISOString() : new Date().toISOString(),
        qtd: qtd,
        precoUnit: preco,
        total: Number((qtd*preco).toFixed(2)),
        lote: lote || null,
        validade: validade ? new Date(validade).toISOString() : null,
        ean: ean || null,
        loja: loja || null,
        numeroNF: nf || null,
        criadoEm: new Date().toISOString()
      };

      try{
        // grava no histÃ³rico
        await addDoc(collection(db,"materiais", itemId, "compras"), compra);
        // atualiza campos do item: **ultimaQtdComprada** e **ultimaCompraEm**
        await updateDoc(doc(db,"materiais", itemId), {
          ultimaQtdComprada: qtd,
          ultimaCompraEm: new Date(compra.dataCompra)
        });
        dlgCompra.close();
        // refresca item em memÃ³ria
        const fresh = await getDoc(doc(db,"materiais", itemId));
        const idx = state.cacheMateriais.findIndex(m=>m.id===itemId);
        if(idx>=0) state.cacheMateriais[idx] = {id:itemId, ...fresh.data()};
        render();
      }catch(e){
        console.error(e);
        alert("Erro ao registrar compra. Verifique a conexÃ£o/permite.");
      }
    }

    $("#btnSalvarCompra").addEventListener("click", salvarCompra);

    // ---------- Render ----------
    function render(){
      const list = state.cacheMateriais.filter(matchFilters);
      gridEl.innerHTML = "";
      emptyEl.hidden = list.length>0;

      for(const m of list){
        const card = document.createElement("article"); card.className="card";

        // Thumb
        card.appendChild(thumbImg(m.fotoURL));

        // Corpo
        const body = document.createElement("div"); body.className="body";
        const name = document.createElement("h3"); name.className="name"; name.textContent = m.nome || m.id;
        const cat  = document.createElement("div"); cat.className="cat";  cat.textContent = m.categoria || "Sem categoria";
        body.append(name,cat);

        // Atributos (em ordem de importÃ¢ncia)
        const attrs = document.createElement("div"); attrs.className="attrs";
        // 1) Ãšltima compra (quantidade)
        const qtdUltima = (m.ultimaQtdComprada ?? null);
        attrs.appendChild( attrRow("Ãšltima compra:", (qtdUltima!=null ? String(qtdUltima) : "â€“")) );
        // 2) Ãšltima compra (data) â€” se jÃ¡ existia no seu schema, mantemos
        attrs.appendChild( attrRow("Comprado em:", fmtDate(m.ultimaCompraEm)) );
        // 3) Na Lista de Compras (tempo decorrido)
        const desde = m.emListaDesde ? (m.emListaDesde?.toDate?.() || new Date(m.emListaDesde)) : null;
        attrs.appendChild( attrRow("Na Lista:", m.emListaCompras ? timeAgo(desde) : "â€“") );

        // Linha de chips e switch
        const row = document.createElement("div"); row.className="row";
        if(m.categoria){ const chip = document.createElement("span"); chip.className="chip"; chip.textContent = m.categoria; row.appendChild(chip); }

        const sw = document.createElement("label"); sw.className="switch";
        sw.innerHTML = `
          <input type="checkbox" ${m.emListaCompras ? "checked":""} />
          <span>Lista de Compras</span>
        `;
        const swInput = $("input", sw);
        swInput.addEventListener("change", ()=> toggleLista(m));
        row.appendChild(sw);

        body.append(attrs, row);
        card.appendChild(body);

        // AÃ§Ãµes
        const actions = document.createElement("div"); actions.className="actions";
        const btnHist   = document.createElement("button"); btnHist.className="a-btn"; btnHist.textContent="HistÃ³rico";
        btnHist.addEventListener("click", ()=>openHist(m));
        const btnCompra = document.createElement("button"); btnCompra.className="a-btn primary"; btnCompra.textContent="Registrar compra";
        btnCompra.addEventListener("click", ()=>openCompra(m));
        actions.append(btnHist, btnCompra);
        card.appendChild(actions);

        gridEl.appendChild(card);
      }
    }

    // ---------- Boot ----------
    (async function start(){
      await fetchMateriais();
      render();
    })().catch(err=>{
      console.error(err);
      gridEl.innerHTML = "";
      emptyEl.hidden = false;
      emptyEl.textContent = "Erro ao carregar. Verifique se o Firebase foi configurado.";
    });
  </script>
</body>
</html>
