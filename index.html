<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Verificar se o Firebase está disponível
        if (typeof firebase === 'undefined') {
            console.error('Firebase SDK não foi carregado corretamente.');
            alert('Erro: Firebase SDK não foi carregado. Verifique sua conexão ou tente novamente.');
            return;
        }

        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCDxJW_o6y-hmisQHOHVYPVJ8cag6hrKv0",
            authDomain: "estoque-prime.firebaseapp.com",
            projectId: "estoque-prime",
            storageBucket: "estoque-prime.firebasestorage.app",
            messagingSenderId: "1092019247496",
            appId: "1:1092019247496:web:92076afda68ccbc23d823d",
            measurementId: "G-04D19CYTTQ"
        };

        // Inicializar Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Variáveis globais
        let materiais = [];
        let materiaisFiltrados = [];

        // Lista de categorias
        const categorias = {
            biosseguranca: "Biossegurança",
            brocas: "Brocas",
            cirurgia: "Cirurgia",
            clinica_geral: "Clínica Geral",
            dentistica: "Dentística",
            endodontia: "Endodontia",
            instrumental: "Instrumental",
            material_limpeza: "Material de Limpeza",
            ortodontia: "Ortodontia",
            protese: "Prótese",
            implantodontia: "Implantodontia"
        };

        // Função para gerar ID seguro a partir do nome
        function gerarIdMaterial(nome) {
            return nome.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '');
        }

        // Função para converter arquivo em data URL
        function converterParaDataURL(arquivo) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(arquivo);
            });
        }

        // Função para salvar um material no Firestore
        async function salvarMaterial(material) {
            const materialId = gerarIdMaterial(material.nome);
            console.log('Salvando material:', materialId, material);
            try {
                await db.collection('estoque').doc('materiais').collection('itens').doc(materialId).set({
                    ...material,
                    ultimaModificacao: firebase.firestore.FieldValue.serverTimestamp()
                });
                console.log(`Material ${materialId} salvo com sucesso!`);
            } catch (error) {
                console.error('Erro ao salvar material:', error);
                throw error;
            }
        }

        // Função para carregar todos os materiais do Firestore
        async function carregarDoServidor() {
            console.log('Carregando dados do Firestore...');
            try {
                const materiaisRef = db.collection('estoque').doc('materiais').collection('itens');
                const snapshot = await materiaisRef.get();
                materiais = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    materiais.push({
                        nome: data.nome,
                        quantidade: data.quantidade,
                        quantidadeMinima: data.quantidadeMinima,
                        categoria: data.categoria,
                        imagem: data.imagem || null,
                        ultimaModificacao: data.ultimaModificacao ? data.ultimaModificacao.toDate().toLocaleString('pt-BR') : 'N/A',
                        comprar: data.comprar || false
                    });
                });
                materiaisFiltrados = [...materiais];
                atualizarLista();
                console.log('Dados carregados com sucesso:', materiais);
            } catch (error) {
                console.error('Erro ao carregar:', error);
                alert('Falha ao carregar os dados do servidor: ' + error.message);
            }
        }

        // Função para atualizar a lista na interface
        function atualizarLista() {
            const lista = document.getElementById('materialList');
            lista.innerHTML = '';
            const materiaisPorCategoria = {};
            materiaisFiltrados.forEach(material => {
                if (!materiaisPorCategoria[material.categoria]) {
                    materiaisPorCategoria[material.categoria] = [];
                }
                materiaisPorCategoria[material.categoria].push(material);
            });

            Object.keys(materiaisPorCategoria).sort().forEach(categoria => {
                const section = document.createElement('div');
                section.className = 'category-section';
                const title = document.createElement('h3');
                title.className = 'category-title';
                title.textContent = categorias[categoria] || categoria;
                section.appendChild(title);

                materiaisPorCategoria[categoria].sort((a, b) => a.nome.localeCompare(b.nome)).forEach(material => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'material-item';
                    if (material.quantidade < material.quantidadeMinima) {
                        itemDiv.classList.add('abaixo-minimo');
                    }

                    if (material.imagem) {
                        const img = document.createElement('img');
                        img.src = material.imagem;
                        img.onerror = () => {
                            console.error('Erro ao carregar imagem:', material.imagem);
                            img.style.display = 'none';
                        };
                        itemDiv.appendChild(img);
                    }

                    const info = document.createElement('div');
                    info.className = 'material-info';
                    info.innerHTML = `<strong>${material.nome}</strong> <span class="quantidade">Quantidade: ${material.quantidade}</span><br><span class="detalhes">Mínimo: ${material.quantidadeMinima} | Última modificação: ${material.ultimaModificacao || 'N/A'}</span>`;
                    itemDiv.appendChild(info);

                    const controls = document.createElement('div');
                    controls.className = 'controls';

                    const quantidadeBtns = document.createElement('div');
                    quantidadeBtns.className = 'quantidade-btns';
                    const btnAdd = document.createElement('button');
                    btnAdd.textContent = '+';
                    btnAdd.onclick = () => alterarQuantidade(material.nome, 1);
                    quantidadeBtns.appendChild(btnAdd);

                    const btnRemove = document.createElement('button');
                    btnRemove.textContent = '-';
                    btnRemove.onclick = () => alterarQuantidade(material.nome, -1);
                    quantidadeBtns.appendChild(btnRemove);
                    controls.appendChild(quantidadeBtns);

                    const acaoBtns = document.createElement('div');
                    acaoBtns.className = 'acao-btns';
                    const btnEdit = document.createElement('button');
                    btnEdit.textContent = 'Editar';
                    btnEdit.className = 'edit-btn';
                    btnEdit.onclick = () => abrirModalEditar(material.nome);
                    acaoBtns.appendChild(btnEdit);

                    const btnDelete = document.createElement('button');
                    btnDelete.textContent = 'Excluir';
                    btnDelete.className = 'delete-btn';
                    btnDelete.onclick = () => confirmarExclusao(material.nome);
                    acaoBtns.appendChild(btnDelete);
                    controls.appendChild(acaoBtns);

                    const btnComprar = document.createElement('button');
                    btnComprar.textContent = 'Comprar';
                    btnComprar.className = 'comprar-btn';
                    btnComprar.classList.toggle('active', material.comprar);
                    btnComprar.onclick = () => toggleComprar(material.nome);
                    controls.appendChild(btnComprar);

                    itemDiv.appendChild(controls);
                    section.appendChild(itemDiv);
                });

                lista.appendChild(section);
            });
        }

        // Funções de Modal
        function abrirModal() {
            document.getElementById('cadastroModal').style.display = 'flex';
        }

        function fecharModal() {
            document.getElementById('cadastroModal').style.display = 'none';
            document.getElementById('materialForm').reset();
        }

        function abrirModalEditar(nome) {
            const idx = materiais.findIndex(m => m.nome === nome);
            const material = materiais[idx];
            document.getElementById('editNome').value = material.nome;
            document.getElementById('editCategoria').value = material.categoria;
            document.getElementById('editQuantidadeMinima').value = material.quantidadeMinima;
            document.getElementById('editarModal').style.display = 'flex';
        }

        function fecharModalEditar() {
            document.getElementById('editarModal').style.display = 'none';
            document.getElementById('editarForm').reset();
        }

        // Função de Logout
        function logout() {
            auth.signOut()
                .then(() => {
                    console.log('Usuário desconectado com sucesso.');
                })
                .catch(error => {
                    console.error('Erro ao desconectar:', error);
                    alert('Falha ao desconectar: ' + error.message);
                });
        }

        // Função para copiar a lista de compras
        function copiarListaCompras() {
            const itensParaComprar = materiais.filter(material => material.comprar);
            if (itensParaComprar.length === 0) {
                alert('Nenhum item marcado para compra.');
                return;
            }

            const itensPorCategoria = {};
            itensParaComprar.forEach(material => {
                if (!itensPorCategoria[material.categoria]) {
                    itensPorCategoria[material.categoria] = [];
                }
                itensPorCategoria[material.categoria].push(material);
            });

            const categoriasOrdenadas = Object.keys(itensPorCategoria).sort();
            const listaItens = categoriasOrdenadas.map(categoria => {
                const itens = itensPorCategoria[categoria]
                    .sort((a, b) => a.nome.localeCompare(b.nome))
                    .map(material => `${material.nome} (${material.quantidade})`)
                    .join('\n');
                return `${categorias[categoria] || categoria}\n${itens}`;
            }).join('\n\n');

            navigator.clipboard.writeText(listaItens)
                .then(() => {
                    alert('Lista de compras copiada com sucesso!\n\n' + listaItens);
                })
                .catch(error => {
                    console.error('Erro ao copiar a lista:', error);
                    alert('Falha ao copiar a lista: ' + error.message);
                });
        }

        // Função para limpar marcações de compra
        async function limparMarcacoes() {
            if (confirm('Deseja realmente limpar todas as marcações de compra?')) {
                const batch = db.batch();
                materiais.forEach(material => {
                    if (material.comprar) {
                        material.comprar = false;
                        const materialRef = db.collection('estoque').doc('materiais').collection('itens').doc(gerarIdMaterial(material.nome));
                        batch.update(materialRef, { comprar: false });
                    }
                });
                await batch.commit();
                await carregarDoServidor();
            }
        }

        // Adicionar Event Listeners
        document.getElementById('btnAbrirModal').addEventListener('click', abrirModal);
        document.getElementById('btnFecharModal').addEventListener('click', fecharModal);
        document.getElementById('btnFecharModalEditar').addEventListener('click', fecharModalEditar);
        document.getElementById('btnBuscar').addEventListener('click', buscarMateriais);
        document.getElementById('btnGerarRelatorio').addEventListener('click', gerarRelatorio);
        document.getElementById('btnExportarDados').addEventListener('click', exportarDados);
        document.getElementById('btnImportarDados').addEventListener('click', () => {
            document.getElementById('importInput').click();
        });
        document.getElementById('btnCopiarLista').addEventListener('click', copiarListaCompras);
        document.getElementById('btnLimparMarcacoes').addEventListener('click', limparMarcacoes);
        document.getElementById('btnLogout').addEventListener('click', logout);
        document.getElementById('importInput').addEventListener('change', importarDados);

        // Cadastro de novo material
        document.getElementById('materialForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const nome = document.getElementById('nome').value;
            if (materiais.some(material => material.nome.toLowerCase() === nome.toLowerCase())) {
                alert('Já existe um material com esse nome!');
                return;
            }
            const quantidade = parseInt(document.getElementById('quantidade').value);
            const quantidadeMinima = parseInt(document.getElementById('quantidadeMinima').value);
            const categoria = document.getElementById('categoria').value;
            const arquivo = document.getElementById('imagem').files[0];

            const material = {
                nome: nome,
                quantidade: quantidade,
                quantidadeMinima: quantidadeMinima,
                categoria: categoria,
                imagem: null,
                ultimaModificacao: new Date().toLocaleString('pt-BR'),
                comprar: false
            };

            if (arquivo) {
                try {
                    const dataURL = await converterParaDataURL(arquivo);
                    const tamanhoBytes = (dataURL.length * 3) / 4 - 2;
                    if (tamanhoBytes > 500000) {
                        alert('A imagem é muito grande! Use uma imagem menor (menos de 500 KB).');
                        return;
                    }
                    material.imagem = dataURL;
                } catch (error) {
                    console.error('Erro ao converter imagem:', error);
                    alert('Falha ao processar a imagem: ' + error.message);
                    return;
                }
            }

            materiais.push(material);
            await salvarMaterial(material);
            await carregarDoServidor();
            fecharModal();
        });

        // Editar material
        document.getElementById('editarForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const nome = document.getElementById('editNome').value;
            const novaCategoria = document.getElementById('editCategoria').value;
            const novaQuantidadeMinima = parseInt(document.getElementById('editQuantidadeMinima').value);
            const arquivo = document.getElementById('editImagem').files[0];

            const idx = materiais.findIndex(m => m.nome === nome);
            if (idx !== -1) {
                const material = { ...materiais[idx] };
                if (novaCategoria) material.categoria = novaCategoria;
                if (!isNaN(novaQuantidadeMinima)) material.quantidadeMinima = novaQuantidadeMinima;

                if (arquivo) {
                    try {
                        const dataURL = await converterParaDataURL(arquivo);
                        const tamanhoBytes = (dataURL.length * 3) / 4 - 2;
                        if (tamanhoBytes > 500000) {
                            alert('A imagem é muito grande! Use uma imagem menor (menos de 500 KB).');
                            return;
                        }
                        material.imagem = dataURL;
                    } catch (error) {
                        console.error('Erro ao converter imagem:', error);
                        alert('Falha ao processar a imagem: ' + error.message);
                        return;
                    }
                }

                material.ultimaModificacao = new Date().toLocaleString('pt-BR');
                materiais[idx] = material;
                await salvarMaterial(material);
                await carregarDoServidor();
                fecharModalEditar();
            }
        });

        // Alterar quantidade
        async function alterarQuantidade(nome, valor) {
            const idx = materiais.findIndex(m => m.nome === nome);
            if (materiais[idx].quantidade + valor >= 0) {
                materiais[idx].quantidade += valor;
                materiais[idx].ultimaModificacao = new Date().toLocaleString('pt-BR');
                await salvarMaterial(materiais[idx]);
                await carregarDoServidor();
            }
        }

        // Excluir material
        async function confirmarExclusao(nome) {
            if (confirm(`Deseja realmente excluir ${nome}?`)) {
                const materialId = gerarIdMaterial(nome);
                await db.collection('estoque').doc('materiais').collection('itens').doc(materialId).delete();
                materiais = materiais.filter(m => m.nome !== nome);
                await carregarDoServidor();
            }
        }

        // Marcar/desmarcar compra
        async function toggleComprar(nome) {
            const idx = materiais.findIndex(m => m.nome === nome);
            materiais[idx].comprar = !materiais[idx].comprar;
            await salvarMaterial(materiais[idx]);
            await carregarDoServidor();
        }

        // Buscar materiais
        function buscarMateriais() {
            const termo = document.getElementById('searchInput').value.toLowerCase();
            materiaisFiltrados = materiais.filter(material => 
                material.nome.toLowerCase().includes(termo)
            );
            atualizarLista();
        }

        // Gerar relatório CSV
        function gerarRelatorio() {
            const dados = materiais.map(material => ({
                Categoria: categorias[material.categoria] || material.categoria,
                Nome: material.nome,
                Quantidade: material.quantidade,
                "Quantidade Mínima": material.quantidadeMinima,
                "Comprar": material.comprar ? "Sim" : "Não",
                "Última Modificação": material.ultimaModificacao || 'N/A'
            }));

            const csvContent = [
                ["Categoria", "Nome", "Quantidade", "Quantidade Mínima", "Comprar", "Última Modificação"],
                ...dados.map(item => [item.Categoria, item.Nome, item.Quantidade, item["Quantidade Mínima"], item["Comprar"], item["Última Modificação"]])
            ].map(row => row.join(",")).join("\n");

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "relatorio_estoque.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Exportar dados
        function exportarDados() {
            const dados = JSON.stringify(materiais);
            const blob = new Blob([dados], { type: 'application/json' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "estoque_odontologico.json");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Importar dados
        async function importarDados() {
            const arquivo = document.getElementById('importInput').files[0];
            if (arquivo) {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        const dadosImportados = JSON.parse(e.target.result);
                        const batch = db.batch();
                        dadosImportados.forEach(material => {
                            const materialId = gerarIdMaterial(material.nome);
                            const materialRef = db.collection('estoque').doc('materiais').collection('itens').doc(materialId);
                            batch.set(materialRef, {
                                ...material,
                                ultimaModificacao: firebase.firestore.FieldValue.serverTimestamp()
                            });
                        });
                        await batch.commit();
                        await carregarDoServidor();
                        alert("Dados importados com sucesso!");
                    } catch (error) {
                        alert("Erro ao importar os dados: " + error.message);
                    }
                };
                reader.readAsText(arquivo);
            }
        }

        // Autenticação
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            auth.signInWithEmailAndPassword(email, password)
                .then(userCredential => {
                    console.log('Usuário autenticado:', userCredential.user);
                    document.getElementById('loginContainer').classList.add('hidden');
                    document.getElementById('mainContainer').classList.remove('hidden');
                    carregarDoServidor();
                })
                .catch(error => {
                    console.error('Erro ao autenticar:', error);
                    alert('Falha ao autenticar: ' + error.message);
                });
        });

        // Verificar estado de autenticação
        auth.onAuthStateChanged(user => {
            if (user) {
                console.log('Usuário já autenticado:', user);
                document.getElementById('loginContainer').classList.add('hidden');
                document.getElementById('mainContainer').classList.remove('hidden');
                carregarDoServidor();
            } else {
                console.log('Nenhum usuário autenticado.');
                document.getElementById('loginContainer').classList.remove('hidden');
                document.getElementById('mainContainer').classList.add('hidden');
            }
        });
    });
</script>
