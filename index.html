<!DOCTYPE html>
<html lang="pt-br">
>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Compras - Prime Dental</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        'primary-dark': '#8B456C',
                        'secondary-light': '#F0E6F0',
                        'background-light': '#FFFFFF',
                        'text-dark': '#333333',
                        'danger-red': '#CD5C5C'
                    }
                }
            }
        }
    </script>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>

<body class="bg-background-light font-sans min-h-screen p-4">

    <div id="loginContainer" class="bg-white p-8 rounded-xl shadow-lg w-full max-w-md mx-auto hidden">
        <h2 class="text-3xl font-bold text-center text-primary-dark mb-6">Login - Controle de Compras</h2>
        <form id="loginForm" class="space-y-4">
            <input type="email" id="email" placeholder="E-mail" required
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary-dark focus:border-primary-dark">
            <input type="password" id="password" placeholder="Senha" required
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary-dark focus:border-primary-dark">
            <button type="submit"
                class="w-full bg-primary-dark text-white py-2 rounded-lg hover:bg-opacity-90 transition">Entrar</button>
        </form>
    </div>

    <div id="mainContainer" class="container bg-white p-6 rounded-xl shadow-lg max-w-7xl hidden">
        <div class="flex flex-wrap items-center justify-center gap-3 mb-6 bg-secondary-light p-4 rounded-lg">
            <input id="searchInput" type="text" placeholder="Buscar item..."
                class="flex-1 min-w-[150px] px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary-dark">
            <button id="btnBuscar"
                class="bg-text-dark text-white py-2 px-4 rounded-lg hover:bg-opacity-90 transition">Buscar</button>
            <button id="btnListaCompras"
                class="bg-text-dark text-white py-2 px-4 rounded-lg hover:bg-opacity-90 transition">Lista de Compras</button>
            <button id="btnGerarRelatorio"
                class="bg-primary-dark text-white py-2 px-4 rounded-lg hover:bg-opacity-90 transition">Gerar Relatório</button>
            <button id="btnLogout"
                class="bg-danger-red text-white py-2 px-4 rounded-lg hover:bg-red-700 transition">Sair</button>
        </div>

        <div id="materialList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCDxJW_o6y-hmisQHOHVYPVJ8cag6hrKv0",
            authDomain: "estoque-prime.firebaseapp.com",
            projectId: "estoque-prime",
            storageBucket: "estoque-prime.firebasestorage.app",
            messagingSenderId: "1092019247496",
            appId: "1:1092019247496:web:92076afda68ccbc23d823d",
            measurementId: "G-04D19CYTTQ"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        let materiais = [];
        const categorias = {
            biosseguranca: "Biossegurança",
            brocas: "Brocas",
            cirurgia: "Cirurgia",
            clinica_geral: "Clínica Geral",
            dentistica: "Dentística",
            endodontia: "Endodontia",
            instrumental: "Instrumental",
            material_limpeza: "Material de Limpeza",
            ortodontia: "Ortodontia",
            papelaria: "Papelaria",
            protese: "Prótese",
            implantodontia: "Implantodontia"
        };

        auth.onAuthStateChanged(user => {
            if (user) {
                document.getElementById("loginContainer").classList.add("hidden");
                document.getElementById("mainContainer").classList.remove("hidden");
                carregarMateriais();
            } else {
                document.getElementById("loginContainer").classList.remove("hidden");
                document.getElementById("mainContainer").classList.add("hidden");
            }
        });

        document.getElementById("loginForm").addEventListener("submit", e => {
            e.preventDefault();
            const email = email.value;
            const password = password.value;
            auth.signInWithEmailAndPassword(email, password);
        });

        async function carregarMateriais() {
            const snapshot = await db.collection("materiais").get();
            materiais = snapshot.docs.map(doc => doc.data());
            atualizarLista(materiais);
        }

        function atualizarLista(materiais) {
            const lista = document.getElementById("materialList");
            lista.innerHTML = "";
            materiais.sort((a, b) => a.nome.localeCompare(b.nome)).forEach(m => {
                const card = document.createElement("div");
                card.className = "bg-white rounded-lg shadow-md p-4 flex flex-col items-center";

                const img = document.createElement("img");
                img.src = m.imagem || "https://placehold.co/300x300/BFBFBF/585856?text=Sem+Imagem";
                img.className = "w-32 h-32 object-contain mb-3";

                const nome = document.createElement("h3");
                nome.textContent = m.nome;
                nome.className = "text-lg font-semibold text-text-dark text-center";

                const categoria = document.createElement("p");
                categoria.textContent = `Categoria: ${categorias[m.categoria] || m.categoria}`;
                categoria.className = "text-sm text-gray-600 mb-2";

                const detalhes = document.createElement("div");
                detalhes.className = "text-sm text-gray-700 text-left w-full space-y-1";
                detalhes.innerHTML = `
                    <p>Quantidade: <strong>${m.quantidade ?? '-'}</strong></p>
                    <p>Última compra: <strong>${m.ultimaCompra ?? '-'}</strong></p>
                    <p>Preço de compra: <strong>${m.precoCompra ? 'R$ ' + m.precoCompra.toFixed(2) : '-'}</strong></p>
                    <p>Validade mais próxima: <strong>${m.validadeProxima ?? '-'}</strong></p>
                    <p>Lista de compra: <strong>${m.dataMarcadoCompra ? formatarData(m.dataMarcadoCompra) : ''}</strong></p>
                `;

                const btnCompra = document.createElement("button");
                btnCompra.textContent = m.comprar ? "Na Lista de Compras" : "Adicionar à Lista";
                btnCompra.className = `w-full py-2 mt-3 rounded-lg font-semibold transition ${m.comprar ? "bg-green-600 text-white" : "bg-primary-dark text-white hover:bg-opacity-90"}`;
                btnCompra.onclick = () => toggleListaCompra(m.nome);

                card.append(img, nome, categoria, detalhes, btnCompra);
                lista.appendChild(card);
            });
        }

        function formatarData(dataISO) {
            const data = new Date(dataISO);
            return data.toLocaleDateString("pt-BR");
        }

        async function toggleListaCompra(nome) {
            const docRef = db.collection("materiais").doc(nome);
            const docSnap = await docRef.get();
            if (!docSnap.exists) return;

            const m = docSnap.data();
            const novoStatus = !m.comprar;
            const dataMarcadoCompra = novoStatus ? new Date().toISOString() : null;

            await docRef.update({
                comprar: novoStatus,
                dataMarcadoCompra: dataMarcadoCompra
            });
            carregarMateriais();
        }

        document.getElementById("btnBuscar").addEventListener("click", async () => {
            const termo = document.getElementById("searchInput").value.toLowerCase();
            const filtrados = materiais.filter(m => m.nome.toLowerCase().includes(termo));
            atualizarLista(filtrados);
        });

        document.getElementById("btnListaCompras").addEventListener("click", async () => {
            const filtrados = materiais.filter(m => m.comprar);
            atualizarLista(filtrados);
        });

        document.getElementById("btnLogout").addEventListener("click", () => auth.signOut());

        // GERAR RELATÓRIO COMPLETO
        document.getElementById("btnGerarRelatorio").addEventListener("click", async () => {
            const snapshot = await db.collection("materiais").get();
            const dados = [];

            for (const doc of snapshot.docs) {
                const mat = doc.data();
                let ultimaCompraData = mat.ultimaCompra || "-";
                let preco = mat.precoCompra ? "R$ " + mat.precoCompra.toFixed(2) : "-";
                let validade = mat.validadeProxima || "-";
                let loja = mat.lojaUltima || "-";
                let nota = mat.notaUltima || "-";
                let dataLista = mat.dataMarcadoCompra ? formatarData(mat.dataMarcadoCompra) : "";

                dados.push({
                    Nome: mat.nome,
                    Categoria: categorias[mat.categoria] || mat.categoria,
                    Quantidade: mat.quantidade ?? "-",
                    "Última Compra": ultimaCompraData,
                    "Preço de Compra": preco,
                    "Validade": validade,
                    "Loja": loja,
                    "Nota Fiscal": nota,
                    "Lista de Compra": dataLista
                });
            }

            const ws = XLSX.utils.json_to_sheet(dados);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Relatorio Compras");
            XLSX.writeFile(wb, "Relatorio_Compras_PrimeDental.xlsx");
        });
    </script>
</body>
</html>
