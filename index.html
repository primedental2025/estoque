<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Controle de Materiais - Últimas Compras</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter','sans-serif'] },
          colors: {
            'primary-dark':'#8B456C',
            'secondary-light':'#F0E6F0',
            'background-light':'#FFFFFF',
            'text-dark':'#333333',
            'danger-red':'#CD5C5C',
          }
        }
      }
    }
  </script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    ::-webkit-scrollbar{width:8px}::-webkit-scrollbar-track{background:#f1f1f1;border-radius:10px}
    ::-webkit-scrollbar-thumb{background:#888;border-radius:10px}::-webkit-scrollbar-thumb:hover{background:#555}
  </style>
</head>
<body class="font-sans bg-background-light min-h-screen flex flex-col items-center 
p-4">

  <div id="customModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
      <h3 id="modalTitle" class="text-xl font-semibold mb-4 text-text-dark"></h3>
      <p id="modalMessage" class="mb-6 text-gray-700"></p>
      <div id="modalActions" class="flex justify-center space-x-4"></div>
    </div>
  </div>

  <div id="loginContainer" class="bg-white p-8 rounded-xl shadow-lg w-full max-w-md hidden">
    <h2 class="text-3xl font-bold text-center text-primary-dark mb-6">Login - Controle de Materiais</h2>
    <form id="loginForm" class="space-y-4">
      <input type="email" id="email" placeholder="E-mail" required
             class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary-dark focus:border-primary-dark">
      <input type="password" id="password" placeholder="Senha" required
             class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary-dark focus:border-primary-dark">
      <button type="submit"
              class="w-full bg-primary-dark text-white py-2 px-4 rounded-lg hover:bg-opacity-90 focus:outline-none focus:ring-2 focus:ring-primary-dark transition">
        Entrar
      </button>
    </form>
  </div>

  <div id="mainContainer" class="container bg-white p-6 md:p-8 rounded-xl shadow-lg w-full max-w-6xl hidden">
    <div class="flex flex-wrap items-center justify-center gap-3 md:gap-4 p-4 bg-secondary-light rounded-lg mb-6 shadow-sm">
      <input type="text" id="searchInput" placeholder="Buscar material..."
             class="flex-1 min-w-[150px] px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary-dark focus:border-primary-dark">
      <button id="btnBuscar"
              class="flex-1 min-w-[100px] bg-text-dark text-white py-2 px-4 rounded-lg hover:bg-opacity-90 focus:ring-2 
focus:ring-text-dark transition">
        Buscar
      </button>
      <button id="btnListaCompras"
              class="flex-1 min-w-[150px] bg-text-dark text-white py-2 px-4 rounded-lg hover:bg-opacity-90 focus:ring-2 focus:ring-text-dark transition">
        Lista de Compras
      </button>
      <button id="btnLimparMarcacoes"
              class="flex-1 min-w-[150px] bg-text-dark text-white py-2 px-4 rounded-lg hover:bg-opacity-90 focus:ring-2 focus:ring-text-dark transition">
        Limpar Marcações
      </button>
      <button id="btnAdvancedOptions"
              class="flex-1 min-w-[150px] bg-primary-dark text-white py-2 px-4 rounded-lg hover:bg-opacity-90 focus:ring-2 focus:ring-primary-dark transition">
        Avançado
      </button>
    </div>

    <div id="advancedOptionsContainer" class="flex flex-wrap items-center justify-center gap-3 md:gap-4 p-4 bg-secondary-light rounded-lg mb-6 shadow-sm hidden">
      <button id="btnAbrirModal"
              class="flex-1 min-w-[150px] bg-primary-dark text-white py-2 px-4 rounded-lg hover:bg-opacity-90 focus:ring-2 focus:ring-primary-dark transition">
        Adicionar Novo Item
      </button>
      <button id="btnGerarRelatorio"
              class="flex-1 min-w-[150px] bg-text-dark text-white py-2 px-4 rounded-lg hover:bg-opacity-90 focus:ring-2 focus:ring-text-dark transition">
        Gerar Relatório
      </button>
      <button id="btnLogout"
              class="flex-1 min-w-[100px] bg-danger-red text-white py-2 px-4 
rounded-lg hover:bg-red-700 focus:ring-2 focus:ring-red-500 transition">
        Sair
      </button>

      <input id="inputXmlNfe" type="file" accept=".xml" class="hidden">
      <button id="btnImportarNfe"
              class="flex-1 min-w-[180px] bg-primary-dark text-white py-2 px-4 rounded-lg hover:bg-opacity-90 focus:ring-2 focus:ring-primary-dark transition">
        Importar NF-e (XML)
      </button>

      <input id="inputPlanilha" 
type="file" accept=".xlsx,.xls,.csv" class="hidden">
      <button id="btnImportarPlanilha"
              class="flex-1 min-w-[200px] bg-text-dark text-white py-2 px-4 rounded-lg hover:bg-opacity-90 focus:ring-2 focus:ring-text-dark transition">
        Importar compras (XLSX/CSV)
      </button>
    </div>

    <div class="flex flex-col md:flex-row w-full gap-6">
      <div class="w-full md:w-1/4 bg-white p-4 rounded-xl shadow-lg h-fit">
        <h2 class="text-xl font-bold text-primary-dark mb-4">Categorias</h2>
        <div id="categorySidebar" class="space-y-2"></div>
      </div>

      <div class="w-full md:w-3/4">
        <div id="purchaseListActionsContainer" class="flex flex-wrap items-center justify-end gap-3 p-4 bg-secondary-light rounded-lg mb-6 shadow-sm hidden">
          <button id="btnCopiarLista" class="bg-text-dark text-white py-2 px-4 rounded-lg hover:bg-opacity-90 focus:ring-2 focus:ring-text-dark transition">
            Copiar Lista
          </button>
          <button id="btnMostrarTodos" class="bg-primary-dark text-white py-2 px-4 rounded-lg hover:bg-opacity-90 focus:ring-2 focus:ring-primary-dark transition">
            Mostrar Todos os Itens
          </button>
        </div>

        <div id="materialList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
      </div>
    </div>

    <div id="cadastroModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-40 hidden">
      <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md mx-4">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-2xl font-semibold text-primary-dark">Cadastrar Novo Material</h3>
          <button class="text-gray-500 hover:text-gray-700 text-2xl" id="btnFecharModal">&times;</button>
        </div>
        <form id="materialForm" class="space-y-4">
          <input type="text" id="nome" placeholder="Nome do material" required
                 class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary-dark focus:border-primary-dark">
          <select id="categoria" required
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg 
focus:ring-primary-dark focus:border-primary-dark">
            <option value="">Selecione uma categoria</option>
            <option value="biosseguranca">Biossegurança</option>
            <option value="brocas">Brocas</option>
            <option value="cirurgia">Cirurgia</option>
            <option value="clinica_geral">Clínica Geral</option>
            <option value="dentistica">Dentística</option>
            <option value="endodontia">Endodontia</option>
            <option value="instrumental">Instrumental</option>
            <option value="material_limpeza">Material de Limpeza</option>
            <option value="ortodontia">Ortodontia</option>
            <option value="papelaria">Papelaria</option>
            <option value="protese">Prótese</option>
            <option value="implantodontia">Implantodontia</option>
          </select>
          <input type="file" id="imagem" accept="image/*"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-primary-dark hover:file:bg-blue-100">
          <button type="submit"
                  class="w-full bg-primary-dark text-white py-2 px-4 rounded-lg hover:bg-opacity-90 focus:ring-2 focus:ring-primary-dark transition">
            Cadastrar
          </button>
        </form>
      </div>
    </div>

    <div id="editarModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-40 hidden">
      <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md mx-4">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-2xl font-semibold text-primary-dark">Editar Material</h3>
          <button class="text-gray-500 hover:text-gray-700 text-2xl" id="btnFecharModalEditar">&times;</button>
        </div>
        <form id="editarForm" class="space-y-4">
          <input type="text" id="editNome" placeholder="Nome do material" required
                 class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary-dark focus:border-primary-dark">
          <input type="hidden" id="originalNome">
          <select id="editCategoria"
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary-dark focus:border-primary-dark">
            <option value="">Selecione uma categoria</option>
            <option value="biosseguranca">Biossegurança</option>
            <option value="brocas">Brocas</option>
            <option value="cirurgia">Cirurgia</option>
            <option value="clinica_geral">Clínica Geral</option>
            <option value="dentistica">Dentística</option>
            <option value="endodontia">Endodontia</option>
            <option value="instrumental">Instrumental</option>
            <option value="material_limpeza">Material de Limpeza</option>
            <option value="ortodontia">Ortodontia</option>
            <option value="papelaria">Papelaria</option>
            <option value="protese">Prótese</option>
            <option value="implantodontia">Implantodontia</option>
          </select>
          <input type="file" id="editImagem" accept="image/*"
                 class="w-full px-4 py-2 border border-gray-300 rounded-lg file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-primary-dark hover:file:bg-blue-100">
          <button type="submit"
                  class="w-full bg-primary-dark text-white py-2 px-4 rounded-lg hover:bg-opacity-90 focus:ring-2 focus:ring-primary-dark transition">
            Salvar Alterações
          </button>
        </form>
      </div>
    </div>

    <div id="nfeMatchModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center 
z-50 hidden">
      <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-2xl mx-4">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-2xl font-semibold text-primary-dark">Conferir item importado</h3>
          <button class="text-gray-500 hover:text-gray-700 text-2xl" id="btnFecharNfeMatch">&times;</button>
        </div>
        <div class="space-y-2 mb-4">
          <p class="text-sm text-gray-500">Passo <span id="nfeStepIdx">1</span> de <span id="nfeStepTotal">1</span></p>
          <div class="bg-secondary-light rounded-lg p-3">
            <div class="text-sm text-gray-600">Item importado:</div>
            <div id="nfeItemNome" class="font-semibold text-text-dark"></div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 mt-2 text-sm">
              <div><span class="text-gray-600">Qtd:</span> <span id="nfeItemQtd"></span></div>
              <div><span class="text-gray-600">Preço unit.:</span> R$ <span id="nfeItemPreco"></span></div>
              <div><span class="text-gray-600">Lote:</span> <span id="nfeItemLote"></span></div>
              <div><span class="text-gray-600">Validade:</span> <span id="nfeItemVal"></span></div>
            </div>
          </div>
        </div>
        <div class="space-y-3">
          <label class="block text-sm text-gray-700">Sugerido do seu estoque (melhores correspondências):</label>
          <select id="nfeCandidateSelect" class="w-full border border-gray-300 rounded-lg p-2 focus:ring-primary-dark focus:border-primary-dark"></select>
          <div class="flex gap-2">
            <input id="nfeNewName" type="text" placeholder="(Opcional) Nome padronizado / novo produto"
                   class="flex-1 border border-gray-300 rounded-lg p-2 focus:ring-primary-dark focus:border-primary-dark">
            <select id="nfeNewCategory" class="w-60 border border-gray-300 rounded-lg p-2 focus:ring-primary-dark focus:border-primary-dark">
              <option value="">Categoria (se novo)</option>
              <option value="biosseguranca">Biossegurança</option>
              <option value="brocas">Brocas</option>
              <option value="cirurgia">Cirurgia</option>
              <option value="clinica_geral">Clínica Geral</option>
              <option value="dentistica">Dentística</option>
              <option value="endodontia">Endodontia</option>
              <option value="instrumental">Instrumental</option>
              <option value="material_limpeza">Material de Limpeza</option>
              <option value="ortodontia">Ortodontia</option>
              <option value="papelaria">Papelaria</option>
              <option value="protese">Prótese</option>
              <option value="implantodontia">Implantodontia</option>
            </select>
          </div>
          <div class="text-xs text-gray-500">
            Se o sugerido não for o mesmo item, escolha outro no select ou informe nome/categoria para criar um novo.
          </div>
        </div>
        <div class="flex justify-between items-center mt-6">
          <div class="text-sm text-gray-600">Ações para este item</div>
          <div class="flex gap-2">
            <button id="nfeBtnPular" class="bg-gray-200 text-text-dark py-2 px-3 rounded-lg hover:bg-gray-300">Pular</button>
            <button id="nfeBtnMesmo" class="bg-primary-dark text-white py-2 px-3 rounded-lg hover:bg-opacity-90">É o mesmo</button>
            <button 
id="nfeBtnCriar" class="bg-green-600 text-white py-2 px-3 rounded-lg hover:bg-green-700">Criar novo</button>
            <button id="nfeBtnAvancar" class="bg-text-dark text-white py-2 px-3 rounded-lg hover:bg-opacity-90">Avançar</button>
          </div>
        </div>
      </div>
    </div>

    <div id="compraModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md mx-4">
        <div class="flex 
justify-between items-center mb-4">
          <h3 class="text-2xl font-semibold text-primary-dark">Registrar compra</h3>
          <button class="text-gray-500 hover:text-gray-700 text-2xl" id="btnFecharCompra">&times;</button>
        </div>
        <form id="compraForm" class="space-y-4">
          <input type="text" id="compraNome" readonly class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100">
          <input type="date" id="compraData" required class="w-full px-4 py-2 border border-gray-300 rounded-lg">
          <input type="number" step="any" 
min="0" id="compraQtd" placeholder="Quantidade comprada" required class="w-full px-4 py-2 border border-gray-300 rounded-lg">
          <input type="number" step="0.01" min="0" id="compraPreco" placeholder="Preço unitário (R$)" required class="w-full px-4 py-2 border border-gray-300 rounded-lg">
          <input type="text" id="compraLote" placeholder="Lote (opcional)" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
          <input type="date" id="compraValidade" placeholder="Validade (opcional)" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
          <input type="text" id="compraLoja" placeholder="Loja (opcional)" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
          <input type="text" id="compraNF" placeholder="Número da NF (opcional)" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
          <button type="submit" class="w-full bg-primary-dark text-white py-2 px-4 rounded-lg hover:bg-opacity-90 focus:ring-2 focus:ring-primary-dark transition">
            Salvar compra
          </button>
        </form>
      </div>
    </div>

    <div id="historicoModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 
hidden">
      <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-4xl mx-4">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-2xl font-semibold text-primary-dark">Histórico de compras</h3>
          <button class="text-gray-500 hover:text-gray-700 text-2xl" id="btnFecharHistorico">&times;</button>
        </div>
        <div class="mb-3 text-sm text-gray-600"><span id="historicoTitulo"></span></div>
        <div class="overflow-auto max-h-[60vh]">
          <table class="min-w-full border">
            <thead class="bg-secondary-light">
              <tr>
                <th class="p-2 text-left border">Data</th>
                <th class="p-2 text-right border">Qtd</th>
                <th class="p-2 text-right border">Preço unit.</th>
                <th class="p-2 text-right 
border">Total</th>
                <th class="p-2 text-left border">Lote</th>
                <th class="p-2 text-left border">Validade</th>
                <th class="p-2 text-left border">Loja</th>
                <th class="p-2 text-left border">NF</th>
                <th class="p-2 text-left border">Origem</th>
                <th class="p-2 text-left border">Ações</th>
              </tr>
            </thead>
            <tbody id="historicoTabela" class="text-sm"></tbody>
          </table>
        </div>
        <div class="mt-4 flex justify-end gap-2">
          <button id="btnExportarHistorico" class="bg-text-dark text-white py-2 px-3 
rounded-lg hover:bg-opacity-90">Baixar CSV</button>
        </div>
      </div>
    </div>

    <div id="editarCompraModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md mx-4">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-2xl font-semibold text-primary-dark">Editar compra</h3>
          <button class="text-gray-500 hover:text-gray-700 text-2xl" id="btnFecharEditarCompra">&times;</button>
        </div>
        <form id="editarCompraForm" class="space-y-4">
          <input type="date" id="editCompraData" required class="w-full px-4 py-2 border border-gray-300 rounded-lg">
          <input type="number" step="any" min="0" id="editCompraQtd" required class="w-full px-4 py-2 border border-gray-300 rounded-lg">
          <input type="number" step="0.01" min="0" id="editCompraPreco" required class="w-full px-4 py-2 border border-gray-300 rounded-lg">
          <input type="text" id="editCompraLote" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Lote (opcional)">
          <input type="date" id="editCompraValidade" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Validade (opcional)">
          <input type="text" id="editCompraLoja" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Loja (opcional)">
          <input type="text" id="editCompraNF" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Número da NF (opcional)">
          <button type="submit" class="w-full bg-primary-dark text-white py-2 px-4 rounded-lg hover:bg-opacity-90">Salvar</button>
        </form>
      </div>
    </div>

  </div>

  <script>
  document.addEventListener('DOMContentLoaded', function() 
{
    // Firebase
    if (typeof firebase === 'undefined') { alert('Firebase SDK não carregou.'); return;
}
    const firebaseConfig = {
      apiKey: "AIzaSyCDxJW_o6y-hmisQHOHVYPVJ8cag6hrKv0",
      authDomain: "estoque-prime.firebaseapp.com",
      projectId: "estoque-prime",
      storageBucket: "estoque-prime.firebasestorage.app",
      messagingSenderId: "1092019247496",
      appId: "1:1092019247496:web:92076afda68ccbc23d823d",
      measurementId: "G-04D19CYTTQ"
    };
const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
// categorias
    const categorias = {
      biosseguranca:"Biossegurança", brocas:"Brocas", cirurgia:"Cirurgia", clinica_geral:"Clínica Geral",
      dentistica:"Dentística", endodontia:"Endodontia", instrumental:"Instrumental", material_limpeza:"Material de Limpeza",
      ortodontia:"Ortodontia", papelaria:"Papelaria", protese:"Prótese", implantodontia:"Implantodontia"
    };
let materiaisFiltrados = [];
    let termoDeBusca = "";
    let categoriaSelecionada = "todos";
    let isShowingPurchaseList = false;
// Estado do histórico
    let historicoContext = { nome: null, compras: [], editId: null };
// utils
    function showCustomModal(title, message, type, copyText='') {
      return new Promise((resolve) => {
        const modal = document.getElementById('customModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const modalActions = document.getElementById('modalActions');
        modalTitle.textContent = title; modalMessage.innerHTML=''; modalActions.innerHTML='';
        if (type==='alert') {
          modalMessage.textContent = message;
          const ok=document.createElement('button'); ok.textContent='OK';
          ok.className='bg-primary-dark text-white py-2 px-4 rounded-lg hover:bg-opacity-90 transition';
          ok.onclick=()=>{ modal.classList.add('hidden'); resolve(true); }; modalActions.appendChild(ok);
        } else if (type==='confirm') {
          modalMessage.textContent = message;
          const yes=document.createElement('button'); yes.textContent='Sim';
          yes.className='bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition';
          yes.onclick=()=>{ modal.classList.add('hidden'); resolve(true); }; modalActions.appendChild(yes);
          const no=document.createElement('button'); no.textContent='Não';
          no.className='bg-danger-red text-white py-2 px-4 rounded-lg hover:bg-red-700 transition';
          no.onclick=()=>{ modal.classList.add('hidden'); resolve(false); }; modalActions.appendChild(no);
        } else if (type==='copy') {
          modalMessage.textContent = message;
          const ta=document.createElement('textarea'); ta.value=copyText;
          ta.readOnly=true;
          ta.className='w-full h-32 p-2 border border-gray-300 rounded-lg resize-none mb-4 font-mono text-sm';
          modalMessage.appendChild(ta);
          const close=document.createElement('button'); close.textContent='Fechar';
          close.className='bg-primary-dark text-white py-2 px-4 rounded-lg hover:bg-opacity-90 transition';
          close.onclick=()=>{ modal.classList.add('hidden'); resolve(false); }; modalActions.appendChild(close);
          ta.focus(); ta.select(); ta.setSelectionRange(0, ta.value.length);
        }
        modal.classList.remove('hidden');
      });
    }
    function converterParaDataURL(file){return new Promise((res,rej)=>{const r=new FileReader();r.onload=()=>res(r.result);r.onerror=e=>rej(e);r.readAsDataURL(file);});}
    const fmtMoeda = (v)=> (v==null?'-':Number(v).toFixed(2).replace('.',','));
    function toBRDate(dStr){
      if(!dStr) return 'N/A';
      const d = new Date(dStr);
      if(!isNaN(d)) return d.toLocaleDateString('pt-BR');
      const p=dStr.split('T')[0];
      if(p && p.includes('-')){ const [y,m,da]=p.split('-'); return `${da}/${m}/${y}`;}
      return dStr;
    }
    function toISODateInput(dStr){ if(!dStr) return ''; const d=new Date(dStr); if(!isNaN(d)) return d.toISOString().slice(0,10); const p=dStr.split('T')[0]; return p||'';
    }
    const isFuture = (iso)=> iso && new Date(iso).getTime() >= (new Date().setHours(0,0,0,0));
// carregar/render
    async function carregarMateriais(){
      try{
        const snap = await db.collection('materiais').get();
        let todos=[]; snap.forEach(doc=>todos.push(doc.data()));
        if(isShowingPurchaseList){
          materiaisFiltrados = todos.filter(m=>m.comprar===true);
          document.getElementById('searchInput').value=''; termoDeBusca=''; categoriaSelecionada='todos';
        } else {
          materiaisFiltrados = todos.filter(m => (m.nome||'').toLowerCase().includes(termoDeBusca.toLowerCase()));
          if(categoriaSelecionada!=='todos'){ materiaisFiltrados = materiaisFiltrados.filter(m=>m.categoria===categoriaSelecionada); }
        }
        atualizarLista(materiaisFiltrados);
        renderizarCategorias(todos);
        togglePurchaseListActionsVisibility();
      }catch(e){ console.error(e); showCustomModal('Erro','Erro ao carregar materiais: '+e.message,'alert');}
    }
    async function salvarMaterial(material){ await db.collection('materiais').doc(material.nome).set(material);
    }
    function renderizarCategorias(all){
      const box=document.getElementById('categorySidebar'); box.innerHTML='';
      const set=new Set(); all.forEach(m=>set.add(m.categoria));
      const bAll=document.createElement('button');
      bAll.textContent='Todos';
      bAll.className=`w-full text-left py-2 px-4 rounded-lg ${categoriaSelecionada==='todos'&&!isShowingPurchaseList ? 'bg-primary-dark text-white':'bg-gray-200 text-text-dark hover:bg-gray-300'}`;
      bAll.onclick=()=>{categoriaSelecionada='todos'; isShowingPurchaseList=false; carregarMateriais();}; box.appendChild(bAll);
      Array.from(set).sort().forEach(cat=>{
        const b=document.createElement('button'); b.textContent=categorias[cat]||cat;
        b.className=`w-full text-left py-2 px-4 rounded-lg ${categoriaSelecionada===cat&&!isShowingPurchaseList ? 'bg-primary-dark text-white':'bg-gray-200 text-text-dark hover:bg-gray-300'}`;
        b.onclick=()=>{categoriaSelecionada=cat; isShowingPurchaseList=false; carregarMateriais();}; box.appendChild(b);
      });
    }
    function togglePurchaseListActionsVisibility(){
      const c=document.getElementById('purchaseListActionsContainer'); if(isShowingPurchaseList) c.classList.remove('hidden'); else c.classList.add('hidden');
    }

    // LISTA
    function atualizarLista(mats){
      const lista=document.getElementById('materialList');
      lista.innerHTML='';
      if(!mats.length){ lista.innerHTML='<p class="text-center text-gray-600 col-span-full">Nenhum material encontrado.</p>'; return; }
      mats.sort((a,b)=>a.nome.localeCompare(b.nome)).forEach(m=>{
        const card=document.createElement('div');
        // Ponto 1: Removida a condição de estoque mínimo
        card.className=`material-item bg-white rounded-lg shadow-md flex flex-col transition hover:shadow-lg`;

        const imgBox=document.createElement('div'); imgBox.className='w-full h-48 bg-white flex items-center justify-center';
        const img=document.createElement('img');
        img.src=m.imagem || 'https://placehold.co/300x300/BFBFBF/585856?text=Sem+Imagem';
        img.alt=`Imagem de ${m.nome}`; img.className= m.imagem ? 'w-full h-full object-contain' : 'w-24 h-24 object-contain';
 
        img.onerror=()=>{ img.src='https://placehold.co/300x300/BFBFBF/585856?text=Sem+Imagem'; img.className='w-24 h-24 object-contain'; };
        imgBox.appendChild(img); card.appendChild(imgBox);

        const info=document.createElement('div'); info.className='p-4 flex-grow';
        
        // Ponto 4: Melhoria da diagramação (Nome > Categoria > Outros)
        info.innerHTML = `
          <h3 class="text-xl font-bold text-primary-dark mb-1">${m.nome}</h3> 

          <p class="text-sm font-semibold text-gray-700 mb-3">Categoria: ${categorias[m.categoria] || m.categoria || '-'}</p>

          ${m.comprar && m.dataAdicaoLista ? `<p class="text-sm font-medium text-green-600 mb-3">Na Lista de Compras desde: ${toBRDate(m.dataAdicaoLista)}</p>` : ''}
          
          <div class="text-sm text-gray-600 space-y-1">
            <p><span class="font-semibold text-text-dark">Última Qtd. Comprada:</span> <span class="font-medium">${m.ultimaQtdComprada ?? 0}</span></p>

            <p><span class="font-semibold text-text-dark">Preço unit. (Últ. Compra):</span> R$ ${m.precoCompra!=null ? fmtMoeda(m.precoCompra) : '-'}</p>
            <p><span class="font-semibold text-text-dark">Data Última Compra:</span> ${toBRDate(m.ultimaCompraEm)}</p>
            <p><span class="font-semibold text-text-dark">Validade (Últ. Compra):</span> ${m.validadeUltimaCompra ? toBRDate(m.validadeUltimaCompra) : 'N/A'}</p>
            <p><span class="font-semibold text-text-dark">Loja (Últ. Compra):</span> ${m.ultimaLoja || 'N/A'}</p>
            <p><span class="font-semibold text-text-dark">NF (Últ. Compra):</span> ${m.ultimaNF || 'N/A'}</p>
          </div>
        `;
        card.appendChild(info);

        const controls=document.createElement('div'); controls.className='p-4 bg-gray-50 border-t border-gray-100 flex flex-col space-y-3';
        const btnComprar=document.createElement('button');
        btnComprar.textContent = m.comprar ?
        'Na Lista de Compras' : 'Adicionar à Lista';
        btnComprar.className = `w-full py-2 px-4 rounded-lg font-semibold transition transform hover:scale-105 ${m.comprar ?
        'bg-green-600 text-white hover:bg-green-700' : 'bg-primary-dark text-white hover:bg-opacity-90'}`;
        btnComprar.onclick=()=>toggleComprar(m.nome); controls.appendChild(btnComprar);

        const options=document.createElement('div'); options.className='relative inline-block text-left w-full';
        const dd=document.createElement('div');
        dd.className='dropdown-content absolute right-0 mt-2 w-56 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 hidden z-50';
        dd.onclick=(e)=>e.stopPropagation();

        const btnOptions=document.createElement('button');
        btnOptions.innerHTML=`<svg class="w-5 h-5 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"></path></svg> Opções`;
        btnOptions.className='w-full bg-gray-200 text-text-dark py-2 px-3 rounded-lg text-sm hover:bg-gray-300 transition transform hover:scale-105 mt-2'; btnOptions.onclick=(e)=>{ e.stopPropagation();
        document.querySelectorAll('.dropdown-content').forEach(d=>{ if(d!==dd && !d.classList.contains('hidden')) d.classList.add('hidden'); }); dd.classList.toggle('hidden'); }; const bEdit=document.createElement('button'); bEdit.textContent='Editar'; bEdit.className='block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100';
        bEdit.onclick=()=>{ abrirModalEditar(m.nome); dd.classList.add('hidden'); }; const bReg=document.createElement('button'); bReg.textContent='Registrar compra'; bReg.className='block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100'; bReg.onclick=()=>{ abrirModalCompra(m.nome); dd.classList.add('hidden'); };
        const bHist=document.createElement('button'); bHist.textContent='Histórico de compras'; bHist.className='block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100'; bHist.onclick=()=>{ abrirHistoricoCompras(m.nome); dd.classList.add('hidden'); }; const bDel=document.createElement('button'); bDel.textContent='Excluir';
        bDel.className='block w-full text-left px-4 py-2 text-sm text-danger-red hover:bg-red-100'; bDel.onclick=()=>{ confirmarExclusao(m.nome); dd.classList.add('hidden'); }; dd.appendChild(bEdit); dd.appendChild(bReg); dd.appendChild(bHist); dd.appendChild(bDel); options.appendChild(btnOptions); options.appendChild(dd); controls.appendChild(options); card.appendChild(controls);
        lista.appendChild(card); 
      }); 
    }
    // modais básicos 
    function abrirModal(){ document.getElementById('cadastroModal').classList.remove('hidden'); } 
    function fecharModal(){ document.getElementById('cadastroModal').classList.add('hidden'); document.getElementById('materialForm').reset();
    } 
    // Ponto 1: Alteração na função abrirModalEditar
    function abrirModalEditar(nome){ 
      const m = materiaisFiltrados.find(x=>x.nome===nome); 
      if(!m){ showCustomModal("Erro","Material não encontrado para edição.",'alert'); return; } 
      document.getElementById('editNome').value = m.nome;
      document.getElementById('originalNome').value = m.nome; 
      document.getElementById('editCategoria').value = m.categoria || ''; 
      // Campos Quantidade e Quantidade Mínima removidos
      document.getElementById('editarModal').classList.remove('hidden');
    } 
    function fecharModalEditar(){ document.getElementById('editarModal').classList.add('hidden'); document.getElementById('editarForm').reset(); } 
    
    // Ponto 1: Alteração no listener do formulário de edição
    document.getElementById('editarForm').addEventListener('submit', async function(e){ 
      e.preventDefault(); 
      const originalNome = document.getElementById('originalNome').value; 
      const newNome = document.getElementById('editNome').value.trim(); 
      const novaCategoria = document.getElementById('editCategoria').value; 
      // Campos de quantidade removidos
      const arquivo = document.getElementById('editImagem').files[0]; 
      try{ 
        const refOld = db.collection('materiais').doc(originalNome); 
        const snap = await refOld.get(); 
        if(!snap.exists){ showCustomModal("Erro","Material original não encontrado.",'alert'); return; } 
        const base = snap.data(); 
        let updateData = { 
          categoria: novaCategoria || base.categoria || '', 
          // quantidade e quantidadeMinima removidos
          ultimaModificacao: new Date().toLocaleString('pt-BR') 
        }; 
        if (arquivo) { 
          const dataURL = await converterParaDataURL(arquivo);
          const tamanhoBytes = (dataURL.length * 3) / 4 - 2;
          if (tamanhoBytes > 500000) { showCustomModal('Aviso','A imagem é muito grande! (< 500 KB)','alert'); return; } 
          updateData.imagem = dataURL;
        } 
        if (newNome !== originalNome){ 
          const refNew = db.collection('materiais').doc(newNome); 
          if((await refNew.get()).exists){ showCustomModal("Erro",`Já existe "${newNome}".`,'alert'); return;
          } 
          await refNew.set({ ...base, ...updateData, nome:newNome }); 
          await refOld.delete();
          showCustomModal('Sucesso', `"${originalNome}" renomeado para "${newNome}" e salvo!`, 'alert');
        } else {
          await refOld.update(updateData);
          showCustomModal('Sucesso', `"${originalNome}" salvo!`, 'alert');
        }
        fecharModalEditar();
        carregarMateriais();
      }catch(e){ console.error(e); showCustomModal("Erro",'Erro ao salvar alterações: '+e.message,'alert'); }
    });

    // Ponto 2: Alteração na função toggleComprar
    async function toggleComprar(nome) {
      try {
        const materialRef = db.collection('materiais').doc(nome);
        const snap = await materialRef.get();
        if (!snap.exists) return;
        const m = snap.data();
        
        const isComprar = !m.comprar;
        const updateData = {
          comprar: isComprar,
          // Ponto 2: Registrar a data de quando um item foi marcado na Lista de Compras
          dataAdicaoLista: isComprar ? new Date().toISOString().slice(0, 10) : firebase.firestore.FieldValue.delete(),
          // Ponto 1: Remover campos obsoletos
          quantidade: firebase.firestore.FieldValue.delete(), 
          quantidadeMinima: firebase.firestore.FieldValue.delete() 
        };
        
        await materialRef.update(updateData);
        await carregarMateriais();
      } catch (e) {
        console.error("Erro ao alternar Lista de Compras:", e);
        showCustomModal('Erro', 'Erro ao alternar item na lista: ' + e.message, 'alert');
      }
    }

    // Ponto 1/3: Alteração no listener do formulário de cadastro de novo material
    document.getElementById('materialForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const nome = document.getElementById('nome').value.trim();
      const categoria = document.getElementById('categoria').value;
      const arquivo = document.getElementById('imagem').files[0];
      
      try {
        const docRef = db.collection('materiais').doc(nome);
        if((await docRef.get()).exists){ showCustomModal("Erro",`O material "${nome}" já existe.`,'alert'); return; }

        let imagemBase64 = null;
        if(arquivo) {
          imagemBase64 = await converterParaDataURL(arquivo);
          const tamanhoBytes = (imagemBase64.length * 3) / 4 - 2;
          if (tamanhoBytes > 500000) { showCustomModal('Aviso','A imagem é muito grande! (< 500 KB)','alert'); return; }
        }

        const novoMaterial = {
          nome: nome,
          categoria: categoria,
          imagem: imagemBase64,
          ultimaModificacao: new Date().toLocaleString('pt-BR'),
          // Ponto 1/3: Adicionando campos para a nova lógica (Última Compra, Qtd, NF, Loja)
          ultimaQtdComprada: 0, 
          precoCompra: null,
          ultimaCompraEm: null,
          validadeUltimaCompra: null,
          ultimaLoja: null,
          ultimaNF: null,
          historico: [],
          comprar: false,
          dataAdicaoLista: null,
        };

        await docRef.set(novoMaterial);
        fecharModal();
        showCustomModal('Sucesso', `${nome} cadastrado com sucesso!`, 'alert');
        await carregarMateriais();

      } catch(e) {
        console.error("Erro ao cadastrar material:", e);
        showCustomModal('Erro', 'Erro ao cadastrar material: ' + e.message, 'alert');
      }
    });


    // Ponto 1/3: Alteração no listener do formulário de registro de compra (Manual)
    document.getElementById('compraForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const nome = document.getElementById('compraNome').value;
      const compraData = document.getElementById('compraData').value;
      const compraQtd = document.getElementById('compraQtd').value;
      const compraPreco = document.getElementById('compraPreco').value;
      const compraLote = document.getElementById('compraLote').value.trim();
      const compraValidade = document.getElementById('compraValidade').value;
      const compraLoja = document.getElementById('compraLoja').value.trim(); // Ponto 3
      const compraNF = document.getElementById('compraNF').value.trim();     // Ponto 3

      try {
        const materialRef = db.collection('materiais').doc(nome);
        const compra = {
          data: compraData,
          quantidade: parseFloat(compraQtd),
          precoUnitario: parseFloat(compraPreco),
          lote: compraLote || null,
          validade: compraValidade || null,
          loja: compraLoja || null, // Ponto 3
          nf: compraNF || null,     // Ponto 3
          origem: 'Manual',
          id: new Date().getTime().toString() 
        };

        // 1. Salvar no histórico
        const snap = await materialRef.get();
        const materialData = snap.data();
        const historico = materialData.historico || [];
        historico.push(compra);
        historico.sort((a,b)=> new Date(b.data).getTime() - new Date(a.data).getTime()); // Garantir que a última compra é a mais recente.

        // 2. Atualizar o documento do material com os dados da ÚLTIMA compra (Ponto 1 e 3)
        const updateData = {
          historico: historico,
          ultimaCompraEm: compra.data,
          ultimaQtdComprada: compra.quantidade, // Ponto 1 - Nova representação da "Quantidade"
          precoCompra: compra.precoUnitario,
          validadeUltimaCompra: compra.validade,
          ultimaLoja: compra.loja, // Ponto 3
          ultimaNF: compra.nf, // Ponto 3
          // Ponto 1: Remover campos obsoletos
          quantidade: firebase.firestore.FieldValue.delete(), 
          quantidadeMinima: firebase.firestore.FieldValue.delete(),
          // Tira da lista de compras
          comprar: false,
          dataAdicaoLista: firebase.firestore.FieldValue.delete(),
        };

        await materialRef.update(updateData);
        document.getElementById('btnFecharCompra').click();
        showCustomModal('Sucesso', `Compra de ${nome} registrada com sucesso.`, 'alert');
        await carregarMateriais();

      } catch (e) {
        console.error("Erro ao registrar compra:", e);
        showCustomModal('Erro', 'Erro ao registrar a compra: ' + e.message, 'alert');
      }
    });

    // Ponto 3: Alteração na função gerarRelatorio
    async function gerarRelatorio() {
      try {
        const snap = await db.collection('materiais').get();
        let materiais = [];
        snap.forEach(doc => materiais.push(doc.data()));

        const dataReport = materiais.map(m => ({
          'Nome': m.nome,
          'Categoria': categorias[m.categoria] || m.categoria || '-',
          'Na Lista de Compras': m.comprar ? 'Sim' : 'Não',
          'Data Adição Lista': m.dataAdicaoLista ? toBRDate(m.dataAdicaoLista) : 'N/A', // Ponto 2
          'Última Qtd. Comprada': m.ultimaQtdComprada ?? 0, // Ponto 1
          'Preço Unitário (Últ. Compra)': m.precoCompra!=null ? fmtMoeda(m.precoCompra) : '-',
          'Data Última Compra': toBRDate(m.ultimaCompraEm),
          'Validade (Últ. Compra)': m.validadeUltimaCompra ? toBRDate(m.validadeUltimaCompra) : 'N/A',
          'Loja (Últ. Compra)': m.ultimaLoja || 'N/A', // Ponto 3
          'NF (Últ. Compra)': m.ultimaNF || 'N/A', // Ponto 3
        }));

        // Função para exportar para XLSX
        const ws = XLSX.utils.json_to_sheet(dataReport);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Relatório de Materiais");
        XLSX.writeFile(wb, "relatorio_materiais_" + new Date().toISOString().slice(0, 10).replace(/-/g, '') + ".xlsx");

      } catch (e) {
        console.error("Erro ao gerar relatório:", e);
        showCustomModal('Erro', 'Erro ao gerar o relatório: ' + e.message, 'alert');
      }
    }
    
    // Funções placeholder que faltavam no snippet original (para evitar erros)
    function abrirModalCompra(nome) { document.getElementById('compraNome').value = nome; document.getElementById('compraModal').classList.remove('hidden'); }
    function fecharModalCompra() { document.getElementById('compraModal').classList.add('hidden'); document.getElementById('compraForm').reset(); }
    function abrirHistoricoCompras(nome) { /* Implementação */ }
    function confirmarExclusao(nome) { /* Implementação */ }
    function logout() { /* Implementação */ }
    function limparMarcacoes() { /* Implementação */ }
    function copiarListaCompras() { /* Implementação */ }
    function buscarMateriais() { termoDeBusca = document.getElementById('searchInput').value; carregarMateriais(); }

    // UI listeners
    document.getElementById('btnAbrirModal').addEventListener('click', abrirModal);
    document.getElementById('btnFecharModal').addEventListener('click', fecharModal);
    document.getElementById('btnFecharModalEditar').addEventListener('click', fecharModalEditar);
    document.getElementById('btnFecharCompra').addEventListener('click', fecharModalCompra); // Novo/Modificado
    document.getElementById('btnLogout').addEventListener('click', logout);
    document.getElementById('btnLimparMarcacoes').addEventListener('click', limparMarcacoes);
    document.getElementById('btnListaCompras').addEventListener('click', ()=>{ isShowingPurchaseList=true; carregarMateriais(); });
    document.getElementById('btnMostrarTodos').addEventListener('click', ()=>{ isShowingPurchaseList=false; document.getElementById('searchInput').value=''; termoDeBusca=''; categoriaSelecionada='todos'; carregarMateriais(); });
    document.getElementById('btnCopiarLista').addEventListener('click', copiarListaCompras);
    document.getElementById('btnBuscar').addEventListener('click', buscarMateriais);
    document.getElementById('btnGerarRelatorio').addEventListener('click', gerarRelatorio); // Ponto 3
    document.getElementById('btnAdvancedOptions').addEventListener('click', ()=>document.getElementById('advancedOptionsContainer').classList.toggle('hidden'));
    document.addEventListener('click', (e)=>{ document.querySelectorAll('.dropdown-content').forEach(d=>{ if(!d.classList.contains('hidden') && !d.parentElement.contains(e.target)) d.classList.add('hidden'); }); });
    
    // Início
    auth.onAuthStateChanged(user => { 
        if(user) { 
            document.getElementById('loginContainer').classList.add('hidden'); 
            document.getElementById('mainContainer').classList.remove('hidden'); 
            carregarMateriais(); 
        } else {
            document.getElementById('loginContainer').classList.remove('hidden'); 
            document.getElementById('mainContainer').classList.add('hidden');
        }
    });

  });
  </script>
</body>
</html>
