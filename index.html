<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Estoque - Consultório Odontológico</title>
    <!-- Firebase SDK (versão compatível) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <style>
        /* O CSS permanece exatamente o mesmo que no código original */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f7fa;
            margin: 0;
            padding: 20px;
            color: #333;
        }
        /* ... resto do CSS idêntico ao original ... */
    </style>
</head>
<body>
    <!-- Formulário de Login -->
    <div id="loginContainer" class="login-container">
        <h2>Login - Controle de Estoque</h2>
        <form id="loginForm">
            <input type="email" id="email" placeholder="E-mail" required>
            <input type="password" id="password" placeholder="Senha" required>
            <button type="submit">Entrar</button>
        </form>
    </div>

    <!-- Interface Principal -->
    <div id="mainContainer" class="container hidden">
        <h1>Controle de Estoque Odontológico</h1>
        <div class="search-container">
            <button id="btnAbrirModal">Adicionar Novo Item</button>
            <input type="text" id="searchInput" placeholder="Buscar material...">
            <button id="btnBuscar">Buscar</button>
            <button id="btnGerarRelatorio">Gerar Relatório</button>
            <button id="btnExportarDados">Exportar</button>
            <button id="btnImportarDados">Importar</button>
            <button id="btnCopiarLista" class="copiar-lista-btn">Copiar Lista de Compras</button>
            <button id="btnLimparMarcacoes" class="limpar-marcacoes-btn">Limpar Marcações</button>
            <button id="btnLogout" class="logout-btn">Sair</button>
            <input type="file" id="importInput" accept=".json" style="display: none;">
        </div>

        <div id="cadastroModal" class="modal">
            <div class="modal-content">
                <button class="close-btn" id="btnFecharModal">X</button>
                <h3>Cadastrar Novo Material</h3>
                <form id="materialForm">
                    <input type="text" id="nome" placeholder="Nome do material" required>
                    <input type="number" id="quantidade" placeholder="Quantidade inicial" min="0" required>
                    <input type="number" id="quantidadeMinima" placeholder="Quantidade mínima" min="0" required>
                    <select id="categoria" required>
                        <option value="">Selecione uma categoria</option>
                        <option value="biosseguranca">Biossegurança</option>
                        <option value="brocas">Brocas</option>
                        <option value="cirurgia">Cirurgia</option>
                        <option value="clinica_geral">Clínica Geral</option>
                        <option value="dentistica">Dentística</option>
                        <option value="endodontia">Endodontia</option>
                        <option value="instrumental">Instrumental</option>
                        <option value="material_limpeza">Material de Limpeza</option>
                        <option value="ortodontia">Ortodontia</option>
                        <option value="protese">Prótese</option>
                        <option value="implantodontia">Implantodontia</option>
                    </select>
                    <input type="file" id="imagem" accept="image/*">
                    <button type="submit">Cadastrar</button>
                </form>
            </div>
        </div>

        <div id="editarModal" class="modal">
            <div class="modal-content">
                <button class="close-btn" id="btnFecharModalEditar">X</button>
                <h3>Editar Material</h3>
                <form id="editarForm">
                    <input type="hidden" id="editId">
                    <input type="text" id="editNome" placeholder="Nome do material" required>
                    <select id="editCategoria">
                        <option value="">Selecione uma categoria</option>
                        <option value="biosseguranca">Biossegurança</option>
                        <option value="brocas">Brocas</option>
                        <option value="cirurgia">Cirurgia</option>
                        <option value="clinica_geral">Clínica Geral</option>
                        <option value="dentistica">Dentística</option>
                        <option value="endodontia">Endodontia</option>
                        <option value="instrumental">Instrumental</option>
                        <option value="material_limpeza">Material de Limpeza</option>
                        <option value="ortodontia">Ortodontia</option>
                        <option value="protese">Prótese</option>
                        <option value="implantodontia">Implantodontia</option>
                    </select>
                    <input type="number" id="editQuantidadeMinima" placeholder="Quantidade mínima" min="0">
                    <input type="file" id="editImagem" accept="image/*">
                    <button type="submit">Salvar Alterações</button>
                </form>
            </div>
        </div>

        <div class="material-list" id="materialList"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar se o Firebase está disponível
            if (typeof firebase === 'undefined') {
                console.error('Firebase SDK não foi carregado corretamente.');
                alert('Erro: Firebase SDK não foi carregado. Verifique sua conexão ou tente novamente.');
                return;
            }

            // Configuração do Firebase
            const firebaseConfig = {
                apiKey: "Sua-API-Key",
                authDomain: "seu-projeto.firebaseapp.com",
                projectId: "seu-projeto",
                storageBucket: "seu-projeto.appspot.com",
                messagingSenderId: "Seu-Sender-ID",
                appId: "Seu-App-ID",
                measurementId: "Seu-Measurement-ID"
            };

            // Inicializar Firebase
            const app = firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();
            const auth = firebase.auth();

            // Variáveis globais
            let materiais = [];
            let materiaisFiltrados = [];

            // Lista de categorias
            const categorias = {
                biosseguranca: "Biossegurança",
                brocas: "Brocas",
                cirurgia: "Cirurgia",
                clinica_geral: "Clínica Geral",
                dentistica: "Dentística",
                endodontia: "Endodontia",
                instrumental: "Instrumental",
                material_limpeza: "Material de Limpeza",
                ortodontia: "Ortodontia",
                protese: "Prótese",
                implantodontia: "Implantodontia"
            };

            // Função para converter arquivo em data URL
            function converterParaDataURL(arquivo) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = error => reject(error);
                    reader.readAsDataURL(arquivo);
                });
            }

            // Função para salvar um material no Firestore
            async function salvarMaterial(material) {
                try {
                    const docRef = db.collection('estoque').doc('materiais').collection('itens').doc(material.id || null);
                    const materialData = {
                        nome: material.nome,
                        quantidade: material.quantidade,
                        quantidadeMinima: material.quantidadeMinima,
                        categoria: material.categoria,
                        imagem: material.imagem || null,
                        ultimaModificacao: firebase.firestore.FieldValue.serverTimestamp(),
                        comprar: material.comprar || false
                    };
                    await docRef.set(materialData);
                    if (!material.id) material.id = docRef.id; // Atribui o ID gerado automaticamente
                    console.log('Material salvo com sucesso:', materialData);
                } catch (error) {
                    console.error('Erro ao salvar material:', error);
                    alert('Falha ao salvar o material: ' + error.message);
                }
            }

            // Função para carregar materiais do Firestore
            async function carregarMateriais() {
                try {
                    const snapshot = await db.collection('estoque').doc('materiais').collection('itens').get();
                    materiais = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data(),
                        ultimaModificacao: doc.data().ultimaModificacao?.toDate().toLocaleString('pt-BR') || 'N/A'
                    }));
                    materiaisFiltrados = [...materiais];
                    atualizarLista();
                    console.log('Materiais carregados:', materiais);
                } catch (error) {
                    console.error('Erro ao carregar materiais:', error);
                    alert('Falha ao carregar os materiais: ' + error.message);
                }
            }

            // Função para atualizar a lista na interface
            function atualizarLista() {
                const lista = document.getElementById('materialList');
                lista.innerHTML = '';
                const materiaisPorCategoria = {};
                materiaisFiltrados.forEach(material => {
                    if (!materiaisPorCategoria[material.categoria]) {
                        materiaisPorCategoria[material.categoria] = [];
                    }
                    materiaisPorCategoria[material.categoria].push(material);
                });

                Object.keys(materiaisPorCategoria).sort().forEach(categoria => {
                    const section = document.createElement('div');
                    section.className = 'category-section';
                    const title = document.createElement('h3');
                    title.className = 'category-title';
                    title.textContent = categorias[categoria] || categoria;
                    section.appendChild(title);

                    materiaisPorCategoria[categoria].sort((a, b) => a.nome.localeCompare(b.nome)).forEach(material => {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'material-item';
                        if (material.quantidade < material.quantidadeMinima) {
                            itemDiv.classList.add('abaixo-minimo');
                        }

                        if (material.imagem) {
                            const img = document.createElement('img');
                            img.src = material.imagem;
                            img.onerror = () => {
                                console.error('Erro ao carregar imagem:', material.imagem);
                                img.style.display = 'none';
                            };
                            itemDiv.appendChild(img);
                        }

                        const info = document.createElement('div');
                        info.className = 'material-info';
                        info.innerHTML = `<strong>${material.nome}</strong> <span class="quantidade">Quantidade: ${material.quantidade}</span><br><span class="detalhes">Mínimo: ${material.quantidadeMinima} | Última modificação: ${material.ultimaModificacao}</span>`;
                        itemDiv.appendChild(info);

                        const controls = document.createElement('div');
                        controls.className = 'controls';

                        const quantidadeBtns = document.createElement('div');
                        quantidadeBtns.className = 'quantidade-btns';
                        const btnAdd = document.createElement('button');
                        btnAdd.textContent = '+';
                        btnAdd.onclick = () => alterarQuantidade(material.id, 1);
                        quantidadeBtns.appendChild(btnAdd);

                        const btnRemove = document.createElement('button');
                        btnRemove.textContent = '-';
                        btnRemove.onclick = () => alterarQuantidade(material.id, -1);
                        quantidadeBtns.appendChild(btnRemove);
                        controls.appendChild(quantidadeBtns);

                        const acaoBtns = document.createElement('div');
                        acaoBtns.className = 'acao-btns';
                        const btnEdit = document.createElement('button');
                        btnEdit.textContent = 'Editar';
                        btnEdit.className = 'edit-btn';
                        btnEdit.onclick = () => abrirModalEditar(material.id);
                        acaoBtns.appendChild(btnEdit);

                        const btnDelete = document.createElement('button');
                        btnDelete.textContent = 'Excluir';
                        btnDelete.className = 'delete-btn';
                        btnDelete.onclick = () => confirmarExclusao(material.id);
                        acaoBtns.appendChild(btnDelete);
                        controls.appendChild(acaoBtns);

                        const btnComprar = document.createElement('button');
                        btnComprar.textContent = 'Comprar';
                        btnComprar.className = 'comprar-btn';
                        btnComprar.classList.toggle('active', material.comprar);
                        btnComprar.onclick = () => toggleComprar(material.id);
                        controls.appendChild(btnComprar);

                        itemDiv.appendChild(controls);
                        section.appendChild(itemDiv);
                    });

                    lista.appendChild(section);
                });
            }

            // Funções de Modal
            function abrirModal() {
                document.getElementById('cadastroModal').style.display = 'flex';
            }

            function fecharModal() {
                document.getElementById('cadastroModal').style.display = 'none';
                document.getElementById('materialForm').reset();
            }

            function abrirModalEditar(id) {
                const material = materiais.find(m => m.id === id);
                document.getElementById('editId').value = material.id;
                document.getElementById('editNome').value = material.nome;
                document.getElementById('editCategoria').value = material.categoria;
                document.getElementById('editQuantidadeMinima').value = material.quantidadeMinima;
                document.getElementById('editarModal').style.display = 'flex';
            }

            function fecharModalEditar() {
                document.getElementById('editarModal').style.display = 'none';
                document.getElementById('editarForm').reset();
            }

            // Função de Logout
            function logout() {
                auth.signOut()
                    .then(() => {
                        console.log('Usuário desconectado com sucesso.');
                    })
                    .catch(error => {
                        console.error('Erro ao desconectar:', error);
                        alert('Falha ao desconectar: ' + error.message);
                    });
            }

            // Função para copiar a lista de compras
            function copiarListaCompras() {
                const itensParaComprar = materiais.filter(material => material.comprar);
                if (itensParaComprar.length === 0) {
                    alert('Nenhum item marcado para compra.');
                    return;
                }

                const itensPorCategoria = {};
                itensParaComprar.forEach(material => {
                    if (!itensPorCategoria[material.categoria]) {
                        itensPorCategoria[material.categoria] = [];
                    }
                    itensPorCategoria[material.categoria].push(material);
                });

                const categoriasOrdenadas = Object.keys(itensPorCategoria).sort();
                const listaItens = categoriasOrdenadas.map(categoria => {
                    const itens = itensPorCategoria[categoria]
                        .sort((a, b) => a.nome.localeCompare(b.nome))
                        .map(material => `${material.nome} (${material.quantidade})`)
                        .join('\n');
                    return `${categorias[categoria] || categoria}\n${itens}`;
                }).join('\n\n');

                navigator.clipboard.writeText(listaItens)
                    .then(() => {
                        alert('Lista de compras copiada com sucesso!\n\n' + listaItens);
                    })
                    .catch(error => {
                        console.error('Erro ao copiar a lista:', error);
                        alert('Falha ao copiar a lista: ' + error.message);
                    });
            }

            // Função para limpar marcações de compra
            async function limparMarcacoes() {
                if (confirm('Deseja realmente limpar todas as marcações de compra?')) {
                    const batch = db.batch();
                    materiais.forEach(material => {
                        if (material.comprar) {
                            const ref = db.collection('estoque').doc('materiais').collection('itens').doc(material.id);
                            batch.update(ref, { comprar: false });
                        }
                    });
                    await batch.commit();
                    materiais.forEach(material => material.comprar = false);
                    atualizarLista();
                }
            }

            // Event Listeners
            document.getElementById('btnAbrirModal').addEventListener('click', abrirModal);
            document.getElementById('btnFecharModal').addEventListener('click', fecharModal);
            document.getElementById('btnFecharModalEditar').addEventListener('click', fecharModalEditar);
            document.getElementById('btnBuscar').addEventListener('click', buscarMateriais);
            document.getElementById('btnGerarRelatorio').addEventListener('click', gerarRelatorio);
            document.getElementById('btnExportarDados').addEventListener('click', exportarDados);
            document.getElementById('btnImportarDados').addEventListener('click', () => document.getElementById('importInput').click());
            document.getElementById('btnCopiarLista').addEventListener('click', copiarListaCompras);
            document.getElementById('btnLimparMarcacoes').addEventListener('click', limparMarcacoes);
            document.getElementById('btnLogout').addEventListener('click', logout);
            document.getElementById('importInput').addEventListener('change', importarDados);

            // Cadastro de novo material
            document.getElementById('materialForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                const nome = document.getElementById('nome').value;
                if (materiais.some(material => material.nome.toLowerCase() === nome.toLowerCase())) {
                    alert('Já existe um material com esse nome!');
                    return;
                }
                const quantidade = parseInt(document.getElementById('quantidade').value);
                const quantidadeMinima = parseInt(document.getElementById('quantidadeMinima').value);
                const categoria = document.getElementById('categoria').value;
                const arquivo = document.getElementById('imagem').files[0];

                const material = {
                    nome: nome,
                    quantidade: quantidade,
                    quantidadeMinima: quantidadeMinima,
                    categoria: categoria,
                    comprar: false
                };

                if (arquivo) {
                    try {
                        const dataURL = await converterParaDataURL(arquivo);
                        const tamanhoBytes = (dataURL.length * 3) / 4 - 2;
                        if (tamanhoBytes > 500000) {
                            alert('A imagem é muito grande! Use uma imagem menor (menos de 500 KB).');
                            return;
                        }
                        material.imagem = dataURL;
                    } catch (error) {
                        console.error('Erro ao converter imagem:', error);
                        alert('Falha ao processar a imagem: ' + error.message);
                        return;
                    }
                }

                await salvarMaterial(material);
                materiais.push(material);
                materiaisFiltrados = [...materiais];
                atualizarLista();
                fecharModal();
            });

            // Editar material
            document.getElementById('editarForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                const id = document.getElementById('editId').value;
                const novoNome = document.getElementById('editNome').value;
                const novaCategoria = document.getElementById('editCategoria').value;
                const novaQuantidadeMinima = parseInt(document.getElementById('editQuantidadeMinima').value);
                const arquivo = document.getElementById('editImagem').files[0];

                const idx = materiais.findIndex(m => m.id === id);
                const material = materiais[idx];
                const updates = {};

                if (novoNome && novoNome !== material.nome) updates.nome = novoNome;
                if (novaCategoria) updates.categoria = novaCategoria;
                if (!isNaN(novaQuantidadeMinima)) updates.quantidadeMinima = novaQuantidadeMinima;
                if (arquivo) {
                    try {
                        const dataURL = await converterParaDataURL(arquivo);
                        const tamanhoBytes = (dataURL.length * 3) / 4 - 2;
                        if (tamanhoBytes > 500000) {
                            alert('A imagem é muito grande! Use uma imagem menor (menos de 500 KB).');
                            return;
                        }
                        updates.imagem = dataURL;
                    } catch (error) {
                        console.error('Erro ao converter imagem:', error);
                        alert('Falha ao processar a imagem: ' + error.message);
                        return;
                    }
                }

                if (Object.keys(updates).length > 0) {
                    updates.ultimaModificacao = firebase.firestore.FieldValue.serverTimestamp();
                    await db.collection('estoque').doc('materiais').collection('itens').doc(id).update(updates);
                    Object.assign(material, updates, { ultimaModificacao: new Date().toLocaleString('pt-BR') });
                    materiaisFiltrados = [...materiais];
                    atualizarLista();
                }
                fecharModalEditar();
            });

            // Alterar quantidade
            async function alterarQuantidade(id, valor) {
                const idx = materiais.findIndex(m => m.id === id);
                if (materiais[idx].quantidade + valor >= 0) {
                    materiais[idx].quantidade += valor;
                    materiais[idx].ultimaModificacao = new Date().toLocaleString('pt-BR');
                    await db.collection('estoque').doc('materiais').collection('itens').doc(id).update({
                        quantidade: materiais[idx].quantidade,
                        ultimaModificacao: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    atualizarLista();
                }
            }

            // Excluir material
            async function confirmarExclusao(id) {
                if (confirm(`Deseja realmente excluir ${materiais.find(m => m.id === id).nome}?`)) {
                    await db.collection('estoque').doc('materiais').collection('itens').doc(id).delete();
                    materiais = materiais.filter(m => m.id !== id);
                    materiaisFiltrados = [...materiais];
                    atualizarLista();
                }
            }

            // Marcar/desmarcar compra
            async function toggleComprar(id) {
                const idx = materiais.findIndex(m => m.id === id);
                materiais[idx].comprar = !materiais[idx].comprar;
                await db.collection('estoque').doc('materiais').collection('itens').doc(id).update({
                    comprar: materiais[idx].comprar,
                    ultimaModificacao: firebase.firestore.FieldValue.serverTimestamp()
                });
                materiais[idx].ultimaModificacao = new Date().toLocaleString('pt-BR');
                atualizarLista();
            }

            // Buscar materiais
            function buscarMateriais() {
                const termo = document.getElementById('searchInput').value.toLowerCase();
                materiaisFiltrados = materiais.filter(material => 
                    material.nome.toLowerCase().includes(termo)
                );
                atualizarLista();
            }

            // Gerar relatório CSV
            function gerarRelatorio() {
                const dados = materiais.map(material => ({
                    Categoria: categorias[material.categoria] || material.categoria,
                    Nome: material.nome,
                    Quantidade: material.quantidade,
                    "Quantidade Mínima": material.quantidadeMinima,
                    "Comprar": material.comprar ? "Sim" : "Não",
                    "Última Modificação": material.ultimaModificacao
                }));

                const csvContent = [
                    ["Categoria", "Nome", "Quantidade", "Quantidade Mínima", "Comprar", "Última Modificação"],
                    ...dados.map(item => [item.Categoria, item.Nome, item.Quantidade, item["Quantidade Mínima"], item["Comprar"], item["Última Modificação"]])
                ].map(row => row.join(",")).join("\n");

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", "relatorio_estoque.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            // Exportar dados
            function exportarDados() {
                const dados = JSON.stringify(materiais);
                const blob = new Blob([dados], { type: 'application/json' });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", "estoque_odontologico.json");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            // Importar dados
            async function importarDados() {
                const arquivo = document.getElementById('importInput').files[0];
                if (arquivo) {
                    const reader = new FileReader();
                    reader.onload = async function(e) {
                        try {
                            const dadosImportados = JSON.parse(e.target.result);
                            const batch = db.batch();
                            for (const material of dadosImportados) {
                                const ref = db.collection('estoque').doc('materiais').collection('itens').doc();
                                material.id = ref.id;
                                batch.set(ref, {
                                    nome: material.nome,
                                    quantidade: material.quantidade,
                                    quantidadeMinima: material.quantidadeMinima,
                                    categoria: material.categoria,
                                    imagem: material.imagem || null,
                                    ultimaModificacao: firebase.firestore.FieldValue.serverTimestamp(),
                                    comprar: material.comprar || false
                                });
                            }
                            await batch.commit();
                            await carregarMateriais();
                            alert("Dados importados com sucesso!");
                        } catch (error) {
                            alert("Erro ao importar os dados: " + error.message);
                        }
                    };
                    reader.readAsText(arquivo);
                }
            }

            // Autenticação
            document.getElementById('loginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;

                auth.signInWithEmailAndPassword(email, password)
                    .then(() => {
                        document.getElementById('loginContainer').classList.add('hidden');
                        document.getElementById('mainContainer').classList.remove('hidden');
                        carregarMateriais();
                    })
                    .catch(error => {
                        console.error('Erro ao autenticar:', error);
                        alert('Falha ao autenticar: ' + error.message);
                    });
            });

            // Verificar estado de autenticação
            auth.onAuthStateChanged(user => {
                if (user) {
                    document.getElementById('loginContainer').classList.add('hidden');
                    document.getElementById('mainContainer').classList.remove('hidden');
                    carregarMateriais();
                } else {
                    document.getElementById('loginContainer').classList.remove('hidden');
                    document.getElementById('mainContainer').classList.add('hidden');
                }
            });
        });
    </script>
</body>
</html>
