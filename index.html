<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Estoque - Consult√≥rio Odontol√≥gico</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary-dark': '#8B456C',
                        'secondary-light': '#F0E6F0',
                        'background-light': '#FFFFFF',
                        'text-dark': '#333333',
                        'danger-red': '#CD5C5C',
                        'ai-sparkle': '#FFD700',
                    }
                }
            }
        }
    </script>
    <!-- Firebase compat SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <!-- XLSX (relat√≥rios) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
    </style>
</head>
<body class="font-sans bg-background-light min-h-screen flex flex-col items-center p-4">

    <!-- Modal base reutiliz√°vel -->
    <div id="customModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
            <h3 id="modalTitle" class="text-xl font-semibold mb-4 text-text-dark"></h3>
            <p id="modalMessage" class="mb-6 text-gray-700"></p>
            <div id="modalActions" class="flex justify-center space-x-4"></div>
        </div>
    </div>

    <!-- Login -->
    <div id="loginContainer" class="bg-white p-8 rounded-xl shadow-lg w-full max-w-md hidden">
        <h2 class="text-3xl font-bold text-center text-primary-dark mb-6">Login - Controle de Estoque</h2>
        <form id="loginForm" class="space-y-4">
            <div>
                <label for="email" class="sr-only">E-mail</label>
                <input type="email" id="email" placeholder="E-mail" required
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary-dark focus:border-primary-dark transition duration-200">
            </div>
            <div>
                <label for="password" class="sr-only">Senha</label>
                <input type="password" id="password" placeholder="Senha" required
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary-dark focus:border-primary-dark transition duration-200">
            </div>
            <button type="submit"
                    class="w-full bg-primary-dark text-white py-2 px-4 rounded-lg hover:bg-opacity-90 focus:outline-none focus:ring-2 focus:ring-primary-dark focus:ring-opacity-50 transition duration-200 ease-in-out transform hover:scale-105">
                Entrar
            </button>
        </form>
    </div>

    <!-- Main -->
    <div id="mainContainer" class="container bg-white p-6 md:p-8 rounded-xl shadow-lg w-full max-w-6xl hidden">
        <div class="flex flex-wrap items-center justify-center gap-3 md:gap-4 p-4 bg-secondary-light rounded-lg mb-6 shadow-sm">
            <input type="text" id="searchInput" placeholder="Buscar material..."
                   class="flex-1 min-w-[150px] px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary-dark focus:border-primary-dark transition duration-200">
            <button id="btnBuscar"
                    class="flex-1 min-w-[100px] bg-text-dark text-white py-2 px-4 rounded-lg hover:bg-opacity-90 focus:outline-none focus:ring-2 focus:ring-text-dark focus:ring-opacity-50 transition duration-200 ease-in-out transform hover:scale-105">
                Buscar
            </button>
            <button id="btnListaCompras"
                    class="flex-1 min-w-[150px] bg-text-dark text-white py-2 px-4 rounded-lg hover:bg-opacity-90 focus:outline-none focus:ring-2 focus:ring-text-dark focus:ring-opacity-50 transition duration-200 ease-in-out transform hover:scale-105">
                Lista de Compras
            </button>
            <button id="btnLimparMarcacoes"
                    class="flex-1 min-w-[150px] bg-text-dark text-white py-2 px-4 rounded-lg hover:bg-opacity-90 focus:outline-none focus:ring-2 focus:ring-text-dark focus:ring-opacity-50 transition duration-200 ease-in-out transform hover:scale-105">
                Limpar Marca√ß√µes
            </button>
            <button id="btnAdvancedOptions"
                    class="flex-1 min-w-[150px] bg-primary-dark text-white py-2 px-4 rounded-lg hover:bg-opacity-90 focus:outline-none focus:ring-2 focus:ring-primary-dark focus:ring-opacity-50 transition duration-200 ease-in-out transform hover:scale-105">
                Avan√ßado
            </button>
        </div>

        <!-- Op√ß√µes avan√ßadas -->
        <div id="advancedOptionsContainer" class="flex flex-wrap items-center justify-center gap-3 md:gap-4 p-4 bg-secondary-light rounded-lg mb-6 shadow-sm hidden">
            <button id="btnAbrirModal"
                    class="flex-1 min-w-[150px] bg-primary-dark text-white py-2 px-4 rounded-lg hover:bg-opacity-90 focus:outline-none focus:ring-2 focus:ring-primary-dark focus:ring-opacity-50 transition duration-200 ease-in-out transform hover:scale-105">
                Adicionar Novo Item
            </button>
            <button id="btnGerarRelatorio"
                    class="flex-1 min-w-[150px] bg-text-dark text-white py-2 px-4 rounded-lg hover:bg-opacity-90 focus:outline-none focus:ring-2 focus:ring-text-dark focus:ring-opacity-50 transition duration-200 ease-in-out transform hover:scale-105">
                Gerar Relat√≥rio
            </button>
            <button id="btnLogout"
                    class="flex-1 min-w-[100px] bg-danger-red text-white py-2 px-4 rounded-lg hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50 transition duration-200 ease-in-out transform hover:scale-105">
                Sair
            </button>

            <!-- ======= NF-e: Bot√£o + input file ======= -->
            <input id="inputXmlNfe" type="file" accept=".xml" class="hidden">
            <button id="btnImportarNfe"
                    class="flex-1 min-w-[180px] bg-primary-dark text-white py-2 px-4 rounded-lg hover:bg-opacity-90 focus:outline-none focus:ring-2 focus:ring-primary-dark focus:ring-opacity-50 transition duration-200 ease-in-out transform hover:scale-105">
                Importar NF-e (XML)
            </button>
            <!-- ======================================= -->
        </div>

        <div class="flex flex-col md:flex-row w-full gap-6">
            <div class="w-full md:w-1/4 bg-white p-4 rounded-xl shadow-lg h-fit">
                <h2 class="text-xl font-bold text-primary-dark mb-4">Categorias</h2>
                <div id="categorySidebar" class="space-y-2"></div>
            </div>

            <div class="w-full md:w-3/4">
                <div id="purchaseListActionsContainer" class="flex flex-wrap items-center justify-end gap-3 p-4 bg-secondary-light rounded-lg mb-6 shadow-sm hidden">
                    <button id="btnCopiarLista"
                            class="bg-text-dark text-white py-2 px-4 rounded-lg hover:bg-opacity-90 focus:outline-none focus:ring-2 focus:ring-text-dark focus:ring-opacity-50 transition duration-200 ease-in-out transform hover:scale-105">
                        Copiar Lista
                    </button>
                    <button id="btnMostrarTodos"
                            class="bg-primary-dark text-white py-2 px-4 rounded-lg hover:bg-opacity-90 focus:outline-none focus:ring-2 focus:ring-primary-dark focus:ring-opacity-50 transition duration-200 ease-in-out transform hover:scale-105">
                        Mostrar Todos os Itens
                    </button>
                </div>

                <div id="materialList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </div>
        </div>

        <!-- Modal: Cadastrar novo material -->
        <div id="cadastroModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-40 hidden">
            <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md mx-4">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-2xl font-semibold text-primary-dark">Cadastrar Novo Material</h3>
                    <button class="text-gray-500 hover:text-gray-700 text-2xl" id="btnFecharModal">&times;</button>
                </div>
                <form id="materialForm" class="space-y-4">
                    <input type="text" id="nome" placeholder="Nome do material" required
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary-dark focus:border-primary-dark">
                    <input type="number" id="quantidade" placeholder="Quantidade inicial" min="0" required
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary-dark focus:border-primary-dark">
                    <input type="number" id="quantidadeMinima" placeholder="Quantidade m√≠nima" min="0" required
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary-dark focus:border-primary-dark">
                    <select id="categoria" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary-dark focus:border-primary-dark">
                        <option value="">Selecione uma categoria</option>
                        <option value="biosseguranca">Biosseguran√ßa</option>
                        <option value="brocas">Brocas</option>
                        <option value="cirurgia">Cirurgia</option>
                        <option value="clinica_geral">Cl√≠nica Geral</option>
                        <option value="dentistica">Dent√≠stica</option>
                        <option value="endodontia">Endodontia</option>
                        <option value="instrumental">Instrumental</option>
                        <option value="material_limpeza">Material de Limpeza</option>
                        <option value="ortodontia">Ortodontia</option>
                        <option value="papelaria">Papelaria</option>
                        <option value="protese">Pr√≥tese</option>
                        <option value="implantodontia">Implantodontia</option>
                    </select>
                    <input type="file" id="imagem" accept="image/*"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-primary-dark hover:file:bg-blue-100">
                    <button type="submit"
                            class="w-full bg-primary-dark text-white py-2 px-4 rounded-lg hover:bg-opacity-90 focus:outline-none focus:ring-2 focus:ring-primary-dark focus:ring-opacity-50 transition duration-200 ease-in-out transform hover:scale-105">
                        Cadastrar
                    </button>
                </form>
            </div>
        </div>

        <!-- Modal: Editar material -->
        <div id="editarModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-40 hidden">
            <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md mx-4">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-2xl font-semibold text-primary-dark">Editar Material</h3>
                    <button class="text-gray-500 hover:text-gray-700 text-2xl" id="btnFecharModalEditar">&times;</button>
                </div>
                <form id="editarForm" class="space-y-4">
                    <input type="text" id="editNome" placeholder="Nome do material" required
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary-dark focus:border-primary-dark">
                    <input type="hidden" id="originalNome">
                    <select id="editCategoria"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary-dark focus:border-primary-dark">
                        <option value="">Selecione uma categoria</option>
                        <option value="biosseguranca">Biosseguran√ßa</option>
                        <option value="brocas">Brocas</option>
                        <option value="cirurgia">Cirurgia</option>
                        <option value="clinica_geral">Cl√≠nica Geral</option>
                        <option value="dentistica">Dent√≠stica</option>
                        <option value="endodontia">Endodontia</option>
                        <option value="instrumental">Instrumental</option>
                        <option value="material_limpeza">Material de Limpeza</option>
                        <option value="ortodontia">Ortodontia</option>
                        <option value="papelaria">Papelaria</option>
                        <option value="protese">Pr√≥tese</option>
                        <option value="implantodontia">Implantodontia</option>
                    </select>
                    <input type="number" id="editQuantidadeMinima" placeholder="Quantidade m√≠nima" min="0"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary-dark focus:border-primary-dark">
                    <input type="file" id="editImagem" accept="image/*"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-primary-dark hover:file:bg-blue-100">
                    <button type="submit"
                            class="w-full bg-primary-dark text-white py-2 px-4 rounded-lg hover:bg-opacity-90 focus:outline-none focus:ring-2 focus:ring-primary-dark focus:ring-opacity-50 transition duration-200 ease-in-out transform hover:scale-105">
                        Salvar Altera√ß√µes
                    </button>
                </form>
            </div>
        </div>

        <!-- ======= Modal: Matching NF-e ======= -->
        <div id="nfeMatchModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
          <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-2xl mx-4">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-2xl font-semibold text-primary-dark">Conferir item da NF-e</h3>
              <button class="text-gray-500 hover:text-gray-700 text-2xl" id="btnFecharNfeMatch">&times;</button>
            </div>

            <div id="nfeItemBox" class="space-y-2 mb-4">
              <p class="text-sm text-gray-500">Passo <span id="nfeStepIdx">1</span> de <span id="nfeStepTotal">1</span></p>
              <div class="bg-secondary-light rounded-lg p-3">
                <div class="text-sm text-gray-600">Item da nota:</div>
                <div id="nfeItemNome" class="font-semibold text-text-dark"></div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 mt-2 text-sm">
                  <div><span class="text-gray-600">Qtd:</span> <span id="nfeItemQtd"></span></div>
                  <div><span class="text-gray-600">Pre√ßo unit.:</span> R$ <span id="nfeItemPreco"></span></div>
                  <div><span class="text-gray-600">Lote:</span> <span id="nfeItemLote"></span></div>
                  <div><span class="text-gray-600">Validade:</span> <span id="nfeItemVal"></span></div>
                </div>
              </div>
            </div>

            <div class="space-y-3">
              <label class="block text-sm text-gray-700">Sugerido do seu estoque (melhores correspond√™ncias):</label>
              <select id="nfeCandidateSelect" class="w-full border border-gray-300 rounded-lg p-2 focus:ring-primary-dark focus:border-primary-dark"></select>

              <div class="flex gap-2">
                <input id="nfeNewName" type="text" placeholder="(Opcional) Nome padronizado / novo produto"
                       class="flex-1 border border-gray-300 rounded-lg p-2 focus:ring-primary-dark focus:border-primary-dark">
                <select id="nfeNewCategory" class="w-60 border border-gray-300 rounded-lg p-2 focus:ring-primary-dark focus:border-primary-dark">
                  <option value="">Categoria (se novo)</option>
                  <option value="biosseguranca">Biosseguran√ßa</option>
                  <option value="brocas">Brocas</option>
                  <option value="cirurgia">Cirurgia</option>
                  <option value="clinica_geral">Cl√≠nica Geral</option>
                  <option value="dentistica">Dent√≠stica</option>
                  <option value="endodontia">Endodontia</option>
                  <option value="instrumental">Instrumental</option>
                  <option value="material_limpeza">Material de Limpeza</option>
                  <option value="ortodontia">Ortodontia</option>
                  <option value="papelaria">Papelaria</option>
                  <option value="protese">Pr√≥tese</option>
                  <option value="implantodontia">Implantodontia</option>
                </select>
              </div>

              <div class="text-xs text-gray-500">
                Dica: se o ‚Äúsugerido‚Äù n√£o for o mesmo item, escolha outro no select ou escreva o nome padronizado e a categoria para criar um novo produto.
              </div>
            </div>

            <div class="flex justify-between items-center mt-6">
              <div class="text-sm text-gray-600">A√ß√µes para este item</div>
              <div class="flex gap-2">
                <button id="nfeBtnPular" class="bg-gray-200 text-text-dark py-2 px-3 rounded-lg hover:bg-gray-300">Pular</button>
                <button id="nfeBtnMesmo" class="bg-primary-dark text-white py-2 px-3 rounded-lg hover:bg-opacity-90">√â o mesmo</button>
                <button id="nfeBtnCriar" class="bg-green-600 text-white py-2 px-3 rounded-lg hover:bg-green-700">Criar novo</button>
                <button id="nfeBtnAvancar" class="bg-text-dark text-white py-2 px-3 rounded-lg hover:bg-opacity-90">Avan√ßar</button>
              </div>
            </div>
          </div>
        </div>
        <!-- ====================================== -->

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Check Firebase
            if (typeof firebase === 'undefined') {
                showCustomModal('Erro', 'Firebase SDK n√£o foi carregado. Verifique sua conex√£o ou tente novamente.', 'alert');
                return;
            }

            // Firebase config
            const firebaseConfig = {
                apiKey: "AIzaSyCDxJW_o6y-hmisQHOHVYPVJ8cag6hrKv0",
                authDomain: "estoque-prime.firebaseapp.com",
                projectId: "estoque-prime",
                storageBucket: "estoque-prime.firebasestorage.app",
                messagingSenderId: "1092019247496",
                appId: "1:1092019247496:web:92076afda68ccbc23d823d",
                measurementId: "G-04D19CYTTQ"
            };

            // Init Firebase
            const app = firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();
            const auth = firebase.auth();

            // Categorias (display)
            const categorias = {
                biosseguranca: "Biosseguran√ßa",
                brocas: "Brocas",
                cirurgia: "Cirurgia",
                clinica_geral: "Cl√≠nica Geral",
                dentistica: "Dent√≠stica",
                endodontia: "Endodontia",
                instrumental: "Instrumental",
                material_limpeza: "Material de Limpeza",
                ortodontia: "Ortodontia",
                papelaria: "Papelaria",
                protese: "Pr√≥tese",
                implantodontia: "Implantodontia"
            };

            let materiaisFiltrados = [];
            let termoDeBusca = "";
            let categoriaSelecionada = "todos";
            let isShowingPurchaseList = false;

            // ---------- Utilit√°rios ----------
            function showCustomModal(title, message, type, copyText = '') {
                return new Promise((resolve) => {
                    const modal = document.getElementById('customModal');
                    const modalTitle = document.getElementById('modalTitle');
                    const modalMessage = document.getElementById('modalMessage');
                    const modalActions = document.getElementById('modalActions');

                    modalTitle.textContent = title;
                    modalMessage.innerHTML = '';
                    modalActions.innerHTML = '';

                    if (type === 'copy') {
                        const textArea = document.createElement('textarea');
                        textArea.value = copyText;
                        textArea.readOnly = true;
                        textArea.className = 'w-full h-32 p-2 border border-gray-300 rounded-lg resize-none mb-4 font-mono text-sm';
                        modalMessage.appendChild(document.createTextNode(message));
                        modalMessage.appendChild(document.createElement('br'));
                        modalMessage.appendChild(document.createElement('br'));
                        modalMessage.appendChild(textArea);

                        const closeButton = document.createElement('button');
                        closeButton.textContent = 'Fechar';
                        closeButton.className = 'bg-primary-dark text-white py-2 px-4 rounded-lg hover:bg-opacity-90 transition duration-200 ease-in-out transform hover:scale-105';
                        closeButton.onclick = () => { modal.classList.add('hidden'); resolve(false); };
                        modalActions.appendChild(closeButton);

                        textArea.focus(); textArea.select(); textArea.setSelectionRange(0, textArea.value.length);
                    } else if (type === 'alert') {
                        modalMessage.textContent = message;
                        const okButton = document.createElement('button');
                        okButton.textContent = 'OK';
                        okButton.className = 'bg-primary-dark text-white py-2 px-4 rounded-lg hover:bg-opacity-90 transition duration-200 ease-in-out transform hover:scale-105';
                        okButton.onclick = () => { modal.classList.add('hidden'); resolve(true); };
                        modalActions.appendChild(okButton);
                    } else if (type === 'confirm') {
                        modalMessage.textContent = message;
                        const yesButton = document.createElement('button');
                        yesButton.textContent = 'Sim';
                        yesButton.className = 'bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition duration-200 ease-in-out transform hover:scale-105';
                        yesButton.onclick = () => { modal.classList.add('hidden'); resolve(true); };
                        modalActions.appendChild(yesButton);

                        const noButton = document.createElement('button');
                        noButton.textContent = 'N√£o';
                        noButton.className = 'bg-danger-red text-white py-2 px-4 rounded-lg hover:bg-red-700 transition duration-200 ease-in-out transform hover:scale-105';
                        noButton.onclick = () => { modal.classList.add('hidden'); resolve(false); };
                        modalActions.appendChild(noButton);
                    }

                    modal.classList.remove('hidden');
                });
            }

            function converterParaDataURL(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = error => reject(error);
                    reader.readAsDataURL(file);
                });
            }

            // ---------- Carregamento / Render ----------
            async function carregarMateriais() {
                try {
                    const snapshot = await db.collection('materiais').get();
                    let todosMateriais = [];
                    snapshot.forEach(doc => todosMateriais.push(doc.data()));

                    if (isShowingPurchaseList) {
                        materiaisFiltrados = todosMateriais.filter(m => m.comprar === true);
                        document.getElementById('searchInput').value = '';
                        termoDeBusca = '';
                        categoriaSelecionada = 'todos';
                    } else {
                        materiaisFiltrados = todosMateriais.filter(m => m.nome.toLowerCase().includes(termoDeBusca.toLowerCase()));
                        if (categoriaSelecionada !== "todos") {
                            materiaisFiltrados = materiaisFiltrados.filter(m => m.categoria === categoriaSelecionada);
                        }
                    }

                    atualizarLista(materiaisFiltrados);
                    renderizarCategorias(todosMateriais);
                    togglePurchaseListActionsVisibility();

                } catch (error) {
                    console.error("Erro ao carregar materiais:", error);
                    showCustomModal("Erro", "Erro ao carregar materiais: " + error.message, 'alert');
                }
            }

            async function salvarMaterial(material) {
                try {
                    await db.collection('materiais').doc(material.nome).set(material);
                    console.log('Material salvo:', material);
                } catch (error) {
                    console.error('Erro ao salvar material:', error);
                    showCustomModal("Erro", 'Erro ao salvar material: ' + error.message, 'alert');
                }
            }

            function renderizarCategorias(allMaterials) {
                const categorySidebar = document.getElementById('categorySidebar');
                categorySidebar.innerHTML = '';

                const uniqueCategories = new Set();
                allMaterials.forEach(m => uniqueCategories.add(m.categoria));

                const allButton = document.createElement('button');
                allButton.textContent = 'Todos';
                allButton.className = `w-full text-left py-2 px-4 rounded-lg transition duration-200 ${categoriaSelecionada === 'todos' && !isShowingPurchaseList ? 'bg-primary-dark text-white' : 'bg-gray-200 text-text-dark hover:bg-gray-300'}`;
                allButton.onclick = () => { categoriaSelecionada = 'todos'; isShowingPurchaseList = false; carregarMateriais(); };
                categorySidebar.appendChild(allButton);

                Array.from(uniqueCategories).sort().forEach(catKey => {
                    const categoryButton = document.createElement('button');
                    categoryButton.textContent = categorias[catKey] || catKey;
                    categoryButton.className = `w-full text-left py-2 px-4 rounded-lg transition duration-200 ${categoriaSelecionada === catKey && !isShowingPurchaseList ? 'bg-primary-dark text-white' : 'bg-gray-200 text-text-dark hover:bg-gray-300'}`;
                    categoryButton.onclick = () => { categoriaSelecionada = catKey; isShowingPurchaseList = false; carregarMateriais(); };
                    categorySidebar.appendChild(categoryButton);
                });
            }

            function togglePurchaseListActionsVisibility() {
                const el = document.getElementById('purchaseListActionsContainer');
                if (isShowingPurchaseList) el.classList.remove('hidden'); else el.classList.add('hidden');
            }

            function atualizarLista(materiais) {
                const lista = document.getElementById('materialList');
                lista.innerHTML = '';

                if (materiais.length === 0) {
                    lista.innerHTML = '<p class="text-center text-gray-600 col-span-full">Nenhum material encontrado para esta busca/categoria.</p>';
                    return;
                }

                materiais.sort((a, b) => a.nome.localeCompare(b.nome)).forEach(material => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = `material-item bg-white rounded-lg shadow-md flex flex-col transition duration-200 ease-in-out hover:shadow-lg ${material.quantidade < material.quantidadeMinima ? 'border-2 border-danger-red' : ''}`;

                    const imgContainer = document.createElement('div');
                    imgContainer.className = 'w-full h-48 bg-white flex items-center justify-center relative';
                    if (material.imagem) {
                        const img = document.createElement('img');
                        img.src = material.imagem;
                        img.alt = `Imagem de ${material.nome}`;
                        img.className = 'w-full h-full object-contain';
                        img.onerror = () => {
                            console.error('Erro ao carregar imagem:', material.imagem);
                            img.src = 'https://placehold.co/300x300/BFBFBF/585856?text=Sem+Imagem';
                            img.className = 'w-24 h-24 object-contain';
                        };
                        imgContainer.appendChild(img);
                    } else {
                        const placeholderImg = document.createElement('img');
                        placeholderImg.src = 'https://placehold.co/300x300/BFBFBF/585856?text=Sem+Imagem';
                        placeholderImg.alt = `Sem imagem para ${material.nome}`;
                        placeholderImg.className = 'w-24 h-24 object-contain';
                        imgContainer.appendChild(placeholderImg);
                    }
                    itemDiv.appendChild(imgContainer);

                    const info = document.createElement('div');
                    info.className = 'p-4 flex-grow';
                    info.innerHTML = `
                        <h3 class="text-lg font-semibold text-text-dark mb-1">${material.nome}</h3>
                        <p class="text-sm text-gray-700">Categoria: ${categorias[material.categoria] || material.categoria}</p>
                        <p class="text-xs text-gray-500 mt-1">Modificado em: ${material.ultimaModificacao || 'N/A'}</p>
                    `;
                    itemDiv.appendChild(info);

                    const controls = document.createElement('div');
                    controls.className = 'p-4 bg-gray-50 border-t border-gray-100 flex flex-col space-y-3';

                    const quantityControlDiv = document.createElement('div');
                    quantityControlDiv.className = 'flex items-center justify-between gap-2';
                    quantityControlDiv.innerHTML = `<span class="text-text-dark font-medium">Quantidade:</span>`;

                    const qtyAdjustDiv = document.createElement('div');
                    qtyAdjustDiv.className = 'flex items-center gap-1';

                    const btnRemove = document.createElement('button');
                    btnRemove.textContent = '-';
                    btnRemove.className = 'bg-primary-dark text-white p-1 rounded-full text-base font-bold hover:bg-opacity-90 transition duration-200 w-7 h-7 flex items-center justify-center';
                    btnRemove.onclick = () => alterarQuantidade(material.nome, -1);
                    qtyAdjustDiv.appendChild(btnRemove);

                    const quantityInput = document.createElement('input');
                    quantityInput.type = 'number';
                    quantityInput.value = material.quantidade;
                    quantityInput.min = '0';
                    quantityInput.className = 'w-16 text-center border border-gray-300 rounded-md py-1 text-sm focus:ring-primary-dark focus:border-primary-dark';
                    quantityInput.onchange = (e) => alterarQuantidadeDireta(material.nome, parseInt(e.target.value));
                    qtyAdjustDiv.appendChild(quantityInput);

                    const btnAdd = document.createElement('button');
                    btnAdd.textContent = '+';
                    btnAdd.className = 'bg-primary-dark text-white p-1 rounded-full text-base font-bold hover:bg-opacity-90 transition duration-200 w-7 h-7 flex items-center justify-center';
                    btnAdd.onclick = () => alterarQuantidade(material.nome, 1);
                    qtyAdjustDiv.appendChild(btnAdd);

                    quantityControlDiv.appendChild(qtyAdjustDiv);
                    controls.appendChild(quantityControlDiv);

                    const btnComprar = document.createElement('button');
                    btnComprar.textContent = material.comprar ? 'Na Lista de Compras' : 'Adicionar √† Lista';
                    btnComprar.className = `w-full py-2 px-4 rounded-lg font-semibold transition duration-200 transform hover:scale-105 ${material.comprar ? 'bg-green-600 text-white hover:bg-green-700' : 'bg-primary-dark text-white hover:bg-opacity-90'}`;
                    btnComprar.onclick = () => toggleComprar(material.nome);
                    controls.appendChild(btnComprar);

                    const optionsDropdownDiv = document.createElement('div');
                    optionsDropdownDiv.className = 'relative inline-block text-left w-full';

                    const btnOptions = document.createElement('button');
                    btnOptions.innerHTML = `<svg class="w-5 h-5 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"></path></svg> Op√ß√µes`;
                    btnOptions.className = 'w-full bg-gray-200 text-text-dark py-2 px-3 rounded-lg text-sm hover:bg-gray-300 transition duration-200 transform hover:scale-105 mt-2';
                    btnOptions.onclick = (e) => {
                        e.stopPropagation();
                        document.querySelectorAll('.dropdown-content').forEach(otherDropdown => {
                            if (otherDropdown !== dropdownContent && !otherDropdown.classList.contains('hidden')) {
                                otherDropdown.classList.add('hidden');
                            }
                        });
                        dropdownContent.classList.toggle('hidden');
                    };
                    optionsDropdownDiv.appendChild(btnOptions);

                    const dropdownContent = document.createElement('div');
                    dropdownContent.className = 'dropdown-content absolute right-0 mt-2 w-40 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 hidden z-50';
                    dropdownContent.onclick = (e) => e.stopPropagation();

                    const btnEdit = document.createElement('button');
                    btnEdit.textContent = 'Editar';
                    btnEdit.className = 'block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-text-dark rounded-t-md';
                    btnEdit.onclick = () => { abrirModalEditar(material.nome); dropdownContent.classList.add('hidden'); };
                    dropdownContent.appendChild(btnEdit);

                    const btnDelete = document.createElement('button');
                    btnDelete.textContent = 'Excluir';
                    btnDelete.className = 'block w-full text-left px-4 py-2 text-sm text-danger-red hover:bg-red-100 hover:text-red-800 rounded-b-md';
                    btnDelete.onclick = () => { confirmarExclusao(material.nome); dropdownContent.classList.add('hidden'); };
                    dropdownContent.appendChild(btnDelete);

                    optionsDropdownDiv.appendChild(dropdownContent);
                    controls.appendChild(optionsDropdownDiv);

                    itemDiv.appendChild(controls);
                    lista.appendChild(itemDiv);
                });
            }

            function abrirModal() { document.getElementById('cadastroModal').classList.remove('hidden'); }
            function fecharModal() { document.getElementById('cadastroModal').classList.add('hidden'); document.getElementById('materialForm').reset(); }

            function abrirModalEditar(nome) {
                const material = materiaisFiltrados.find(m => m.nome === nome);
                if (material) {
                    document.getElementById('editNome').value = material.nome;
                    document.getElementById('originalNome').value = material.nome;
                    document.getElementById('editCategoria').value = material.categoria;
                    document.getElementById('editQuantidadeMinima').value = material.quantidadeMinima;
                    document.getElementById('editarModal').classList.remove('hidden');
                } else {
                    showCustomModal("Erro", "Material n√£o encontrado para edi√ß√£o.", 'alert');
                }
            }
            function fecharModalEditar() { document.getElementById('editarModal').classList.add('hidden'); document.getElementById('editarForm').reset(); }

            document.getElementById('editarForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                const originalNome = document.getElementById('originalNome').value;
                const newNome = document.getElementById('editNome').value.trim();
                const novaCategoria = document.getElementById('editCategoria').value;
                const novaQuantidadeMinima = parseInt(document.getElementById('editQuantidadeMinima').value);
                const arquivo = document.getElementById('editImagem').files[0];

                try {
                    let materialToUpdate = materiaisFiltrados.find(m => m.nome === originalNome);
                    if (!materialToUpdate) {
                        showCustomModal("Erro", "Material original n√£o encontrado.", 'alert');
                        return;
                    }

                    let updateData = {
                        categoria: novaCategoria,
                        quantidadeMinima: novaQuantidadeMinima,
                        ultimaModificacao: new Date().toLocaleString('pt-BR')
                    };

                    if (arquivo) {
                        const dataURL = await converterParaDataURL(arquivo);
                        const tamanhoBytes = (dataURL.length * 3) / 4 - 2;
                        if (tamanhoBytes > 500000) {
                            showCustomModal('Aviso', 'A imagem √© muito grande! Use uma imagem menor (menos de 500 KB).', 'alert');
                            return;
                        }
                        updateData.imagem = dataURL;
                    }

                    if (newNome !== originalNome) {
                        const existingDoc = await db.collection('materiais').doc(newNome).get();
                        if (existingDoc.exists) {
                            showCustomModal("Erro", `J√° existe um material com o nome "${newNome}".`, 'alert');
                            return;
                        }
                        const newMaterialData = { ...materialToUpdate, ...updateData, nome: newNome };
                        await db.collection('materiais').doc(newNome).set(newMaterialData);
                        await db.collection('materiais').doc(originalNome).delete();
                    } else {
                        await db.collection('materiais').doc(originalNome).update(updateData);
                    }

                    fecharModalEditar();
                    carregarMateriais();
                } catch (error) {
                    console.error("Erro ao atualizar material:", error);
                    showCustomModal("Erro", "Erro ao atualizar material: " + error.message, 'alert');
                }
            });

            async function limparMarcacoes() {
                const confirmed = await showCustomModal("Confirmar", "Deseja limpar todas as marca√ß√µes de compra?", 'confirm');
                if (confirmed) {
                    try {
                        const snapshot = await db.collection('materiais').get();
                        const batch = db.batch();
                        snapshot.forEach(doc => batch.update(doc.ref, { comprar: false }));
                        await batch.commit();
                        carregarMateriais();
                    } catch (error) {
                        console.error("Erro ao limpar marca√ß√µes:", error);
                        showCustomModal("Erro", "Erro ao limpar marca√ß√µes: " + error.message, 'alert');
                    }
                }
            }

            async function copiarListaCompras() {
                try {
                    const snapshot = await db.collection('materiais').where("comprar", "==", true).get();
                    if (snapshot.empty) { showCustomModal("Aviso", "Nenhum item marcado para compra.", 'alert'); return; }
                    let itensPorCategoria = {};
                    snapshot.forEach(doc => {
                        let m = doc.data();
                        let categoria = categorias[m.categoria] || "Outros";
                        if (!itensPorCategoria[categoria]) itensPorCategoria[categoria] = [];
                        itensPorCategoria[categoria].push(m.nome + " (Qtd: " + m.quantidade + ")");
                    });

                    let listaTexto = Object.keys(itensPorCategoria).sort().map(cat => {
                        let itensOrdenados = itensPorCategoria[cat].sort();
                        return `üîπ ${cat.toUpperCase()}\n- ${itensOrdenados.join("\n- ")}`;
                    }).join("\n\n");

                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        try { await navigator.clipboard.writeText(listaTexto); showCustomModal("Sucesso", "Lista de compras copiada!", 'alert'); return; }
                        catch (_) {}
                    }
                    showCustomModal("Copiar Lista de Compras", "Selecione e copie o texto:", 'copy', listaTexto);
                } catch (error) {
                    console.error("Erro ao copiar lista:", error);
                    showCustomModal("Erro", "Erro ao copiar a lista: " + error.message, 'alert');
                }
            }

            async function buscarMateriais() {
                termoDeBusca = document.getElementById('searchInput').value.toLowerCase().trim();
                isShowingPurchaseList = false;
                carregarMateriais();
            }

            async function gerarRelatorio() {
                try {
                    const snapshot = await db.collection('materiais').get();
                    if (snapshot.empty) { showCustomModal("Aviso", "Nenhum material encontrado.", 'alert'); return; }
                    const dados = [];
                    snapshot.forEach(doc => {
                        const m = doc.data();
                        dados.push({
                            Nome: m.nome,
                            Categoria: categorias[m.categoria] || m.categoria,
                            Quantidade: m.quantidade,
                            "Quantidade M√≠nima": m.quantidadeMinima,
                            "Marcado para Compra": m.comprar ? "Sim" : "N√£o",
                            "√öltima Modifica√ß√£o": m.ultimaModificacao || "N/A",
                        });
                    });
                    const ws = XLSX.utils.json_to_sheet(dados);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "Estoque");
                    XLSX.writeFile(wb, "Relatorio_Estoque_Odontologico.xlsx");
                } catch (error) {
                    console.error("Erro ao gerar relat√≥rio:", error);
                    showCustomModal("Erro", "Erro ao gerar relat√≥rio: " + error.message, 'alert');
                }
            }

            function logout() {
                auth.signOut().catch(error => {
                    console.error('Erro ao desconectar:', error);
                    showCustomModal("Erro", 'Falha ao desconectar: ' + error.message, 'alert');
                });
            }

            document.getElementById('materialForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                const nome = document.getElementById('nome').value.trim();
                const quantidade = parseInt(document.getElementById('quantidade').value);
                const quantidadeMinima = parseInt(document.getElementById('quantidadeMinima').value);
                const categoria = document.getElementById('categoria').value;
                const arquivo = document.getElementById('imagem').files[0];

                const existingDoc = await db.collection('materiais').doc(nome).get();
                if (existingDoc.exists) { showCustomModal("Erro", `J√° existe "${nome}".`, 'alert'); return; }

                const material = {
                    nome, quantidade, quantidadeMinima, categoria,
                    imagem: null,
                    ultimaModificacao: new Date().toLocaleString('pt-BR'),
                    comprar: false
                };

                if (arquivo) {
                    try {
                        const dataURL = await converterParaDataURL(arquivo);
                        const tamanhoBytes = (dataURL.length * 3) / 4 - 2;
                        if (tamanhoBytes > 500000) { showCustomModal('Aviso', 'Imagem > 500 KB.', 'alert'); return; }
                        material.imagem = dataURL;
                    } catch (error) {
                        console.error('Erro ao converter imagem:', error);
                        showCustomModal('Erro', 'Falha ao processar a imagem: ' + error.message, 'alert');
                        return;
                    }
                }

                await salvarMaterial(material);
                await carregarMateriais();
                fecharModal();
            });

            async function alterarQuantidade(nome, valor) {
                const material = materiaisFiltrados.find(m => m.nome === nome);
                if (material && material.quantidade + valor >= 0) {
                    material.quantidade += valor;
                    material.ultimaModificacao = new Date().toLocaleString('pt-BR');
                    await salvarMaterial(material);
                    await carregarMateriais();
                } else if (material && material.quantidade + valor < 0) {
                    showCustomModal('Aviso', 'A quantidade n√£o pode ser negativa.', 'alert');
                }
            }
            async function alterarQuantidadeDireta(nome, novaQuantidade) {
                const material = materiaisFiltrados.find(m => m.nome === nome);
                if (material && novaQuantidade >= 0) {
                    material.quantidade = novaQuantidade;
                    material.ultimaModificacao = new Date().toLocaleString('pt-BR');
                    await salvarMaterial(material);
                    await carregarMateriais();
                } else if (material && novaQuantidade < 0) {
                    showCustomModal('Aviso', 'A quantidade n√£o pode ser negativa.', 'alert');
                }
            }
            async function confirmarExclusao(nome) {
                const confirmed = await showCustomModal("Confirmar Exclus√£o", `Excluir ${nome}?`, 'confirm');
                if (confirmed) {
                    try { await db.collection('materiais').doc(nome).delete(); await carregarMateriais(); }
                    catch (error) { console.error("Erro ao excluir:", error); showCustomModal("Erro", "Erro ao excluir: " + error.message, 'alert'); }
                }
            }
            async function toggleComprar(nome) {
                const material = materiaisFiltrados.find(m => m.nome === nome);
                if (material) {
                    material.comprar = !material.comprar;
                    await salvarMaterial(material);
                    await carregarMateriais();
                }
            }

            // ---------- NF-e: Parsing, matching e grava√ß√£o ----------
            let nfeItensExtraidos = [];   // [{nome, qtd, preco, lote, validade, cod, ean}]
            let nfeStep = 0;              // √≠ndice do item atual
            let materiaisIndex = [];      // cache p/ matching

            // Elementos NF-e
            const btnImportarNfe = document.getElementById('btnImportarNfe');
            const inputXmlNfe = document.getElementById('inputXmlNfe');

            const nfeMatchModal = document.getElementById('nfeMatchModal');
            const btnFecharNfeMatch = document.getElementById('btnFecharNfeMatch');

            const nfeStepIdx = document.getElementById('nfeStepIdx');
            const nfeStepTotal = document.getElementById('nfeStepTotal');
            const nfeItemNome = document.getElementById('nfeItemNome');
            const nfeItemQtd  = document.getElementById('nfeItemQtd');
            const nfeItemPreco= document.getElementById('nfeItemPreco');
            const nfeItemLote = document.getElementById('nfeItemLote');
            const nfeItemVal  = document.getElementById('nfeItemVal');

            const nfeCandidateSelect = document.getElementById('nfeCandidateSelect');
            const nfeNewName = document.getElementById('nfeNewName');
            const nfeNewCategory = document.getElementById('nfeNewCategory');

            const nfeBtnMesmo = document.getElementById('nfeBtnMesmo');
            const nfeBtnCriar = document.getElementById('nfeBtnCriar');
            const nfeBtnAvancar = document.getElementById('nfeBtnAvancar');
            const nfeBtnPular = document.getElementById('nfeBtnPular');

            // Eventos NF-e
            btnImportarNfe.addEventListener('click', () => inputXmlNfe.click());
            inputXmlNfe.addEventListener('change', onPickXmlFile);
            btnFecharNfeMatch.addEventListener('click', () => nfeMatchModal.classList.add('hidden'));

            nfeBtnPular.addEventListener('click', () => avancarItem());
            nfeBtnAvancar.addEventListener('click', () => avancarItem());

            nfeBtnMesmo.addEventListener('click', async () => {
              const item = nfeItensExtraidos[nfeStep];
              const selectedDocId = nfeCandidateSelect.value;
              if (!selectedDocId) {
                showCustomModal("Aviso", "Selecione um item do estoque ou use 'Criar novo'.", "alert");
                return;
              }
              await registrarEntradaEmMaterialExistente(selectedDocId, item);
              avancarItem(true);
            });

            nfeBtnCriar.addEventListener('click', async () => {
              const item = nfeItensExtraidos[nfeStep];
              const nomeNovo = (nfeNewName.value || "").trim();
              const categoriaNova = nfeNewCategory.value;

              if (!nomeNovo) { showCustomModal("Aviso", "Informe um nome padronizado.", "alert"); return; }
              if (!categoriaNova) { showCustomModal("Aviso", "Selecione a categoria.", "alert"); return; }

              const docRef = db.collection('materiais').doc(nomeNovo);
              const exists = await docRef.get();

              if (!exists.exists) {
                const novoMaterial = {
                  nome: nomeNovo,
                  categoria: categoriaNova,
                  quantidade: 0,
                  quantidadeMinima: 0,
                  imagem: null,
                  ultimaModificacao: new Date().toLocaleString('pt-BR'),
                  comprar: false
                };
                await docRef.set(novoMaterial);
              }
              await registrarEntradaEmMaterialExistente(nomeNovo, item);
              avancarItem(true);
            });

            function avancarItem() {
              nfeStep++;
              if (nfeStep >= nfeItensExtraidos.length) {
                nfeMatchModal.classList.add('hidden');
                carregarMateriais();
                showCustomModal("Sucesso", "Processamento da NF-e conclu√≠do!", "alert");
              } else {
                renderNfeMatchStep();
              }
            }

            async function carregarMateriaisIndex() {
              const snapshot = await db.collection('materiais').get();
              materiaisIndex = [];
              snapshot.forEach(doc => {
                const d = doc.data();
                materiaisIndex.push({
                  id: doc.id,
                  nome: d.nome || doc.id,
                  categoria: d.categoria || '',
                });
              });
            }

            async function onPickXmlFile(evt) {
              const file = evt.target.files && evt.target.files[0];
              if (!file) return;

              try {
                await carregarMateriaisIndex();
                const xmlStr = await file.text();
                nfeItensExtraidos = extrairItensDaNfe(xmlStr);
                if (!nfeItensExtraidos.length) {
                  showCustomModal("Aviso", "N√£o encontrei itens na NF-e.", "alert");
                  return;
                }
                nfeStep = 0;
                abrirModalMatching();
                renderNfeMatchStep();
              } catch (e) {
                console.error(e);
                showCustomModal("Erro", "Falha ao processar a NF-e: " + e.message, "alert");
              } finally {
                inputXmlNfe.value = '';
              }
            }

            function abrirModalMatching() {
              nfeMatchModal.classList.remove('hidden');
              nfeStepTotal.textContent = nfeItensExtraidos.length;
            }

            function renderNfeMatchStep() {
              const item = nfeItensExtraidos[nfeStep];
              nfeStepIdx.textContent = String(nfeStep + 1);

              nfeItemNome.textContent = item.nome || '(sem nome)';
              nfeItemQtd.textContent  = item.qtd ?? '';
              nfeItemPreco.textContent= (item.preco ?? 0).toFixed(2);
              nfeItemLote.textContent = item.lote || '-';
              nfeItemVal.textContent  = item.validade || '-';

              nfeNewName.value = '';
              nfeNewCategory.value = '';

              const candidates = sugerirMateriais(item.nome, materiaisIndex, 10);
              nfeCandidateSelect.innerHTML = '';
              const optEmpty = document.createElement('option');
              optEmpty.value = '';
              optEmpty.textContent = '‚Äî Selecione um item do estoque ‚Äî';
              nfeCandidateSelect.appendChild(optEmpty);

              candidates.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.id;
                opt.textContent = `${c.nome} ${c.score < 1 ? `(simil.: ${(c.score*100).toFixed(0)}%)` : ''}`;
                nfeCandidateSelect.appendChild(opt);
              });
            }

            // Parser NF-e (4.00)
            function extrairItensDaNfe(xmlStr) {
              const parser = new DOMParser();
              const xml = parser.parseFromString(xmlStr, "text/xml");
              const ns = "http://www.portalfiscal.inf.br/nfe";
              const dets = xml.getElementsByTagNameNS(ns, 'det');
              const itens = [];

              function getTextNS(parent, tag) {
                const el = parent.getElementsByTagNameNS(ns, tag)[0];
                return (el && el.textContent || '').trim() || null;
              }

              for (let i = 0; i < dets.length; i++) {
                const det = dets[i];
                const prod = det.getElementsByTagNameNS(ns, 'prod')[0];
                if (!prod) continue;

                const xProd = getTextNS(prod, 'xProd');
                const qCom  = parseFloat((getTextNS(prod, 'qCom') || '0').replace(',', '.')) || 0;
                const vUn   = parseFloat((getTextNS(prod, 'vUnCom') || '0').replace(',', '.')) || 0;
                const vProd = parseFloat((getTextNS(prod, 'vProd') || '0').replace(',', '.')) || 0;
                const cProd = getTextNS(prod, 'cProd');
                let ean   = getTextNS(prod, 'cEAN');
                if (!ean) ean = getTextNS(prod, 'cEANTrib');

                const rastro = prod.getElementsByTagNameNS(ns, 'rastro')[0];
                const nLote = rastro ? getTextNS(rastro, 'nLote') : null;
                const dVal  = rastro ? getTextNS(rastro, 'dVal')  : null;

                itens.push({
                  cod: cProd,
                  ean: ean,
                  nome: xProd,
                  qtd: qCom,
                  preco: (qCom > 0 ? vProd / qCom : vUn) || vUn,
                  lote: nLote,
                  validade: dVal
                });
              }
              return itens;
            }

            function stripAccents(s) {
              return (s || '').normalize('NFD').replace(/[\u0300-\u036f]/g, '');
            }
            function norm(s) {
              return stripAccents(String(s || '').toLowerCase())
                .replace(/[^a-z0-9\s]/g, ' ')
                .replace(/\s+/g, ' ')
                .trim();
            }

            function similarity(a, b) {
              a = norm(a); b = norm(b);
              if (!a || !b) return 0;
              const ta = new Set(a.split(' '));
              const tb = new Set(b.split(' '));
              const inter = [...ta].filter(x => tb.has(x)).length;
              const uni = new Set([...ta, ...tb]).size;
              let score = inter / (uni || 1);
              if (a.includes(b) || b.includes(a)) score += 0.15;
              return Math.min(1, Math.max(0, score));
            }

            function sugerirMateriais(nomeNota, base, topN = 5) {
              const scored = base.map(m => ({...m, score: similarity(nomeNota, m.nome)}));
              scored.sort((x, y) => y.score - x.score);
              return scored.slice(0, topN);
            }

            async function registrarEntradaEmMaterialExistente(docId, item) {
              const ref = db.collection('materiais').doc(docId);
              const snap = await ref.get();
              if (!snap.exists) throw new Error(`Documento "${docId}" n√£o encontrado.`);

              const atual = snap.data() || {};
              const novaQtd = (atual.quantidade || 0) + (item.qtd || 0);

              const entrada = {
                tipo: 'entrada',
                origem: 'nfe',
                data: new Date().toISOString(),
                nfeItemNome: item.nome,
                qtd: item.qtd || 0,
                precoUnit: item.preco || 0,
                lote: item.lote || null,
                validade: item.validade || null,
                ean: item.ean || null,
                codProdNfe: item.cod || null
              };

              await ref.update({
                quantidade: novaQtd,
                ultimaModificacao: new Date().toLocaleString('pt-BR')
              }).catch(async err => {
                if (String(err).includes('No document to update')) {
                  await ref.set({
                    nome: docId,
                    categoria: 'clinica_geral',
                    quantidade: novaQtd,
                    quantidadeMinima: 0,
                    imagem: null,
                    ultimaModificacao: new Date().toLocaleString('pt-BR'),
                    comprar: false
                  });
                } else { throw err; }
              });

              await ref.collection('movimentacoes').add(entrada);

              if (item.lote || item.validade) {
                const lotekey = (item.lote || 's/lote') + '|' + (item.validade || 's/valid');
                await ref.collection('lotes').doc(lotekey).set({
                  lote: item.lote || null,
                  validade: item.validade || null,
                  ean: item.ean || null,
                  ultimaEntradaEm: new Date().toISOString(),
                  quantidade: firebase.firestore.FieldValue.increment(item.qtd || 0),
                }, { merge: true });
              }
            }
            // ---------- Fim NF-e ----------

            // Auth
            document.getElementById('loginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;

                auth.signInWithEmailAndPassword(email, password)
                    .then(() => {
                        document.getElementById('loginContainer').classList.add('hidden');
                        document.getElementById('mainContainer').classList.remove('hidden');
                        carregarMateriais();
                    })
                    .catch(error => {
                        console.error('Erro ao autenticar:', error);
                        showCustomModal("Erro de Autentica√ß√£o", 'Falha ao autenticar: ' + error.message, 'alert');
                    });
            });

            auth.onAuthStateChanged(user => {
                if (user) {
                    document.getElementById('loginContainer').classList.add('hidden');
                    document.getElementById('mainContainer').classList.remove('hidden');
                    carregarMateriais();
                } else {
                    document.getElementById('loginContainer').classList.remove('hidden');
                    document.getElementById('mainContainer').classList.add('hidden');
                }
            });

            // Listeners UI
            document.getElementById('btnAbrirModal').addEventListener('click', abrirModal);
            document.getElementById('btnFecharModal').addEventListener('click', fecharModal);
            document.getElementById('btnFecharModalEditar').addEventListener('click', fecharModalEditar);
            document.getElementById('btnLogout').addEventListener('click', logout);
            document.getElementById('btnLimparMarcacoes').addEventListener('click', limparMarcacoes);

            document.getElementById('btnListaCompras').addEventListener('click', () => { isShowingPurchaseList = true; carregarMateriais(); });
            document.getElementById('btnMostrarTodos').addEventListener('click', () => {
                isShowingPurchaseList = false;
                document.getElementById('searchInput').value = '';
                termoDeBusca = '';
                categoriaSelecionada = 'todos';
                carregarMateriais();
            });

            document.getElementById('btnCopiarLista').addEventListener('click', copiarListaCompras);
            document.getElementById('btnBuscar').addEventListener('click', buscarMateriais);
            document.getElementById('btnGerarRelatorio').addEventListener('click', gerarRelatorio);

            document.getElementById('btnAdvancedOptions').addEventListener('click', function() {
                document.getElementById('advancedOptionsContainer').classList.toggle('hidden');
            });

            document.addEventListener('click', function(event) {
                document.querySelectorAll('.dropdown-content').forEach(dropdown => {
                    if (!dropdown.classList.contains('hidden') && !dropdown.parentElement.contains(event.target)) {
                        dropdown.classList.add('hidden');
                    }
                });
            });
        });
    </script>
</body>
</html>
